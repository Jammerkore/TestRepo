CREATE PROCEDURE [dbo].[SP_DAILYPERCENTAGES_REPORT] 
	@SELECTED_NODE_RID INT,
	@LOWER_LEVEL INT,
	@STORE_ID VARCHAR(255),
	@STORE_RID_LIST TEXT
AS
DECLARE @SELECTED_NODE_LEVEL AS INT

SELECT @SELECTED_NODE_LEVEL = HOME_LEVEL
FROM HIERARCHY_NODE
WHERE HN_RID = @SELECTED_NODE_RID

DECLARE @MAX_PHL_SEQUENCE AS INT

SELECT @MAX_PHL_SEQUENCE = MAX(PHL_SEQUENCE)
FROM PRODUCT_HIERARCHY_LEVELS

IF (@LOWER_LEVEL = 0)
BEGIN
	SELECT @LOWER_LEVEL = @MAX_PHL_SEQUENCE
END

IF (
		(
			@STORE_ID IS NULL
			OR @STORE_ID = ''
			)
		AND (
			@STORE_RID_LIST IS NOT NULL
			AND DATALENGTH(@STORE_RID_LIST) > 0
			)
		)
BEGIN
	EXEC SP_GET_DAILYPERCENTAGES_REPORT_FOR_STORE_SET @SELECTED_NODE_RID,
		@SELECTED_NODE_LEVEL,
		@LOWER_LEVEL,
		@STORE_RID_LIST
END
ELSE IF (
		@STORE_ID IS NOT NULL
		AND @STORE_ID <> ''
		)
BEGIN
	EXEC SP_GET_DAILYPERCENTAGES_REPORT_FOR_STORE @SELECTED_NODE_RID,
		@SELECTED_NODE_LEVEL,
		@LOWER_LEVEL,
		@STORE_ID
END
ELSE
BEGIN
	EXEC SP_GET_DAILYPERCENTAGES_REPORT_NO_STORE @SELECTED_NODE_RID,
		@SELECTED_NODE_LEVEL,
		@LOWER_LEVEL
END
GO


