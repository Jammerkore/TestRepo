CREATE PROCEDURE [dbo].[SP_MID_USER_WORKFLOWS_DELETE] 
	@UserRID INT,
	@COMMIT_LIMIT INT = 9999999,
	@RETURN_ROWCOUNT BIT = 1,
	@debug BIT = 0,
	@RECORDS_DELETED INT output
AS
BEGIN
	IF (@debug = 0)
		SET NOCOUNT ON

	DECLARE @t TABLE (RID INT)
	DECLARE @RID INT

	SET @RECORDS_DELETED = 0

	-- remove all workflows
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	INSERT INTO @t
	SELECT top (@COMMIT_LIMIT) WORKFLOW_RID
	FROM [dbo].[WORKFLOW]
	WHERE WORKFLOW_USER_RID = @UserRID

	SET @RECORDS_DELETED = @@rowcount

	SET TRANSACTION ISOLATION LEVEL READ COMMITTED

	DECLARE @rowsDeleted INT;

	SET @rowsDeleted = (
			SELECT COUNT(*)
			FROM @t
			)

	SELECT TOP 1 @RID = RID
	FROM @t

	WHILE @@rowcount <> 0
	BEGIN
		EXEC [dbo].[SP_MID_WORKFLOW_DELETE] @RID

		DELETE @t
		WHERE RID = @RID

		SELECT TOP 1 @RID = RID
		FROM @t
	END

	IF @RETURN_ROWCOUNT = 1 SELECT @rowsDeleted
END
GO


