CREATE PROCEDURE [dbo].[SP_GET_SIZE_CURVE_CRITERIA_REPORT]
	@SELECTED_NODE_RID  INT,
	@LOWER_LEVEL INT
AS
BEGIN
	 DECLARE @SELECTED_NODE_LEVEL AS INT, @HOME_PH_RID AS INT
	 SELECT @SELECTED_NODE_LEVEL = HOME_LEVEL, @HOME_PH_RID = HOME_PH_RID FROM HIERARCHY_NODE WHERE HN_RID =  @SELECTED_NODE_RID
	 DECLARE @MAX_PHL_SEQUENCE AS INT
	 SELECT @MAX_PHL_SEQUENCE = MAX(PHL_SEQUENCE) FROM PRODUCT_HIERARCHY_LEVELS
 
	 IF( @LOWER_LEVEL=0)
	 BEGIN
		SELECT @LOWER_LEVEL=@MAX_PHL_SEQUENCE
	 END

	 DECLARE @LEVEL AS INT
	 SELECT @LEVEL = (@LOWER_LEVEL -  @SELECTED_NODE_LEVEL)+1
	 SELECT @LEVEL = @LOWER_LEVEL - 1
	 CREATE TABLE #TEMPNODE (PARENT_HN_RID INT, HN_RID INT, BN_ID VARCHAR(356) COLLATE Latin1_General_CS_AS, BN_NAME VARCHAR(50) COLLATE Latin1_General_CS_AS, BN_DESCRIPTION VARCHAR(250) COLLATE Latin1_General_CS_AS)
	 INSERT #TEMPNODE (PARENT_HN_RID, HN_RID, BN_ID, BN_NAME, BN_DESCRIPTION)
	 EXEC SP_GET_ALL_DESCENDANTS_BY_LEVEL_REPORT @SELECTED_NODE_RID, @LEVEL
 
 
	 CREATE TABLE #SIZE_CURVE_CRITERIA_TABLE 
		(
		HN_RID int, 
		BN_ID varchar(356),
		NSCCD_RID int, 
		PH_OFFSET_IND int, 
		PH_RID int,
		PHL_SEQUENCE int,
		PHL_OFFSET int,
		CDR_RID int,
		APPLY_LOST_SALES_IND char(1),
		OLL_RID int,
		CUSTOM_OLL_RID int,
		SIZE_GROUP_RID int,
		CURVE_NAME varchar(50),
		SG_RID int,
		PHL_ID varchar(50),
		IS_DEFAULT char(1),
		DISPLAY_DATE varchar(100),
		SIZE_GROUP_NAME varchar(50),
		STORE_GROUP_ATTRIBUTE varchar(50),
		OVERRIDE_LOW_LEVEL_NODE varchar(250)
		)

	 INSERT INTO #SIZE_CURVE_CRITERIA_TABLE
	 SELECT  
		hn.HN_RID,
		-- Begin TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
		--[dbo].[UDF_MID_GET_NODE_DISPLAY_LEVEL](hn.HN_RID) AS [BN_ID],
		[dbo].[UDF_MID_GET_NODE_DISPLAY](hn.HN_RID) AS [BN_ID],
		-- End TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
		NSCCD_RID, 
		PH_OFFSET_IND, 
		PH_RID,
		PHL_SEQUENCE,
		PHL_OFFSET ,
		CDR_RID,
		APPLY_LOST_SALES_IND,
		OLL_RID,
		CUSTOM_OLL_RID,
		SIZE_GROUP_RID,
		CURVE_NAME,
		SG_RID,
		PHL_ID,
		IS_DEFAULT,
		DISPLAY_DATE,
		SIZE_GROUP_NAME,
		STORE_GROUP_ATTRIBUTE,
		OVERRIDE_LOW_LEVEL_NODE
	FROM 
	(
	SELECT  
		NSCC.HN_RID,
		NSCC.NSCCD_RID, 
		NSCCD.PH_OFFSET_IND, 
		COALESCE(NSCCD.PH_RID, -1) PH_RID, 
		COALESCE(NSCCD.PHL_SEQUENCE, 0) PHL_SEQUENCE,
		COALESCE(NSCCD.PHL_OFFSET, -1) PHL_OFFSET, 
		COALESCE(NSCCD.CDR_RID, -1) CDR_RID, 
		NSCCD.APPLY_LOST_SALES_IND, 
		COALESCE(NSCCD.OLL_RID, -1) OLL_RID,
		COALESCE(NSCCD.CUSTOM_OLL_RID, -1) CUSTOM_OLL_RID, 
		COALESCE(NSCCD.SIZE_GROUP_RID, -1) SIZE_GROUP_RID,
		COALESCE(NSCCD.CURVE_NAME, '') CURVE_NAME,
		COALESCE(NSCCD.SG_RID, -1) SG_RID,
		PHL.PHL_ID, 'N' AS IS_DEFAULT,
		'' AS DISPLAY_DATE,
		COALESCE(SG.SIZE_GROUP_NAME, '') SIZE_GROUP_NAME,
		(SELECT SG_ID FROM STORE_GROUP WHERE STORE_GROUP.SG_RID=NSCCD.SG_RID) AS STORE_GROUP_ATTRIBUTE,
		COALESCE((SELECT NAME FROM OVERRIDE_LL_MODEL_HEADER OLL WHERE OLL.OLL_RID=NSCCD.OLL_RID), (SELECT NAME FROM OVERRIDE_LL_MODEL_HEADER OLL WHERE OLL.OLL_RID=NSCCD.CUSTOM_OLL_RID)) AS [OVERRIDE_LOW_LEVEL_NODE]
		FROM NODE_SIZE_CURVE_CRITERIA NSCC
		INNER JOIN NODE_SIZE_CURVE_CRITERIA_DETAIL NSCCD
		LEFT OUTER JOIN PRODUCT_HIERARCHY_LEVELS PHL ON PHL.PH_RID=NSCCD.PH_RID AND PHL.PHL_SEQUENCE=NSCCD.PHL_SEQUENCE  
		LEFT OUTER JOIN SIZE_GROUP SG ON SG.SIZE_GROUP_RID= NSCCD.SIZE_GROUP_RID 
		ON NSCC.NSCCD_RID = NSCCD.NSCCD_RID

	UNION
		SELECT 
		NSCC.HN_RID,
		NSCC.NSCCD_RID, 
		NSCCD.PH_OFFSET_IND, 
		COALESCE(NSCCD.PH_RID, -1) PH_RID, 
		COALESCE(NSCCD.PHL_SEQUENCE, 0) PHL_SEQUENCE,
		COALESCE(NSCCD.PHL_OFFSET, -1) PHL_OFFSET, 
		COALESCE(NSCCD.CDR_RID, -1) CDR_RID, 
		NSCCD.APPLY_LOST_SALES_IND, 
		COALESCE(NSCCD.OLL_RID, -1) OLL_RID,
		COALESCE(NSCCD.CUSTOM_OLL_RID, -1) CUSTOM_OLL_RID, 
		COALESCE(NSCCD.SIZE_GROUP_RID, -1) SIZE_GROUP_RID, 
		COALESCE(NSCCD.CURVE_NAME, '') CURVE_NAME,
		COALESCE(NSCCD.SG_RID, -1) SG_RID,
		PHL.PHL_ID, 'Y' AS IS_DEFAULT,
		'' AS DISPLAY_DATE,
		COALESCE(SG.SIZE_GROUP_NAME, '') SIZE_GROUP_NAME,
		(SELECT SG_ID FROM STORE_GROUP WHERE STORE_GROUP.SG_RID=NSCCD.SG_RID) AS STORE_GROUP_ATTRIBUTE,
		COALESCE((SELECT NAME FROM OVERRIDE_LL_MODEL_HEADER OLL WHERE OLL.OLL_RID=NSCCD.OLL_RID), (SELECT NAME FROM OVERRIDE_LL_MODEL_HEADER OLL WHERE OLL.OLL_RID=NSCCD.CUSTOM_OLL_RID)) AS [OVERRIDE_LOW_LEVEL_NODE]
		FROM NODE_SIZE_CURVE_CRITERIA_DEFAULT NSCC
		INNER JOIN NODE_SIZE_CURVE_CRITERIA_DETAIL NSCCD
		LEFT OUTER JOIN PRODUCT_HIERARCHY_LEVELS PHL ON PHL.PH_RID=NSCCD.PH_RID AND PHL.PHL_SEQUENCE=NSCCD.PHL_SEQUENCE  
		LEFT OUTER JOIN SIZE_GROUP SG ON SG.SIZE_GROUP_RID= NSCCD.SIZE_GROUP_RID
		ON NSCC.NSCCD_RID = NSCCD.NSCCD_RID

	) AS T

	INNER JOIN
	(
	SELECT PARENT_HN_RID, HN_RID, BN_ID, BN_NAME, BN_DESCRIPTION
	FROM #TEMPNODE
	) hn ON hn.HN_RID = T.HN_RID

	 SELECT *  FROM #SIZE_CURVE_CRITERIA_TABLE ORDER BY BN_ID

	 IF (SELECT object_id('tempdb.dbo.#TEMPNODE')) > 0 DROP TABLE #TEMPNODE
	 DROP TABLE  #SIZE_CURVE_CRITERIA_TABLE
 
END
GO
