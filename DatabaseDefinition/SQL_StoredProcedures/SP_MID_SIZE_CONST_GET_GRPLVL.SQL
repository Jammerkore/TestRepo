--dv =============================================
--dv Create date:	7/09/2004 - JEFF SCHNIERLE  
--dv Description:	GETS DATA OUT OF SIZE_MTH_CONST_GRPLVL
--dv Usage:			EXEC SP_MID_MTH_CONST_GET_GRPLVL 305, 111 
--dv History:		2/18/2005 - Steve Todd - converting to Size Constraints Model
--dv				5/13/2015 -TT#1517-MD -jsobek -Store Service Optimization
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_SIZE_CONST_GET_GRPLVL] 
	(
	@SIZECONSTRAINTRID INT,
	@SGRID INT,
	@SG_VERSION INT   -- TT#1901-MD - JSmith - Versioning Test - make a str inactive and process Fill Size Holes - Receive a system argument exception
	)
AS
BEGIN
	SET NOCOUNT ON
	SET ANSI_PADDING ON


	DECLARE @ALLSTORE_ROW INT,
		@SET_ROW INT,
		@ALLSTORE_SGL_RID INT,
		@DEFAULT_ROW_SGL_RID INT,
		@DEFAULT_ROW INT

	SELECT @ALLSTORE_ROW = 0,
		@SET_ROW = 1,
		@DEFAULT_ROW = 8,
		@ALLSTORE_SGL_RID = - 1,
		@DEFAULT_ROW_SGL_RID = - 1

	CREATE TABLE #ALL_SZ (
		BAND_DSC VARCHAR(50) NOT NULL,
		SIZE_CONSTRAINT_RID INT NOT NULL,
		SGL_RID INT NOT NULL,
		SIZE_MIN INT NULL,
		SIZE_MAX INT NULL,
		SIZE_MULT INT NULL,
		ROW_TYPE_ID INT NOT NULL
		)

	CREATE INDEX #ALL_SZ_IDX_1 ON #ALL_SZ (ROW_TYPE_ID)

	CREATE INDEX #ALL_SZ_IDX_2 ON #ALL_SZ (SGL_RID)

	/*BEGIN BY GETTING THE ALL SIZE ROW*/
	/*	INSERT INTO #ALL_SZ SELECT  'All Stores', MGL.SIZE_CONSTRAINT_RID, MGL.SGL_RID, 
				    MGL.SIZE_MIN, MGL.SIZE_MAX,
		                    MGL.SIZE_MULT, MGL.ROW_TYPE_ID
			     FROM   SIZE_CONSTRAINT_GRPLVL MGL
			     WHERE  SIZE_CONSTRAINT_RID = @SIZECONSTRAINTRID
			     AND    MGL.ROW_TYPE_ID = @ALLSTORE_ROW

*/
	/*ADD A ALL SIZE ROW IF NO ALL SIZE ROWS ARE IN THE TABLE*/
	/* if not exists (select * from #ALL_SZ WHERE ROW_TYPE_ID = @ALLSTORE_ROW)
		BEGIN
			INSERT INTO #ALL_SZ VALUES ('All Stores', --BAND_DSC
							@SIZECONSTRAINTRID, --SIZE_CONSTRAINT_RID
							@ALLSTORE_SGL_RID, --SGL_RID
							null,	--SIZE_MIN
							null,	--SIZE_MAX
							null,	--SIZE_MULT
							@ALLSTORE_ROW)	--ROW INDICATOR
		END

	*/
	/*NEXT GET THE DEFAULT ROW*/
	INSERT INTO #ALL_SZ
	SELECT 'Default',
		MGL.SIZE_CONSTRAINT_RID,
		MGL.SGL_RID,
		MGL.SIZE_MIN,
		MGL.SIZE_MAX,
		MGL.SIZE_MULT,
		MGL.ROW_TYPE_ID
	FROM SIZE_CONSTRAINT_GRPLVL MGL
	WHERE SIZE_CONSTRAINT_RID = @SIZECONSTRAINTRID
		AND MGL.ROW_TYPE_ID = @DEFAULT_ROW

	/*ADD DEFAULT ROW IF NO DEFAULT ROWS ARE IN THE TABLE*/
	IF NOT EXISTS (
			SELECT *
			FROM #ALL_SZ
			WHERE SGL_RID = @DEFAULT_ROW_SGL_RID
			)
	BEGIN
		INSERT INTO #ALL_SZ
		VALUES (
			'Default',
			@SIZECONSTRAINTRID, --SIZE_CONSTRAINT_RID
			@DEFAULT_ROW_SGL_RID, --SGL_RID
			NULL, --SIZE_MIN
			NULL, --SIZE_MAX
			NULL, --SIZE_MULT
			@DEFAULT_ROW
			) --ROW INDICATOR
	END

	/*FINALLY GO GET THE STORE SET ATTRIBUTES*/
	INSERT INTO #ALL_SZ
	SELECT SGL.SGL_OVERRIDE_ID,
		MGL.SIZE_CONSTRAINT_RID,
		MGL.SGL_RID,
		MGL.SIZE_MIN,
		MGL.SIZE_MAX,
		MGL.SIZE_MULT,
		MGL.ROW_TYPE_ID
	FROM SIZE_CONSTRAINT_GRPLVL MGL,
		STORE_GROUP_JOIN SGL
	WHERE SIZE_CONSTRAINT_RID = @SIZECONSTRAINTRID
		AND MGL.SGL_RID = SGL.SGL_RID
		AND MGL.ROW_TYPE_ID = @SET_ROW
		AND SGL.SG_VERSION = @SG_VERSION  -- TT#1901-MD - JSmith - Versioning Test - make a str inactive and process Fill Size Holes - Receive a system argument exception
	ORDER BY SGL.SGL_OVERRIDE_SEQUENCE

	/*INSERT ROWS FOUND IN STORE_GROUP_LEVEL THAT ARE NOT IN THE METHOD TABLES*/
	INSERT INTO #ALL_SZ
	SELECT SGL.SGL_OVERRIDE_ID, --SGL_ID
		@SIZECONSTRAINTRID, --SIZE_CONSTRAINT_RID
		SGL.SGL_RID, --SGL_RID					
		NULL, --SIZE_MIN
		NULL, --SIZE_MAX
		NULL, --SIZE_MULT					
		@SET_ROW --ROW INDICATOR
	FROM STORE_GROUP_JOIN SGL
	WHERE SG_RID = @SGRID
	    AND SGL.SG_VERSION = @SG_VERSION  -- TT#1901-MD - JSmith - Versioning Test - make a str inactive and process Fill Size Holes - Receive a system argument exception
		AND SGL.SGL_RID NOT IN (
			SELECT SGL_RID
			FROM #ALL_SZ
			WHERE ROW_TYPE_ID = @SET_ROW
			)
	ORDER BY SGL.SGL_OVERRIDE_SEQUENCE

	-- Begin TT#2185 - JSmith - Store in Global Attribute not showing in Models store set
	--SELECT * FROM #ALL_SZ
	SELECT allsz.*
	FROM #ALL_SZ allsz
	LEFT OUTER JOIN STORE_GROUP_JOIN SGL WITH (NOLOCK) ON SGL.SGL_RID = allsz.SGL_RID
	AND SGL.SG_VERSION = @SG_VERSION  -- TT#1901-MD - JSmith - Versioning Test - make a str inactive and process Fill Size Holes - Receive a system argument exception
	ORDER BY SGL.SGL_OVERRIDE_SEQUENCE

	-- End TT#2185
	SET NOCOUNT OFF
	SET ANSI_PADDING OFF
END
GO


