CREATE PROCEDURE [dbo].[SP_MID_XML_ASSRT_MATRIX_WRITE] 
	@xmlDoc NTEXT
AS
SET NOCOUNT ON

DECLARE @idoc INT,
	@Tables INT

EXEC sp_xml_preparedocument @idoc OUTPUT,
	@xmlDoc

-- Process variables
-- GET ALL THE ROWS THAT EXISTS AND NEED TO BE UPDATED
SELECT 0 AS PRESENTFLAG,
	xmlHDR_RID,
	xmlHDR_PACK_RID,
	xmlCOLOR_CODE_RID,
	xmlSGL_RID,
	xmlGRADE,
	xmlUNITS,
	xmlLOCKED,
	xmlAVERAGE_UNITS
INTO #TEMP
FROM OPENXML(@idoc, '/root/node', 2) WITH (
		xmlHDR_RID INT '@HDR_RID',
		xmlHDR_PACK_RID INT '@HDR_PACK_RID',
		xmlCOLOR_CODE_RID INT '@COLOR_CODE_RID',
		xmlSGL_RID INT '@SGL_RID',
		xmlGRADE INT '@GRADE',
		xmlUNITS INT '@UNITS',
		xmlLOCKED INT '@LOCKED',
		xmlAVERAGE_UNITS FLOAT '@AVERAGE_UNITS'
		)

IF @@ROWCOUNT = 0
	RETURN

SET NOCOUNT ON

UPDATE ASSORTMENT_MATRIX_DETAIL
WITH (ROWLOCK)

SET UNITS = Coalesce(xmlUNITS, UNITS),
	LOCKED = Coalesce(xmlLOCKED, LOCKED),
	AVERAGE_UNITS = Coalesce(xmlAVERAGE_UNITS, AVERAGE_UNITS)
FROM ASSORTMENT_MATRIX_DETAIL had
JOIN #TEMP ON had.HDR_RID = xmlHDR_RID
	AND (
		had.HDR_PACK_RID = xmlHDR_PACK_RID
		OR (
			had.HDR_PACK_RID IS NULL
			AND xmlHDR_PACK_RID IS NULL
			)
		)
	AND (
		had.COLOR_CODE_RID = xmlCOLOR_CODE_RID
		OR (
			had.COLOR_CODE_RID IS NULL
			AND xmlCOLOR_CODE_RID IS NULL
			)
		)
	AND had.SGL_RID = xmlSGL_RID
	AND had.GRADE = xmlGRADE

UPDATE #TEMP
SET PRESENTFLAG = 1
FROM #TEMP
JOIN ASSORTMENT_MATRIX_DETAIL had ON had.HDR_RID = xmlHDR_RID
	AND (
		had.HDR_PACK_RID = xmlHDR_PACK_RID
		OR (
			had.HDR_PACK_RID IS NULL
			AND xmlHDR_PACK_RID IS NULL
			)
		)
	AND (
		had.COLOR_CODE_RID = xmlCOLOR_CODE_RID
		OR (
			had.COLOR_CODE_RID IS NULL
			AND xmlCOLOR_CODE_RID IS NULL
			)
		)
	AND had.SGL_RID = xmlSGL_RID
	AND had.GRADE = xmlGRADE

INSERT ASSORTMENT_MATRIX_DETAIL (
	HDR_RID,
	HDR_PACK_RID,
	COLOR_CODE_RID,
	SGL_RID,
	GRADE,
	UNITS,
	LOCKED,
	AVERAGE_UNITS
	)
SELECT xmlHDR_RID,
	xmlHDR_PACK_RID,
	xmlCOLOR_CODE_RID,
	xmlSGL_RID,
	xmlGRADE,
	Coalesce(xmlUNITS, 0),
	Coalesce(xmlLOCKED, '0'),
	Coalesce(xmlAVERAGE_UNITS, 0)
FROM #TEMP
WHERE PRESENTFLAG = 0

SELECT @@ROWCOUNT
GO


