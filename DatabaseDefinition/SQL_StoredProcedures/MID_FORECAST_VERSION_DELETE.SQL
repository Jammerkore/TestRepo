--dv =============================================
--dv Create date:	11/26/2013
--dv Description:	Deletes a forecast version
--dv History:		TT#3509-VStuart-Cannot delete OTS Plan Version-ANFUser
--dv =============================================
CREATE PROCEDURE [dbo].[MID_FORECAST_VERSION_DELETE] 
	@FV_RID int
AS
BEGIN
	SET NOCOUNT ON;

	-- security
	DELETE SECURITY_GROUP_VERSION
	WITH (ROWLOCK)
	WHERE FV_RID = @FV_RID

	DELETE SECURITY_USER_VERSION
	WITH (ROWLOCK)
	WHERE FV_RID = @FV_RID

	-- other
	UPDATE USER_ALLOCATION_BASIS
	WITH (ROWLOCK)
	SET BASIS_FV_RID = NULL
	WHERE BASIS_FV_RID = @FV_RID

	DELETE USER_ASSORTMENT_BASIS
	WITH (ROWLOCK)
	WHERE FV_RID = @FV_RID

	DELETE USER_PLAN_BASIS_DETAILS
	WITH (ROWLOCK)
	WHERE FV_RID = @FV_RID

	UPDATE USER_PLAN
	WITH (ROWLOCK)
	SET CHAIN_FV_RID = NULL
	WHERE CHAIN_FV_RID = @FV_RID

	UPDATE USER_PLAN
	WITH (ROWLOCK)
	SET STORE_FV_RID = NULL
	WHERE STORE_FV_RID = @FV_RID

	UPDATE USER_PLAN
	WITH (ROWLOCK)
	SET LOW_LEVEL_FV_RID = NULL
	WHERE LOW_LEVEL_FV_RID = @FV_RID

	-- delete references
	DELETE OVERRIDE_LL_MODEL_DETAIL
	WITH (ROWLOCK)
	WHERE VERSION_RID = @FV_RID

	-- delete Forecast_Version
	DELETE FORECAST_VERSION
	WITH (ROWLOCK)
	WHERE FV_RID = @FV_RID

	SELECT @@ROWCOUNT;

END
GO