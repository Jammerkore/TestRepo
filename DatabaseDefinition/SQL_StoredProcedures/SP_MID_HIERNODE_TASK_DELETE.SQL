--dv =============================================
--dv Modified date: 2/18/2014
--dv Flags: REFERENCED_FROM_SQL_ONLY
--dv Description:	Deletes tasks based on the node provided
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_HIERNODE_TASK_DELETE] 
	@HN_RID INT
AS
BEGIN
	DECLARE @tasklisttable TABLE (
		TASKLIST_RID INT,
		TASK_SEQUENCE INT,
		PROCESS_SEQUENCE INT
		)
	DECLARE @TASKLIST_RID INT,
		@TASK_SEQUENCE INT,
		@PROCESS_SEQUENCE INT
	DECLARE @PrnLine NVARCHAR(4000)

	-- delete allocate tasks
	DELETE
	FROM @tasklisttable

	INSERT INTO @tasklisttable
	SELECT TASKLIST_RID,
		TASK_SEQUENCE,
		ALLOCATE_SEQUENCE
	FROM TASK_ALLOCATE WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	SELECT TOP 1 @TASKLIST_RID = TASKLIST_RID,
		@TASK_SEQUENCE = TASK_SEQUENCE,
		@PROCESS_SEQUENCE = PROCESS_SEQUENCE
	FROM @tasklisttable

	WHILE @@rowcount <> 0
	BEGIN
		DELETE TASK_ALLOCATE_DETAIL
		WITH (ROWLOCK)
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND ALLOCATE_SEQUENCE = @PROCESS_SEQUENCE

		DELETE TASK_ALLOCATE
		WITH (ROWLOCK)
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND ALLOCATE_SEQUENCE = @PROCESS_SEQUENCE

		DELETE @tasklisttable
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND PROCESS_SEQUENCE = @PROCESS_SEQUENCE

		SELECT TOP 1 @TASKLIST_RID = TASKLIST_RID,
			@TASK_SEQUENCE = TASK_SEQUENCE,
			@PROCESS_SEQUENCE = PROCESS_SEQUENCE
		FROM @tasklisttable
	END

	-- delete forecast tasks
	DELETE
	FROM @tasklisttable

	INSERT INTO @tasklisttable
	SELECT TASKLIST_RID,
		TASK_SEQUENCE,
		FORECAST_SEQUENCE
	FROM TASK_FORECAST WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	SELECT TOP 1 @TASKLIST_RID = TASKLIST_RID,
		@TASK_SEQUENCE = TASK_SEQUENCE,
		@PROCESS_SEQUENCE = PROCESS_SEQUENCE
	FROM @tasklisttable

	WHILE @@rowcount <> 0
	BEGIN
		DELETE TASK_FORECAST_DETAIL
		WITH (ROWLOCK)
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND FORECAST_SEQUENCE = @PROCESS_SEQUENCE

		DELETE TASK_FORECAST
		WITH (ROWLOCK)
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND FORECAST_SEQUENCE = @PROCESS_SEQUENCE

		DELETE @tasklisttable
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND @PROCESS_SEQUENCE = PROCESS_SEQUENCE

		SELECT TOP 1 @TASKLIST_RID = TASKLIST_RID,
			@TASK_SEQUENCE = TASK_SEQUENCE,
			@PROCESS_SEQUENCE = PROCESS_SEQUENCE
		FROM @tasklisttable
	END

	-- delete forecast balance tasks
	DELETE
	FROM @tasklisttable

	INSERT INTO @tasklisttable
	SELECT TASKLIST_RID,
		TASK_SEQUENCE,
		FORECAST_BALANCE_SEQUENCE
	FROM TASK_FORECAST_BALANCE WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	SELECT TOP 1 @TASKLIST_RID = TASKLIST_RID,
		@TASK_SEQUENCE = TASK_SEQUENCE,
		@PROCESS_SEQUENCE = PROCESS_SEQUENCE
	FROM @tasklisttable

	WHILE @@rowcount <> 0
	BEGIN
		DELETE TASK_FORECAST_BALANCE
		WITH (ROWLOCK)
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND FORECAST_BALANCE_SEQUENCE = @PROCESS_SEQUENCE

		DELETE @tasklisttable
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND @PROCESS_SEQUENCE = PROCESS_SEQUENCE

		SELECT TOP 1 @TASKLIST_RID = TASKLIST_RID,
			@TASK_SEQUENCE = TASK_SEQUENCE,
			@PROCESS_SEQUENCE = PROCESS_SEQUENCE
		FROM @tasklisttable
	END

	-- delete rollup tasks
	DELETE
	FROM @tasklisttable

	INSERT INTO @tasklisttable
	SELECT TASKLIST_RID,
		TASK_SEQUENCE,
		ROLLUP_SEQUENCE
	FROM TASK_ROLLUP WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	SELECT TOP 1 @TASKLIST_RID = TASKLIST_RID,
		@TASK_SEQUENCE = TASK_SEQUENCE,
		@PROCESS_SEQUENCE = PROCESS_SEQUENCE
	FROM @tasklisttable

	WHILE @@rowcount <> 0
	BEGIN
		DELETE TASK_ROLLUP
		WITH (ROWLOCK)
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND ROLLUP_SEQUENCE = @PROCESS_SEQUENCE

		DELETE @tasklisttable
		WHERE TASKLIST_RID = @TASKLIST_RID
			AND TASK_SEQUENCE = @TASK_SEQUENCE
			AND @PROCESS_SEQUENCE = PROCESS_SEQUENCE

		SELECT TOP 1 @TASKLIST_RID = TASKLIST_RID,
			@TASK_SEQUENCE = TASK_SEQUENCE,
			@PROCESS_SEQUENCE = PROCESS_SEQUENCE
		FROM @tasklisttable
	END
END
GO


