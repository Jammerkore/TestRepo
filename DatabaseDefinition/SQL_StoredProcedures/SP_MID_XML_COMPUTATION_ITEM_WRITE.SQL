CREATE PROCEDURE [dbo].[SP_MID_XML_COMPUTATION_ITEM_WRITE] 
	@xmlDoc NTEXT
AS
SET NOCOUNT ON

DECLARE @idoc INT

EXEC sp_xml_preparedocument @idoc OUTPUT,
	@xmlDoc

-- Process items
SELECT xmlPROCESS,
	xmlCG_RID,
	xmlHN_RID,
	xmlITEM_TYPE,
	xmlFV_RID,
	xmlFISCAL_YEAR_WEEK
INTO #TEMP
FROM OPENXML(@idoc, '/root/node', 2) WITH (
		xmlPROCESS INT '@PROCESS',
		xmlCG_RID INT '@CG_RID',
		xmlHN_RID INT '@HN_RID',
		xmlITEM_TYPE INT '@ITEM_TYPE',
		xmlFV_RID INT '@FV_RID',
		xmlFISCAL_YEAR_WEEK INT '@FISCAL_YEAR_WEEK'
		) xmlvariables

IF @@ROWCOUNT = 0
	RETURN

SET NOCOUNT ON

-- delete duplicate records
DELETE #TEMP
FROM #TEMP
INNER JOIN COMPUTATION_ITEM ON COMPUTATION_ITEM.PROCESS = xmlPROCESS
	AND COMPUTATION_ITEM.CG_RID = xmlCG_RID
	AND COMPUTATION_ITEM.ITEM_TYPE = xmlITEM_TYPE
	AND COMPUTATION_ITEM.HN_RID = xmlHN_RID
	AND COMPUTATION_ITEM.FV_RID = xmlFV_RID
	AND COMPUTATION_ITEM.FISCAL_YEAR_WEEK = xmlFISCAL_YEAR_WEEK

INSERT COMPUTATION_ITEM (
	PROCESS,
	CG_RID,
	HN_RID,
	ITEM_TYPE,
	FV_RID,
	FISCAL_YEAR_WEEK
	)
SELECT xmlPROCESS,
	xmlCG_RID,
	xmlHN_RID,
	xmlITEM_TYPE,
	xmlFV_RID,
	xmlFISCAL_YEAR_WEEK
FROM #TEMP
GO


