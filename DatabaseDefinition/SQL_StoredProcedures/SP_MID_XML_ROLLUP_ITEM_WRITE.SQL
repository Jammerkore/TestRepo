CREATE PROCEDURE [dbo].[SP_MID_XML_ROLLUP_ITEM_WRITE] 
	@xmlDoc NTEXT
AS
SET NOCOUNT ON

DECLARE @idoc INT

EXEC sp_xml_preparedocument @idoc OUTPUT,
	@xmlDoc

-- Process items
SELECT xmlPROCESS,
	xmlHN_RID,
	xmlTIME_ID,
	xmlITEM_TYPE,
	xmlFV_RID,
	xmlPH_RID,
	xmlHOME_LEVEL,
	xmlFIRST_DAY,
	xmlLAST_DAY,
	xmlFIRST_DAY_NEXT_WEEK,
	xmlALTERNATES_ONLY
INTO #TEMP
FROM OPENXML(@idoc, '/root/node', 2) WITH (
		xmlPROCESS INT '@PROCESS',
		xmlHN_RID INT '@HN_RID',
		xmlTIME_ID INT '@TIME_ID',
		xmlITEM_TYPE INT '@ITEM_TYPE',
		xmlFV_RID INT '@FV_RID',
		xmlPH_RID INT '@PH_RID',
		xmlHOME_LEVEL INT '@HOME_LEVEL',
		xmlFIRST_DAY INT '@FIRST_DAY',
		xmlLAST_DAY INT '@LAST_DAY',
		xmlFIRST_DAY_NEXT_WEEK INT '@FIRST_DAY_NEXT_WEEK',
		xmlALTERNATES_ONLY CHAR '@ALTERNATES_ONLY'
		) xmlvariables

IF @@ROWCOUNT = 0
	RETURN

SET NOCOUNT ON

-- delete duplicate records
DELETE #TEMP
FROM #TEMP
INNER JOIN ROLLUP_ITEM ON ROLLUP_ITEM.PROCESS = xmlPROCESS
	AND ROLLUP_ITEM.HN_RID = xmlHN_RID
	AND ROLLUP_ITEM.TIME_ID = xmlTIME_ID
	AND ROLLUP_ITEM.ITEM_TYPE = xmlITEM_TYPE
	AND ROLLUP_ITEM.FV_RID = xmlFV_RID
	AND ROLLUP_ITEM.ALTERNATES_ONLY = xmlALTERNATES_ONLY

INSERT ROLLUP_ITEM (
	PROCESS,
	HN_RID,
	TIME_ID,
	ITEM_TYPE,
	FV_RID,
	PH_RID,
	HOME_LEVEL,
	FIRST_DAY_OF_WEEK,
	LAST_DAY_OF_WEEK,
	FIRST_DAY_OF_NEXT_WEEK,
	ALTERNATES_ONLY
	)
SELECT xmlPROCESS,
	xmlHN_RID,
	xmlTIME_ID,
	xmlITEM_TYPE,
	xmlFV_RID,
	xmlPH_RID,
	xmlHOME_LEVEL,
	xmlFIRST_DAY,
	xmlLAST_DAY,
	xmlFIRST_DAY_NEXT_WEEK,
	xmlALTERNATES_ONLY
FROM #TEMP

-- set hierarchy and level
UPDATE ROLLUP_ITEM
SET PH_RID = HN.HOME_PH_RID,
	HOME_LEVEL = HN.HOME_LEVEL
FROM ROLLUP_ITEM RI
JOIN HIERARCHY_NODE HN ON RI.HN_RID = HN.HN_RID
GO


