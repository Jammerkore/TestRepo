--dv =============================================
--dv Create date:	11/25/2013
--dv Description:	Reads child folders based on folder types for users where the folder is assigned and owned
--dv =============================================
CREATE PROCEDURE [dbo].[MID_FOLDER_READ_CHILDREN_FOR_ASSIGNED_AND_OWNED]
	@FOLDER_TYPE_LIST FOLDER_TYPE READONLY,
	@CHILD_ITEM_TYPE int,
	@USER_RID_LIST USER_RID_TYPE READONLY
AS
BEGIN
	SET NOCOUNT ON;

	SELECT DISTINCT 
		fjt.PARENT_FOLDER_RID, 
		fjt.CHILD_ITEM_RID, 
		fjt.CHILD_ITEM_TYPE,
		ui.USER_RID, 
		ui.OWNER_USER_RID
	FROM FOLDER_JOIN fjt 
	INNER JOIN USER_ITEM ui ON ui.ITEM_RID = fjt.PARENT_FOLDER_RID OR ui.ITEM_RID = fjt.CHILD_ITEM_RID, 
	FOLDER ft
	WHERE 
		ITEM_TYPE IN (SELECT FOLDER_TYPE AS ITEM_TYPE FROM @FOLDER_TYPE_LIST)
		AND FOLDER_TYPE IN (SELECT FOLDER_TYPE FROM @FOLDER_TYPE_LIST)
		AND (fjt.CHILD_ITEM_TYPE = ft.FOLDER_TYPE OR fjt.CHILD_ITEM_TYPE = @CHILD_ITEM_TYPE)
		AND (ft.FOLDER_RID = fjt.PARENT_FOLDER_RID OR ft.FOLDER_RID = fjt.CHILD_ITEM_RID) 
		AND ui.USER_RID IN (SELECT USER_RID FROM @USER_RID_LIST)
	ORDER BY PARENT_FOLDER_RID

END
GO


