--dv =============================================
--dv Modified date: 2/18/2014
--dv Flags: REFERENCED_FROM_SQL_ONLY
--dv Description:	Reads data from the audit header table
--dv =============================================
CREATE PROCEDURE [dbo].[SP_GET_HEADER_AUDIT_REPORT_FOR_LIST_AND_USER] 
	@SELECTED_NODE_RID AS INT,
	@PLAN_HNRID AS INT,
	@USER_RID AS INT,
	@USER_GROUP_RID INT,
	@PROCESS_FROM_DATE VARCHAR(50),
	@PROCESS_TO_DATE VARCHAR(50),
	@HEADER_RID_LIST TEXT
AS
BEGIN
	CREATE TABLE #HDR_tbl (hdrRID INT)

	INSERT #HDR_tbl
	SELECT *
	FROM dbo.UDF_MID_SPLIT_CSV_INT(@HEADER_RID_LIST, ',')

	SELECT 'Header',
		1 AS [RowNo],
		'Released Headers' AS [Group],
		COUNT(vgh.HDR_RID) AS '#',
		SUM(ahn.Need) AS [Need],
		COUNT(hor.HORIZON_OVERRIDE) AS [Horizion_Override],
		SUM(ahr.[Rule]) AS [Rule],
		SUM(ahv.Velocity) AS [Velocity],
		SUM(aho.Override) AS [Override],
		SUM(ahg.General) AS [General],
		SUM(ahb.Balance_Style) AS [Balance_Style],
		COUNT(hmssty.HDR_RID) AS [Style_Manual],
		SUM(ahs.Size_Need) AS [Size_Need],
		SUM(ahf.Fill_Size_Holes) AS [Fill_Size_Holes],
		SUM(ahfs.Fill_And_Need_Size) AS [Fill_And_Need_Size],
		SUM(ahbs.Basis_Size) AS [Basis_Size],
		SUM(ahsp.Size_Prop) AS [Size_Prop],
		SUM(ahbsz.Balance_size) AS [Balance_size],
		COUNT(hmsz.HDR_RID) AS [Size_Manual],
		COUNT(hr.HDR_RID) AS [Reserve]
	FROM VW_GET_HEADERS vgh
	INNER JOIN AUDIT_HEADER ah ON ah.HDR_RID = vgh.HDR_RID
		AND ah.ACTION_TYPE = 802118
		AND ah.LAST_ENTRY = 1
	INNER JOIN (
		SELECT USER_RID
		FROM APPLICATION_USER
		WHERE USER_RID = @USER_RID
			AND @USER_RID <> 0
		
		UNION
		
		SELECT USER_RID
		FROM USER_GROUP_JOIN
		WHERE GROUP_RID = @USER_GROUP_RID
			AND @USER_GROUP_RID <> 0
			AND @USER_RID = 0
		) ug ON ah.USER_RID = ug.USER_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Need]
		FROM AUDIT_HEADER ahn
		WHERE ahn.ACTION_TYPE = 802111
			AND ahn.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahn ON ahn.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN HEADER hor ON hor.HDR_RID = vgh.HDR_RID
		AND hor.HORIZON_OVERRIDE = 1
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Rule]
		FROM AUDIT_HEADER ahr
		WHERE ahr.METHOD_TYPE = 802105
			AND ahr.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahr ON ahr.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Velocity]
		FROM AUDIT_HEADER ahv
		WHERE ahv.METHOD_TYPE = 802104
			AND ahv.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahv ON ahv.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Override]
		FROM AUDIT_HEADER aho
		WHERE aho.METHOD_TYPE = 802103
			AND aho.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) aho ON aho.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [General]
		FROM AUDIT_HEADER ahg
		WHERE ahg.METHOD_TYPE = 802102
			AND ahg.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahg ON ahg.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Balance_Style]
		FROM AUDIT_HEADER ahb
		WHERE (
				ahb.ACTION_TYPE = 802113
				OR ahb.ACTION_TYPE = 802114
				)
			AND ahb.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahb ON ahb.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN HEADER hmssty ON hmssty.HDR_RID = vgh.HDR_RID
		AND hmssty.MANUALLYCHGDSTRSTYLALOCTNCNT > 0
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Size_Need]
		FROM AUDIT_HEADER ahs
		WHERE ahs.METHOD_TYPE = 802109
			AND ahs.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahs ON ahs.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Fill_Size_Holes]
		FROM AUDIT_HEADER ahf
		WHERE ahf.METHOD_TYPE = 802106
			AND ahf.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahf ON ahf.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT ahfs.HDR_RID,
			CASE 
				WHEN COUNT(ahfs.HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Fill_And_Need_Size]
		FROM AUDIT_HEADER ahfs,
			AUDIT_HEADER ahfs2
		WHERE ahfs.HDR_RID = ahfs2.HDR_RID
			AND ahfs.METHOD_TYPE = 802106
			AND ahfs.LAST_ENTRY = 1
			AND ahfs2.METHOD_TYPE = 802109
			AND ahfs2.LAST_ENTRY = 1
		GROUP BY ahfs.HDR_RID
		) ahfs ON ahfs.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Basis_Size]
		FROM AUDIT_HEADER ahbs
		WHERE ahbs.METHOD_TYPE = 802107
			AND ahbs.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahbs ON ahbs.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Size_Prop ]
		FROM AUDIT_HEADER ahsp
		WHERE ahsp.ACTION_TYPE = 802112
			AND ahsp.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahsp ON ahsp.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			CASE 
				WHEN COUNT(HDR_RID) > 0
					THEN 1
				ELSE 0
				END AS [Balance_size]
		FROM AUDIT_HEADER ahbsz
		WHERE (
				ahbsz.ACTION_TYPE = 802115
				OR ahbsz.ACTION_TYPE = 802116
				)
			AND ahbsz.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahbsz ON ahbsz.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN HEADER hmsz ON hmsz.HDR_RID = vgh.HDR_RID
		AND hmsz.MANUALLYCHGDSTRSIZEALOCTNCNT > 0
	LEFT OUTER JOIN HEADER hr ON hr.HDR_RID = vgh.HDR_RID
		AND hr.RSV_ALLOCATED_UNITS > 0
	INNER JOIN (
		SELECT hdrRID
		FROM #HDR_tbl
		) htbl ON vgh.HDR_RID = htbl.hdrRID
	WHERE vgh.Released <> 0
		AND (
			(
				@PLAN_HNRID > 0
				AND vgh.PLAN_HNRID = @PLAN_HNRID
				)
			OR @PLAN_HNRID = 0
			)
		AND convert(VARCHAR, ah.PROCESS_DATE_TIME, 112) BETWEEN @PROCESS_FROM_DATE
			AND @PROCESS_TO_DATE
	
	UNION
	
	SELECT 'Header',
		2 AS [Index],
		'Total Quantity' AS [Group],
		SUM(vgh.UNITS_RECEIVED) AS '#',
		SUM(ahn.Need) AS [Need],
		NULL AS [Horizion_Override],
		SUM(ahr.[Rule]) AS [Rule],
		SUM(ahv.Velocity) AS [Velocity],
		NULL AS [Override],
		NULL AS [General],
		NULL AS [Balance_Style],
		SUM(hmssty.MANUALLYCHGDSTRSTYLEALOCTN) AS [Style_Manual],
		SUM(ahs.Size_Need) AS [Size_Need],
		SUM(ahf.Fill_Size_Holes) AS [Fill_Size_Holes],
		NULL AS [Fill_And_Need_Size],
		SUM(ahbs.Basis_Size) AS [Basis_Size],
		SUM(ahsp.Size_Prop) AS [Size_Prop],
		NULL AS [Balance_size],
		SUM(hmsz.MANUALLYCHGDSTRSIZEALOCTN) AS [Size_Manual],
		SUM(hr.RSV_ALLOCATED_UNITS) AS [Reserve]
	FROM VW_GET_HEADERS vgh
	INNER JOIN AUDIT_HEADER ah ON ah.HDR_RID = vgh.HDR_RID
		AND ah.ACTION_TYPE = 802118
		AND ah.LAST_ENTRY = 1
	INNER JOIN (
		SELECT USER_RID
		FROM APPLICATION_USER
		WHERE USER_RID = @USER_RID
			AND @USER_RID <> 0
		
		UNION
		
		SELECT USER_RID
		FROM USER_GROUP_JOIN
		WHERE GROUP_RID = @USER_GROUP_RID
			AND @USER_GROUP_RID <> 0
			AND @USER_RID = 0
		) ug ON ah.USER_RID = ug.USER_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahn.UNITS_ALLOCATED_BY_PROCESS) AS Need
		FROM AUDIT_HEADER ahn
		WHERE ahn.ACTION_TYPE = 802111
			AND ahn.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahn ON ahn.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahr.UNITS_ALLOCATED_BY_PROCESS) [Rule]
		FROM AUDIT_HEADER ahr
		WHERE ahr.METHOD_TYPE = 802105
			AND ahr.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahr ON ahr.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahv.UNITS_ALLOCATED_BY_PROCESS) Velocity
		FROM AUDIT_HEADER ahv
		WHERE ahv.METHOD_TYPE = 802104
			AND ahv.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahv ON ahv.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN HEADER hmssty ON hmssty.HDR_RID = vgh.HDR_RID
		AND hmssty.MANUALLYCHGDSTRSTYLEALOCTN > 0
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahs.UNITS_ALLOCATED_BY_PROCESS) Size_Need
		FROM AUDIT_HEADER ahs
		WHERE ahs.METHOD_TYPE = 802109
			AND ahs.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahs ON ahs.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahf.UNITS_ALLOCATED_BY_PROCESS) Fill_Size_Holes
		FROM AUDIT_HEADER ahf
		WHERE ahf.METHOD_TYPE = 802106
			AND ahf.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahf ON ahf.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahbs.UNITS_ALLOCATED_BY_PROCESS) Basis_Size
		FROM AUDIT_HEADER ahbs
		WHERE ahbs.METHOD_TYPE = 802107
			AND ahbs.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahbs ON ahbs.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT DISTINCT HDR_RID,
			SUM(ahsp.UNITS_ALLOCATED_BY_PROCESS) Size_Prop
		FROM AUDIT_HEADER ahsp
		WHERE ACTION_TYPE = 802112
			AND ahsp.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahsp ON ahsp.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN HEADER hmsz ON hmsz.HDR_RID = vgh.HDR_RID
		AND hmsz.MANUALLYCHGDSTRSIZEALOCTN > 0
	LEFT OUTER JOIN HEADER hr ON hr.HDR_RID = vgh.HDR_RID
		AND hr.RSV_ALLOCATED_UNITS > 0
	INNER JOIN (
		SELECT hdrRID
		FROM #HDR_tbl
		) htbl ON vgh.HDR_RID = htbl.hdrRID
	WHERE vgh.Released <> 0
		AND (
			(
				@PLAN_HNRID > 0
				AND vgh.PLAN_HNRID = @PLAN_HNRID
				)
			OR @PLAN_HNRID = 0
			)
		AND convert(VARCHAR, ah.PROCESS_DATE_TIME, 112) BETWEEN @PROCESS_FROM_DATE
			AND @PROCESS_TO_DATE
	
	UNION
	
	SELECT 'Header',
		3 AS [Index],
		'% to Total' AS [Group],
		NULL AS '#',
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, ahn.[Need])) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Need],
		NULL AS [Horizion_Override],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, ahr.[Rule])) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Rule],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, ahv.Velocity)) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Velocity],
		NULL AS [Override],
		NULL AS [General],
		NULL AS [Balance_Style],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, hmssty.MANUALLYCHGDSTRSTYLEALOCTN)) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Style_Manual],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, ahs.Size_Need)) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Size_Need],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, ahf.Fill_Size_Holes)) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Fill_Size_Holes],
		NULL AS [Fill_And_Need_Size],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, ahbs.Basis_Size)) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Basis_Size],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, ahsp.Size_Prop)) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Size_Prop],
		NULL AS [Balance_size],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, hmsz.MANUALLYCHGDSTRSIZEALOCTN)) * 100) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Size_Manual],
		CONVERT(INT, ROUND((SUM(CONVERT(FLOAT, hr.RSV_ALLOCATED_UNITS) * 100)) / SUM(vgh.UNITS_RECEIVED), 0)) AS [Reserve]
	FROM VW_GET_HEADERS vgh
	INNER JOIN AUDIT_HEADER ah ON ah.HDR_RID = vgh.HDR_RID
		AND ah.ACTION_TYPE = 802118
		AND ah.LAST_ENTRY = 1
	INNER JOIN (
		SELECT USER_RID
		FROM APPLICATION_USER
		WHERE USER_RID = @USER_RID
			AND @USER_RID <> 0
		
		UNION
		
		SELECT USER_RID
		FROM USER_GROUP_JOIN
		WHERE GROUP_RID = @USER_GROUP_RID
			AND @USER_GROUP_RID <> 0
			AND @USER_RID = 0
		) ug ON ah.USER_RID = ug.USER_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahn.UNITS_ALLOCATED_BY_PROCESS) AS [Need]
		FROM AUDIT_HEADER ahn
		WHERE ahn.ACTION_TYPE = 802111
			AND ahn.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahn ON ahn.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahr.UNITS_ALLOCATED_BY_PROCESS) [Rule]
		FROM AUDIT_HEADER ahr
		WHERE ahr.METHOD_TYPE = 802105
			AND ahr.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahr ON ahr.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahv.UNITS_ALLOCATED_BY_PROCESS) Velocity
		FROM AUDIT_HEADER ahv
		WHERE ahv.METHOD_TYPE = 802104
			AND ahv.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahv ON ahv.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN HEADER hmssty ON hmssty.HDR_RID = vgh.HDR_RID
		AND hmssty.MANUALLYCHGDSTRSTYLEALOCTN > 0
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahs.UNITS_ALLOCATED_BY_PROCESS) Size_Need
		FROM AUDIT_HEADER ahs
		WHERE ahs.METHOD_TYPE = 802109
			AND ahs.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahs ON ahs.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahf.UNITS_ALLOCATED_BY_PROCESS) Fill_Size_Holes
		FROM AUDIT_HEADER ahf
		WHERE ahf.METHOD_TYPE = 802106
			AND ahf.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahf ON ahf.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahbs.UNITS_ALLOCATED_BY_PROCESS) Basis_Size
		FROM AUDIT_HEADER ahbs
		WHERE ahbs.METHOD_TYPE = 802107
			AND ahbs.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahbs ON ahbs.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT DISTINCT HDR_RID,
			SUM(ahsp.UNITS_ALLOCATED_BY_PROCESS) Size_Prop
		FROM AUDIT_HEADER ahsp
		WHERE ahsp.ACTION_TYPE = 802112
			AND ahsp.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahsp ON ahsp.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN HEADER hmsz ON hmsz.HDR_RID = vgh.HDR_RID
		AND hmsz.MANUALLYCHGDSTRSIZEALOCTN > 0
	LEFT OUTER JOIN HEADER hr ON hr.HDR_RID = vgh.HDR_RID
		AND hr.RSV_ALLOCATED_UNITS > 0
	INNER JOIN (
		SELECT hdrRID
		FROM #HDR_tbl
		) htbl ON vgh.HDR_RID = htbl.hdrRID
	WHERE vgh.Released <> 0
		AND (
			(
				@PLAN_HNRID > 0
				AND vgh.PLAN_HNRID = @PLAN_HNRID
				)
			OR @PLAN_HNRID = 0
			)
		AND convert(VARCHAR, ah.PROCESS_DATE_TIME, 112) BETWEEN @PROCESS_FROM_DATE
			AND @PROCESS_TO_DATE
	
	UNION
	
	SELECT 'Header',
		4 AS [Index],
		'# of Stores' AS [Group],
		NULL AS '#',
		NULL AS [Need],
		NULL AS [Horizion_Override],
		NULL AS [Rule],
		NULL AS [Velocity],
		NULL AS [Override],
		NULL AS [General],
		NULL AS [Balance_Style],
		SUM(hmssty.MANUALLYCHGDSTRSTYLALOCTNCNT) AS [Style_Manual],
		NULL AS [Size_Need],
		NULL AS [Fill_Size_Holes],
		NULL AS [Fill_And_Need_Size],
		NULL AS [Basis_Size],
		NULL AS [Size_Prop],
		NULL AS [Balance_size],
		SUM(hmsz.MANUALLYCHGDSTRSIZEALOCTNCNT) AS [Size_Manual],
		NULL AS [Reserve]
	FROM VW_GET_HEADERS vgh
	INNER JOIN AUDIT_HEADER ah ON ah.HDR_RID = vgh.HDR_RID
		AND ah.ACTION_TYPE = 802118
		AND ah.LAST_ENTRY = 1
	INNER JOIN (
		SELECT USER_RID
		FROM APPLICATION_USER
		WHERE USER_RID = @USER_RID
			AND @USER_RID <> 0
		
		UNION
		
		SELECT USER_RID
		FROM USER_GROUP_JOIN
		WHERE GROUP_RID = @USER_GROUP_RID
			AND @USER_GROUP_RID <> 0
			AND @USER_RID = 0
		) ug ON ah.USER_RID = ug.USER_RID
	LEFT OUTER JOIN HEADER hmssty ON hmssty.HDR_RID = vgh.HDR_RID
		AND hmssty.MANUALLYCHGDSTRSTYLALOCTNCNT > 0
	LEFT OUTER JOIN HEADER hmsz ON hmsz.HDR_RID = vgh.HDR_RID
		AND hmsz.MANUALLYCHGDSTRSIZEALOCTNCNT > 0
	INNER JOIN (
		SELECT hdrRID
		FROM #HDR_tbl
		) htbl ON vgh.HDR_RID = htbl.hdrRID
	WHERE vgh.Released <> 0
		AND (
			(
				@PLAN_HNRID > 0
				AND vgh.PLAN_HNRID = @PLAN_HNRID
				)
			OR @PLAN_HNRID = 0
			)
		AND convert(VARCHAR, ah.PROCESS_DATE_TIME, 112) BETWEEN @PROCESS_FROM_DATE
			AND @PROCESS_TO_DATE
	
	UNION
	
	SELECT 'Header',
		5 AS [Index],
		'Average # Stores' AS [Group],
		ROUND(SUM(hdr.STORES_WITH_ALOCTN_COUNT) / COUNT(hdr.HDR_RID), 0) AS '#',
		CONVERT(INT, ROUND(SUM(CONVERT(FLOAT, ahn.Need)) / COUNT(ahn.HDR_RID), 0)) AS [Need],
		NULL AS [Horizion_Override],
		CONVERT(INT, ROUND(SUM(CONVERT(FLOAT, ahr.[Rule])) / COUNT(ahr.HDR_RID), 0)) AS [Rule],
		CONVERT(INT, ROUND(SUM(CONVERT(FLOAT, ahv.Velocity)) / COUNT(ahv.HDR_RID), 0)) AS [Velocity],
		NULL AS [Override],
		NULL AS [General],
		NULL AS [Balance_Style],
		CONVERT(INT, ROUND(SUM(CONVERT(FLOAT, hmssty.MANUALLYCHGDSTRSTYLALOCTNCNT)) / COUNT(hmssty.HDR_RID), 0)) AS [Style_Manual],
		NULL AS [Size_Need],
		NULL AS [Fill_Size_Holes],
		NULL AS [Fill_And_Need_Size],
		NULL AS [Basis_Size],
		NULL AS [Size_Prop],
		NULL AS [Balance_size],
		CONVERT(INT, ROUND(SUM(CONVERT(FLOAT, hmsz.MANUALLYCHGDSTRSIZEALOCTNCNT)) / COUNT(hmsz.HDR_RID), 0)) AS [Size_Manual],
		NULL AS [Reserve]
	FROM VW_GET_HEADERS vgh
	INNER JOIN HEADER hdr ON hdr.HDR_RID = vgh.HDR_RID --This will be used for get the value for #
	INNER JOIN AUDIT_HEADER ah ON ah.HDR_RID = vgh.HDR_RID
		AND ah.ACTION_TYPE = 802118
		AND ah.LAST_ENTRY = 1
	INNER JOIN (
		SELECT USER_RID
		FROM APPLICATION_USER
		WHERE USER_RID = @USER_RID
			AND @USER_RID <> 0
		
		UNION
		
		SELECT USER_RID
		FROM USER_GROUP_JOIN
		WHERE GROUP_RID = @USER_GROUP_RID
			AND @USER_GROUP_RID <> 0
			AND @USER_RID = 0
		) ug ON ah.USER_RID = ug.USER_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahn.STORE_COUNT) AS Need
		FROM AUDIT_HEADER ahn
		WHERE ahn.ACTION_TYPE = 802111
			AND ahn.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahn ON ahn.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahr.STORE_COUNT) [Rule]
		FROM AUDIT_HEADER ahr
		WHERE ahr.METHOD_TYPE = 802105
			AND ahr.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahr ON ahr.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN (
		SELECT HDR_RID,
			SUM(ahv.STORE_COUNT) Velocity
		FROM AUDIT_HEADER ahv
		WHERE ahv.METHOD_TYPE = 802104
			AND ahv.LAST_ENTRY = 1
		GROUP BY HDR_RID
		) ahv ON ahv.HDR_RID = vgh.HDR_RID
	LEFT OUTER JOIN HEADER hmssty ON hmssty.HDR_RID = vgh.HDR_RID
		AND hmssty.MANUALLYCHGDSTRSTYLALOCTNCNT > 0
	LEFT OUTER JOIN HEADER hmsz ON hmsz.HDR_RID = vgh.HDR_RID
		AND hmsz.MANUALLYCHGDSTRSIZEALOCTNCNT > 0
	INNER JOIN (
		SELECT hdrRID
		FROM #HDR_tbl
		) htbl ON vgh.HDR_RID = htbl.hdrRID
	WHERE vgh.Released <> 0
		AND (
			(
				@PLAN_HNRID > 0
				AND vgh.PLAN_HNRID = @PLAN_HNRID
				)
			OR @PLAN_HNRID = 0
			)
		AND convert(VARCHAR, ah.PROCESS_DATE_TIME, 112) BETWEEN @PROCESS_FROM_DATE
			AND @PROCESS_TO_DATE
	
	UNION
	
	SELECT 'Header',
		6 AS [Index],
		'Average Per Header' AS [Group],
		CONVERT(INT, ROUND(SUM(CONVERT(FLOAT, vgh.UNITS_RECEIVED)) / COUNT(vgh.HDR_RID), 0)) AS '#',
		NULL AS [Need],
		NULL AS [Horizion_Override],
		NULL AS [Rule],
		NULL AS [Velocity],
		NULL AS [Override],
		NULL AS [General],
		NULL AS [Balance_Style],
		CONVERT(INT, ROUND(SUM(CONVERT(FLOAT, hmssty.MANUALLYCHGDSTRSTYLEALOCTN)) / COUNT(hmssty.HDR_RID), 0)) AS [Style_Manual],
		NULL AS [Size_Need],
		NULL AS [Fill_Size_Holes],
		NULL AS [Fill_And_Need_Size],
		NULL AS [Basis_Size],
		NULL AS [Size_Prop],
		NULL AS [Balance_size],
		NULL AS [Size_Manual],
		CONVERT(INT, ROUND(SUM(CONVERT(FLOAT, hr.RSV_ALLOCATED_UNITS)) / COUNT(hr.HDR_RID), 0)) AS [Reserve]
	FROM VW_GET_HEADERS vgh
	INNER JOIN AUDIT_HEADER ah ON ah.HDR_RID = vgh.HDR_RID
		AND ah.ACTION_TYPE = 802118
		AND ah.LAST_ENTRY = 1
	INNER JOIN (
		SELECT USER_RID
		FROM APPLICATION_USER
		WHERE USER_RID = @USER_RID
			AND @USER_RID <> 0
		
		UNION
		
		SELECT USER_RID
		FROM USER_GROUP_JOIN
		WHERE GROUP_RID = @USER_GROUP_RID
			AND @USER_GROUP_RID <> 0
			AND @USER_RID = 0
		) ug ON ah.USER_RID = ug.USER_RID
	LEFT OUTER JOIN HEADER hmssty ON hmssty.HDR_RID = vgh.HDR_RID
		AND hmssty.MANUALLYCHGDSTRSTYLEALOCTN > 0
	LEFT OUTER JOIN HEADER hr ON hr.HDR_RID = vgh.HDR_RID
		AND hr.RSV_ALLOCATED_UNITS > 0
	INNER JOIN (
		SELECT hdrRID
		FROM #HDR_tbl
		) htbl ON vgh.HDR_RID = htbl.hdrRID
	WHERE vgh.Released <> 0
		AND (
			(
				@PLAN_HNRID > 0
				AND vgh.PLAN_HNRID = @PLAN_HNRID
				)
			OR @PLAN_HNRID = 0
			)
		AND convert(VARCHAR, ah.PROCESS_DATE_TIME, 112) BETWEEN @PROCESS_FROM_DATE
			AND @PROCESS_TO_DATE

	IF (
			SELECT object_id('tempdb.dbo.#HDR_tbl')
			) > 0
		DROP TABLE #HDR_tbl
END
GO


