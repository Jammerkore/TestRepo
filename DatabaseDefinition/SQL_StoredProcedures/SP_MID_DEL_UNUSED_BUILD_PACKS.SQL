--dv =============================================
--dv Modified date: 2/18/2014
--dv Flags: REFERENCED_FROM_SQL_ONLY
--dv Description: Utility stored procedure to fix unused build packs
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_DEL_UNUSED_BUILD_PACKS] 
AS
BEGIN
	CREATE TABLE #TEMP1 (
		BPC_RID INT NULL,
		METHOD_RID INT NULL
		)

	INSERT INTO #TEMP1
	SELECT BPC.BPC_RID,
		MBP.METHOD_RID
	FROM BUILD_PACK_CRITERIA BPC
	LEFT JOIN METHOD_BLD_PACKS MBP ON BPC.BPC_RID = MBP.BPC_RID
	WHERE MBP.METHOD_RID IS NULL

	SELECT BPC_COMBO_RID
	INTO #TEMP2
	FROM BUILD_PACK_COMBO
	WHERE BPC_RID IN (
			SELECT BPC_RID
			FROM #TEMP1
			)

	DELETE
	FROM BUILD_PACK_CONFIG
	WHERE BPC_COMBO_RID IN (
			SELECT BPC_COMBO_RID
			FROM #TEMP2
			)

	DELETE
	FROM BUILD_PACK_COMBO
	WHERE BPC_COMBO_RID IN (
			SELECT BPC_COMBO_RID
			FROM #TEMP2
			)

	DELETE
	FROM BUILD_PACK_CRITERIA
	WHERE BPC_RID IN (
			SELECT BPC_RID
			FROM #TEMP1
			)

	DROP TABLE #TEMP1

	DROP TABLE #TEMP2

	SELECT @@ROWCOUNT;
END
GO


