--dv =============================================
--dv Modified date:	8/14/2014
--dv Description:	Gets allocation data fro a header
--dv History:		TT#1268 - MD - RMatelic - 5.4 Merge
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_GET_HEADER_ALLOCATION] 
	(@HDR_RID INT)
AS
BEGIN
	SET NOCOUNT ON

	SELECT HDR_RID,
		ST_RID,
		SHIP_DAY,
		COALESCE(STORE_GRADE_INDEX, 0) AS STORE_GRADE_INDEX,
		-- Begin TT#1074 - MD - Jellis - Group ALlocation - Inventory Min Max Broken
        -- COALESCE(STORE_CAPACITY,0) as STORE_CAPACITY,
		STORE_CAPACITY, 
		-- End TT#1074 - MD - Jellis - Group ALlocation - Inventory Min Max Broken
		COALESCE(EXCEED_CAPACITY_PERCENT, '-1') AS EXCEED_CAPACITY_PERCENT,
		COALESCE(ALLOC_STORE_GEN_AUDIT_FLAGS, 0) AS ALLOC_STORE_GEN_AUDIT_FLAGS,
		COALESCE(UNITS_ALLOCATED, 0) AS UNITS_ALLOCATED,
		CHOSEN_RULE_TYPE_ID,
		COALESCE(CHOSEN_RULE_LAYER_ID, 0) AS CHOSEN_RULE_LAYER_ID,
		COALESCE(CHOSEN_RULE_UNITS, 0) AS CHOSEN_RULE_UNITS,
		COALESCE(UNITS_ALLOCATED_BY_AUTO, 0) AS UNITS_ALLOCATED_BY_AUTO,
		COALESCE(UNITS_ALLOCATED_BY_RULE, 0) AS UNITS_ALLOCATED_BY_RULE,
		NEED_DAY,
		COALESCE(UNIT_NEED_BEFORE, 0) AS UNIT_NEED_BEFORE,
		COALESCE(PERCENT_NEED_BEFORE, 0) AS PERCENT_NEED_BEFORE,
		COALESCE(MINIMUM, 0) AS MINIMUM,
		-- Begin TT#3263 - JSmith - Cancelled the allocation on a header
		--COALESCE(p.MAXIMUM,0) as MAXIMUM,
		--COALESCE(p.PRIMARY_MAX,0) as PRIMARY_MAX,
		MAXIMUM,
		PRIMARY_MAX,
		-- End TT#3263 - JSmith - Cancelled the allocation on a header
		COALESCE(ALLOC_STORE_DET_AUDIT_FLAGS, 0) AS ALLOC_STORE_DET_AUDIT_FLAGS,
		COALESCE(SHIPPING_STATUS_FLAGS, 0) AS SHIPPING_STATUS_FLAGS,
		COALESCE(UNITS_SHIPPED, 0) AS UNITS_SHIPPED,
		IMO_MAX_VALUE,
		COALESCE(IMO_MIN_SHIP_QTY, 0) AS IMO_MIN_SHIP_QTY,
		COALESCE(IMO_PCT_PK_THRSHLD, '.5') AS IMO_PCT_PK_THRSHLD,
		COALESCE(ITEM_UNITS_ALLOCATED, UNITS_ALLOCATED) AS ITEM_UNITS_ALLOCATED
	FROM TOTAL_ALLOCATION
	WHERE HDR_RID = @HDR_RID

	SELECT d.HDR_RID AS HDR_RID,
		d.ST_RID AS ST_RID,
		COALESCE(d.UNITS_ALLOCATED, 0) AS UNITS_ALLOCATED,
		d.CHOSEN_RULE_TYPE_ID,
		COALESCE(d.CHOSEN_RULE_LAYER_ID, 0) AS CHOSEN_RULE_LAYER_ID,
		COALESCE(d.CHOSEN_RULE_UNITS, 0) AS CHOSEN_RULE_UNITS,
		COALESCE(d.UNITS_ALLOCATED_BY_AUTO, 0) AS UNITS_ALLOCATED_BY_AUTO,
		COALESCE(d.UNITS_ALLOCATED_BY_RULE, 0) AS UNITS_ALLOCATED_BY_RULE,
		d.NEED_DAY AS NEED_DAY,
		COALESCE(d.UNIT_NEED_BEFORE, 0) AS UNIT_NEED_BEFORE,
		COALESCE(d.PERCENT_NEED_BEFORE, 0) AS PERCENT_NEED_BEFORE,
		COALESCE(d.MINIMUM, 0) AS MINIMUM,
		-- Begin TT#3263 - JSmith - Cancelled the allocation on a header
		--COALESCE(p.MAXIMUM,0) as MAXIMUM,
		--COALESCE(p.PRIMARY_MAX,0) as PRIMARY_MAX,
		MAXIMUM,
		PRIMARY_MAX,
		-- End TT#3263 - JSmith - Cancelled the allocation on a header
		COALESCE(d.ALLOC_STORE_DET_AUDIT_FLAGS, 0) AS ALLOC_STORE_DET_AUDIT_FLAGS,
		COALESCE(d.ITEM_UNITS_ALLOCATED, d.UNITS_ALLOCATED) AS ITEM_UNITS_ALLOCATED
	FROM DETAIL_ALLOCATION AS d
	WHERE d.HDR_RID = @HDR_RID

	SELECT b.HDR_RID AS HDR_RID,
		b.ST_RID AS ST_RID,
		COALESCE(b.UNITS_ALLOCATED, 0) AS UNITS_ALLOCATED,
		CHOSEN_RULE_TYPE_ID,
		COALESCE(b.CHOSEN_RULE_LAYER_ID, 0) AS CHOSEN_RULE_LAYER_ID,
		COALESCE(b.CHOSEN_RULE_UNITS, 0) AS CHOSEN_RULE_UNITS,
		COALESCE(b.UNITS_ALLOCATED_BY_AUTO, 0) AS UNITS_ALLOCATED_BY_AUTO,
		COALESCE(b.UNITS_ALLOCATED_BY_RULE, 0) AS UNITS_ALLOCATED_BY_RULE,
		b.NEED_DAY AS NEED_DAY,
		COALESCE(b.UNIT_NEED_BEFORE, 0) AS UNIT_NEED_BEFORE,
		COALESCE(b.PERCENT_NEED_BEFORE, 0) AS PERCENT_NEED_BEFORE,
		COALESCE(b.MINIMUM, 0) AS MINIMUM,
		-- Begin TT#3263 - JSmith - Cancelled the allocation on a header
		--COALESCE(p.MAXIMUM,0) as MAXIMUM,
		--COALESCE(p.PRIMARY_MAX,0) as PRIMARY_MAX,
		MAXIMUM,
		PRIMARY_MAX,
		-- End TT#3263 - JSmith - Cancelled the allocation on a header
		COALESCE(b.ALLOC_STORE_DET_AUDIT_FLAGS, 0) AS ALLOC_STORE_DET_AUDIT_FLAGS,
		COALESCE(b.ITEM_UNITS_ALLOCATED, b.UNITS_ALLOCATED) AS ITEM_UNITS_ALLOCATED
	FROM BULK_ALLOCATION AS b
	WHERE b.HDR_RID = @HDR_RID

	SELECT bc.HDR_RID AS HDR_RID,
		bc.HDR_BC_RID AS HDR_BC_RID,
		bc.ST_RID AS ST_RID,
		COALESCE(bc.UNITS_ALLOCATED, 0) AS UNITS_ALLOCATED,
		CHOSEN_RULE_TYPE_ID,
		COALESCE(bc.CHOSEN_RULE_LAYER_ID, 0) AS CHOSEN_RULE_LAYER_ID,
		COALESCE(bc.CHOSEN_RULE_UNITS, 0) AS CHOSEN_RULE_UNITS,
		COALESCE(bc.UNITS_ALLOCATED_BY_AUTO, 0) AS UNITS_ALLOCATED_BY_AUTO,
		COALESCE(bc.UNITS_ALLOCATED_BY_RULE, 0) AS UNITS_ALLOCATED_BY_RULE,
		bc.NEED_DAY AS NEED_DAY,
		COALESCE(bc.UNIT_NEED_BEFORE, 0) AS UNIT_NEED_BEFORE,
		COALESCE(bc.PERCENT_NEED_BEFORE, 0) AS PERCENT_NEED_BEFORE,
		COALESCE(bc.MINIMUM, 0) AS MINIMUM,
		-- Begin TT#3263 - JSmith - Cancelled the allocation on a header
		--COALESCE(p.MAXIMUM,0) as MAXIMUM,
		--COALESCE(p.PRIMARY_MAX,0) as PRIMARY_MAX,
		MAXIMUM,
		PRIMARY_MAX,
		-- End TT#3263 - JSmith - Cancelled the allocation on a header
		COALESCE(bc.ALLOC_STORE_DET_AUDIT_FLAGS, 0) AS ALLOC_STORE_DET_AUDIT_FLAGS,
		COALESCE(bc.SHIPPING_STATUS_FLAGS, 0) AS SHIPPING_STATUS_FLAGS,
		COALESCE(bc.UNITS_SHIPPED, 0) AS UNITS_SHIPPED,
		COALESCE(bc.ITEM_UNITS_ALLOCATED, bc.UNITS_ALLOCATED) AS ITEM_UNITS_ALLOCATED
	FROM BULK_COLOR_ALLOCATION AS bc
	WHERE bc.HDR_RID = @HDR_RID

	SELECT bcs.HDR_RID AS HDR_RID,
		bcs.HDR_BC_RID AS HDR_BC_RID,
		bcs.HDR_BCSZ_KEY AS HDR_BCSZ_KEY,
		bcs.ST_RID,
		COALESCE(bcs.UNITS_ALLOCATED, 0) AS UNITS_ALLOCATED,
		COALESCE(bcs.UNITS_ALLOCATED_BY_AUTO, 0) AS UNITS_ALLOCATED_BY_AUTO,
		COALESCE(bcs.MINIMUM, 0) AS MINIMUM,
		-- Begin TT#3263 - JSmith - Cancelled the allocation on a header
		--COALESCE(p.MAXIMUM,0) as MAXIMUM,
		--COALESCE(p.PRIMARY_MAX,0) as PRIMARY_MAX,
		MAXIMUM,
		PRIMARY_MAX,
		-- End TT#3263 - JSmith - Cancelled the allocation on a header
		COALESCE(bcs.ALLOC_STORE_DET_AUDIT_FLAGS, 0) AS ALLOC_STORE_DET_AUDIT_FLAGS,
		COALESCE(bcs.SHIPPING_STATUS_FLAGS, 0) AS SHIPPING_STATUS_FLAGS,
		COALESCE(bcs.UNITS_SHIPPED, 0) AS UNITS_SHIPPED,
		COALESCE(bcs.ITEM_UNITS_ALLOCATED, bcs.UNITS_ALLOCATED) AS ITEM_UNITS_ALLOCATED,
		COALESCE(bcs.ITEM_MINIMUM, 0) AS ITEM_MINIMUM,
		COALESCE(bcs.ITEM_IDEAL_MINIMUM, 0) AS ITEM_IDEAL_MINIMUM
	FROM BULK_COLOR_SIZE_ALLOCATION AS bcs
	WHERE bcs.HDR_RID = @HDR_RID

	SELECT p.HDR_PACK_RID AS HDR_PACK_RID,
		p.ST_RID AS ST_RID,
		COALESCE(p.PACKS_ALLOCATED, 0) AS PACKS_ALLOCATED,
		CHOSEN_RULE_TYPE_ID,
		COALESCE(p.CHOSEN_RULE_LAYER_ID, 0) AS CHOSEN_RULE_LAYER_ID,
		COALESCE(p.CHOSEN_RULE_PACKS, 0) AS CHOSEN_RULE_PACKS,
		COALESCE(p.PACKS_ALLOCATED_BY_AUTO, 0) AS PACKS_ALLOCATED_BY_AUTO,
		COALESCE(p.PACKS_ALLOCATED_BY_RULE, 0) AS PACKS_ALLOCATED_BY_RULE,
		p.NEED_DAY AS NEED_DAY,
		COALESCE(p.UNIT_NEED_BEFORE, 0) AS UNIT_NEED_BEFORE,
		COALESCE(p.PERCENT_NEED_BEFORE, 0) AS PERCENT_NEED_BEFORE,
		COALESCE(p.MINIMUM, 0) AS MINIMUM,
		-- Begin TT#3263 - JSmith - Cancelled the allocation on a header
		--COALESCE(p.MAXIMUM,0) as MAXIMUM,
		--COALESCE(p.PRIMARY_MAX,0) as PRIMARY_MAX,
		MAXIMUM,
		PRIMARY_MAX,
		-- End TT#3263 - JSmith - Cancelled the allocation on a header
		COALESCE(p.ALLOC_STORE_DET_AUDIT_FLAGS, 0) AS ALLOC_STORE_DET_AUDIT_FLAGS,
		COALESCE(p.SHIPPING_STATUS_FLAGS, 0) AS SHIPPING_STATUS_FLAGS,
		COALESCE(p.PACKS_SHIPPED, 0) AS PACKS_SHIPPED,
		COALESCE(p.ITEM_PACKS_ALLOCATED, p.PACKS_ALLOCATED) AS ITEM_PACKS_ALLOCATED
	FROM PACK_ALLOCATION AS p
	WHERE p.HDR_RID = @HDR_RID
END
GO


