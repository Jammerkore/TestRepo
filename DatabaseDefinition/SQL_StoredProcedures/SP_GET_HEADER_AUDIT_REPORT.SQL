CREATE PROCEDURE [dbo].[SP_GET_HEADER_AUDIT_REPORT] 
	@SELECTED_NODE_RID INT,
	@PLAN_HNRID INT,
	@USER_RID INT,
	@USER_GROUP_RID INT,
	@PROCESS_FROM_DATE VARCHAR(50),
	@PROCESS_TO_DATE VARCHAR(50),
	@HEADER_RID_LIST TEXT
AS
DECLARE @PH_RID INT

IF (@SELECTED_NODE_RID = 0) -- get top node of main hierarchy	
BEGIN
	-- Get the RID for the main organizational hierarchy
	SELECT @PH_RID = PH_RID
	FROM PRODUCT_HIERARCHY
	WHERE PH_TYPE = 800000

	SELECT @SELECTED_NODE_RID = hnj.HN_RID
	FROM HIER_NODE_JOIN hnj
	INNER JOIN HIERARCHY_NODE hn ON hn.HN_RID = hnj.HN_RID
		AND hnj.PARENT_HN_RID = 0
		AND hn.HOME_PH_RID = @PH_RID
		AND hnj.NODE_DELETE_IND = '0' -- TT#3630 - JSmith - Delete My Hierarchy
END

IF (
		@HEADER_RID_LIST IS NOT NULL
		AND DATALENGTH(@HEADER_RID_LIST) > 0
		)
BEGIN
	IF (
			@USER_RID > 0
			OR @USER_GROUP_RID > 0
			)
		EXEC SP_GET_HEADER_AUDIT_REPORT_FOR_LIST_AND_USER @SELECTED_NODE_RID,
			@PLAN_HNRID,
			@USER_RID,
			@USER_GROUP_RID,
			@PROCESS_FROM_DATE,
			@PROCESS_TO_DATE,
			@HEADER_RID_LIST
	ELSE
		EXEC SP_GET_HEADER_AUDIT_REPORT_FOR_LIST_NO_USER @SELECTED_NODE_RID,
			@PLAN_HNRID,
			@PROCESS_FROM_DATE,
			@PROCESS_TO_DATE,
			@HEADER_RID_LIST
END
ELSE IF (
		@USER_RID > 0
		OR @USER_GROUP_RID > 0
		)
	EXEC SP_GET_HEADER_AUDIT_REPORT_FOR_USER @SELECTED_NODE_RID,
		@PLAN_HNRID,
		@USER_RID,
		@PROCESS_FROM_DATE,
		@PROCESS_TO_DATE,
		@USER_GROUP_RID
ELSE
	EXEC SP_GET_HEADER_AUDIT_REPORT_NO_USER @SELECTED_NODE_RID,
		@PLAN_HNRID,
		@PROCESS_FROM_DATE,
		@PROCESS_TO_DATE
GO


