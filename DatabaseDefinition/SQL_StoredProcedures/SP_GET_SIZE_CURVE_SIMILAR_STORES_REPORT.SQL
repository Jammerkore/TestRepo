CREATE PROCEDURE [dbo].[SP_GET_SIZE_CURVE_SIMILAR_STORES_REPORT] 
	@SELECTED_NODE_RID INT,
	@LOWER_LEVEL INT
AS
BEGIN
	DECLARE @SELECTED_NODE_LEVEL AS INT,
		@HOME_PH_RID AS INT

	SELECT @SELECTED_NODE_LEVEL = HOME_LEVEL,
		@HOME_PH_RID = HOME_PH_RID
	FROM HIERARCHY_NODE
	WHERE HN_RID = @SELECTED_NODE_RID

	DECLARE @MAX_PHL_SEQUENCE AS INT

	SELECT @MAX_PHL_SEQUENCE = MAX(PHL_SEQUENCE)
	FROM PRODUCT_HIERARCHY_LEVELS

	IF (@LOWER_LEVEL = 0)
	BEGIN
		SELECT @LOWER_LEVEL = @MAX_PHL_SEQUENCE
	END

	DECLARE @LEVEL AS INT

	SELECT @LEVEL = (@LOWER_LEVEL - @SELECTED_NODE_LEVEL) + 1

	SELECT @LEVEL = @LOWER_LEVEL - 1

	CREATE TABLE #TEMPNODE (
		PARENT_HN_RID INT,
		HN_RID INT,
		BN_ID VARCHAR(356) COLLATE Latin1_General_CS_AS,
		BN_NAME VARCHAR(50) COLLATE Latin1_General_CS_AS,
		BN_DESCRIPTION VARCHAR(250) COLLATE Latin1_General_CS_AS
		)

	INSERT #TEMPNODE (
		PARENT_HN_RID,
		HN_RID,
		BN_ID,
		BN_NAME,
		BN_DESCRIPTION
		)
	EXEC SP_GET_ALL_DESCENDANTS_BY_LEVEL_REPORT @SELECTED_NODE_RID,
		@LEVEL

	CREATE TABLE #SIZE_CURVE_SIMILAR_STORES_TABLE (
		HN_RID INT,
		BN_ID VARCHAR(356),
		ST_RID INT,
		SS_RID INT,
		UNTIL_DATE INT,
		STORE_TEXT VARCHAR(200),
		SIMILAR_STORE_TEXT VARCHAR(200),
		SELLING_OPEN_DATE SMALLDATETIME
		)

	INSERT INTO #SIZE_CURVE_SIMILAR_STORES_TABLE
	SELECT hn.HN_RID,
		-- Begin TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
		--[dbo].[UDF_MID_GET_NODE_DISPLAY_LEVEL](hn.HN_RID) AS [BN_ID],
		[dbo].[UDF_MID_GET_NODE_DISPLAY](hn.HN_RID) AS [BN_ID],
		-- End TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
		ST_RID,
		SS_RID,
		UNTIL_DATE,
		[dbo].[UDF_MID_GET_STORE_TEXT](ST_RID) AS [STORE_TEXT],
		[dbo].[UDF_MID_GET_STORE_TEXT](SS_RID) AS [SIMILAR_STORE_TEXT],
		SELLING_OPEN_DATE
	FROM (
		SELECT NSCSS.HN_RID,
			NSCSS.ST_RID,
			NSCSS.SS_RID,
			NSCSS.UNTIL_DATE,
			ST.SELLING_OPEN_DATE
		FROM NODE_SIZE_CURVE_SIMILAR_STORE NSCSS
		INNER JOIN STORES ST ON ST.ST_RID = NSCSS.ST_RID
		) AS T
	INNER JOIN (
		SELECT PARENT_HN_RID,
			HN_RID,
			BN_ID,
			BN_NAME,
			BN_DESCRIPTION
		FROM #TEMPNODE
		) hn ON hn.HN_RID = T.HN_RID

	SELECT *
	FROM #SIZE_CURVE_SIMILAR_STORES_TABLE
	ORDER BY BN_ID

	IF (
			SELECT object_id('tempdb.dbo.#TEMPNODE')
			) > 0
		DROP TABLE #TEMPNODE

	DROP TABLE #SIZE_CURVE_SIMILAR_STORES_TABLE
END
GO


