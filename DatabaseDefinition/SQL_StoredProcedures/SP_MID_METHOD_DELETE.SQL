--dv =============================================
--dv Modified date:	9/22/2016
--dv Modified date:	8/14/2014
--dv Description:	Deletes a designated method
--dv History:		TT#1268 - MD - RMatelic - 5.4 Merge
--dv History:		TT#5292-Purge Error number 3-BonTon
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_METHOD_DELETE] 
	@METHOD_RID INT,
	@RETURN_ROWCOUNT BIT = 1
AS
BEGIN
	DECLARE @t TABLE (
		RID INT,
		STEP INT
		)
	DECLARE @RID INT
	DECLARE @STEP INT
	DECLARE @CUST_OLL_RID INT

	/* Begin TT#1873 - JSmith - Purge Failed with Severe Error */
	--delete BULK_COLOR_RULE_LAYER with (rowlock) where METHOD_RID = @METHOD_RID
	UPDATE BULK_COLOR_RULE_LAYER
	SET METHOD_RID = 1
	WHERE METHOD_RID = @METHOD_RID

	/* End TT#1873  */
	DELETE DEFAULT_OTS_PLAN_METHOD
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* Begin TT#1873 - JSmith - Purge Failed with Severe Error */
	--delete DETAIL_RULE_LAYER with (rowlock) where METHOD_RID = @METHOD_RID
	UPDATE DETAIL_RULE_LAYER
	SET METHOD_RID = 1
	WHERE METHOD_RID = @METHOD_RID

	/* End TT#1873  */
	DELETE TREND_CAPS
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE STOCK_MIN_MAX
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE GROUP_LEVEL_NODE_FUNCTION
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE GROUP_LEVEL_BASIS
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE GROUP_LEVEL_FUNCTION
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	--delete HEADER with (rowlock) where METHOD_RID = @METHOD_RID
	DELETE METHOD_CHANGE_HISTORY
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_COPY_BASIS_DETAIL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_COPY_GROUP_LEVEL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_COPY_FORECAST
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE SIZE_MTH_RULE_COLOR_SIZE
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE SIZE_MTH_RULE_GRPLVL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_FILL_SIZE_HOLES
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_GENERAL_ALLOCATION
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_MATRIX_BASIS_DETAILS
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_MATRIX
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_OVERRIDE_CAPACITY
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* BEGIN TT#616 - AGallagher - Allocation - Pack Rounding (#67) */
	DELETE METHOD_OVERRIDE_PACK_ROUNDING
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* END TT#616 - AGallagher - Allocation - Pack Rounding (#67) */
	/* BEGIN TT#618 - AGallagher - Allocation Override - Add Attribute Sets (#35) */
	/* delete METHOD_OVERRIDE_STORE_GRADES with (rowlock) where METHOD_RID = @METHOD_RID */
	DELETE METHOD_OVERRIDE_STORE_GRADES_VALUES
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_OVERRIDE_STORE_GRADES_BOUNDARY
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* BEGIN TT#618 - AGallagher - Allocation Override - Add Attribute Sets (#35) */
	DELETE METHOD_OVERRIDE_COLOR_MINMAX
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID -- TT#3450 - JSmith - Purge process Failed

	DELETE METHOD_OVERRIDE
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	-- Begin TT#755 - JScott - Constraint error encountered during Purge
	-- BEGIN TT#708-MD - Stodd - Group Allocation Prototype   
	DELETE METHOD_GROUP_ALLOCATION_STORE_GRADES_VALUES 
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID
    
	DELETE METHOD_GROUP_ALLOCATION_STORE_GRADES_BOUNDARY
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

    DELETE METHOD_GROUP_ALLOCATION
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID
	-- END TT#708-MD - Stodd - Group Allocation Prototype    

	DELETE METHOD_ROLLUP_BASIS_DETAIL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_ROLLUP
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SIZE_CURVE_CRVE_BAS_DET
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SIZE_CURVE_MRCH_BAS_DET
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SIZE_CURVE
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	-- End TT#755 - JScott - Constraint error encountered during Purge
	DELETE METHOD_RULE
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SIZE_BASIS_SUBSTITUTES
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SIZE_BASIS_ALLOCATION
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SIZE_NEED
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SIZE_NEED_ALLOCATION
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SPREAD_BASIS_DETAIL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_SPREAD_FORECAST
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_VELOCITY_MATRIX
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_VELOCITY_SELL_THRU
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_VELOCITY_GRADE
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_VELOCITY_BASIS
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_VELOCITY_GROUP_LEVEL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_VELOCITY
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_MOD_SALES_MATRIX
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_MOD_SALES_SELL_THRU
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_MOD_SALES_GRADE
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_MOD_SALES
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* Begin TT#370 - Build Packs Enhancement - J.Ellis */
	DELETE METHOD_BLD_PACKS_BPC_SELECT
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_BLD_PACKS_COMBO_PATTERN_SZRUN
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_BLD_PACKS_COMBO_PATTERN
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_BLD_PACKS_COMBO_PATTERN
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_BLD_PACKS_COMBO
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_BLD_PACKS
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* Begin TT#370 - Build Packs Enhancement - J.Ellis */
	DELETE OTS_PLAN
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* Begin TT#1873 - JSmith - Purge Failed with Severe Error */
	--delete PACK_RULE_LAYER with (rowlock) where METHOD_RID = @METHOD_RID
	UPDATE PACK_RULE_LAYER
	SET METHOD_RID = 1
	WHERE METHOD_RID = @METHOD_RID

	/* End TT#1873 */
	DELETE TASK_ALLOCATE_DETAIL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE TASK_FORECAST_BALANCE_DETAIL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE TASK_FORECAST_DETAIL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* Begin TT#1873 - JSmith - Purge Failed with Severe Error */
	--delete BULK_RULE_LAYER with (rowlock) where METHOD_RID = @METHOD_RID
	UPDATE BULK_RULE_LAYER
	SET METHOD_RID = 1
	WHERE METHOD_RID = @METHOD_RID

	--delete TOTAL_RULE_LAYER with (rowlock) where METHOD_RID = @METHOD_RID
	UPDATE TOTAL_RULE_LAYER
	SET METHOD_RID = 1
	WHERE METHOD_RID = @METHOD_RID

	/* End TT#1873 */
	DELETE USER_METHOD_PREF
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_EXPORT_VARIABLES
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_EXPORT
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_GLOBAL_UNLOCK_GRP_LVL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_GLOBAL_UNLOCK
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* Begin TT#3384 - JSmith - Users marked for deletion are not removed during purge */
	DELETE METHOD_GLOBAL_LOCK_GRP_LVL
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE METHOD_GLOBAL_LOCK
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	/* End TT#3384 - JSmith - Users marked for deletion are not removed during purge */
	--delete METHOD_GENERAL_ASSORTMENT with (rowlock) where METHOD_RID = @METHOD_RID
	--delete ASSORTMENT_PROPERTIES with (rowlock) where GEN_ASSORT_METHOD_RID = @METHOD_RID
	-- remove all workflow step components
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	INSERT INTO @t
	SELECT WORKFLOW_RID,
		STEP_NUMBER
	FROM [dbo].[WORKFLOW_STEP_ALLOCATION]
	WHERE METHOD_RID = @METHOD_RID

	SET TRANSACTION ISOLATION LEVEL READ COMMITTED

	SELECT TOP 1 @RID = RID,
		@STEP = STEP
	FROM @t

	WHILE @@rowcount <> 0
	BEGIN
		DELETE ALLOCATION_STEP_COMPONENT
		WITH (ROWLOCK)
		WHERE WORKFLOW_RID = @RID
			AND STEP_NUMBER = @STEP

		DELETE @t
		WHERE RID = @RID
			AND STEP = @STEP

		SELECT TOP 1 @RID = RID,
			@STEP = STEP
		FROM @t
	END

	DELETE WORKFLOW_STEP_ALLOCATION
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	DELETE WORKFLOW_STEP_OTSPLAN
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	SELECT @CUST_OLL_RID = CUSTOM_OLL_RID
	FROM METHOD WITH (NOLOCK)
	WHERE METHOD_RID = @METHOD_RID

	IF @CUST_OLL_RID IS NOT NULL
	BEGIN
		UPDATE METHOD
		SET CUSTOM_OLL_RID = NULL
		WHERE METHOD_RID = @METHOD_RID

/* BEGIN TT#5292-VStuart-Purge Error number 3-BonTon */
		SELECT CUSTOM_OLL_RID
		FROM METHOD WITH (NOLOCK)
		WHERE CUSTOM_OLL_RID = @CUST_OLL_RID

		IF (@@ROWCOUNT = 0)
		BEGIN
			DELETE OVERRIDE_LL_MODEL_DETAIL
			WITH (ROWLOCK)
			WHERE OLL_RID = @CUST_OLL_RID

			DELETE OVERRIDE_LL_MODEL_HEADER
			WITH (ROWLOCK)
			WHERE OLL_RID = @CUST_OLL_RID
		END
/* END TT#5292-VStuart-Purge Error number 3-BonTon */
	END

	-- Begin TT#755 - JScott - Constraint error encountered during Purge
	-- Remove Folder Join Connections
	DELETE FOLDER_JOIN
	WITH (ROWLOCK)
	WHERE CHILD_ITEM_RID = @METHOD_RID
		AND CHILD_ITEM_TYPE IN (
			83,
			84,
			85,
			86,
			87,
			88,
			89,
			90,
			91,
			92,
			93,
			94,
			95,
			96,
			97,
			98,
			99,
			119,
			122
			)

	-- End TT#755 - JScott - Constraint error encountered during Purge
	-- Begin TT#994 - JSmith - Unable to delete method that is not attached to workflow
	UPDATE AUDIT_HEADER
	SET METHOD_HAS_BEEN_DELETED = '1'
	WHERE METHOD_RID = @METHOD_RID

	UPDATE AUDIT_HEADER
	SET METHOD_NAME = (
			SELECT METHOD_NAME
			FROM METHOD
			WHERE METHOD_RID = @METHOD_RID
			)
	WHERE METHOD_RID = @METHOD_RID

	UPDATE AUDIT_HEADER
	SET METHOD_RID = - 1
	WHERE METHOD_RID = @METHOD_RID /* TT#1389 - stodd */

	UPDATE AUDIT_FORECAST
	SET METHOD_HAS_BEEN_DELETED = '1'
	WHERE METHOD_RID = @METHOD_RID

	UPDATE AUDIT_FORECAST
	SET METHOD_NAME = (
			SELECT METHOD_NAME
			FROM METHOD
			WHERE METHOD_RID = @METHOD_RID
			)
	WHERE METHOD_RID = @METHOD_RID

	UPDATE AUDIT_FORECAST
	SET METHOD_RID = - 1
	WHERE METHOD_RID = @METHOD_RID /* TT#1389 - stodd */

	-- End TT#994
	-- Begin TT#1401 - GTaylor - Reservation Stores - Delete Method Override IMO
	DELETE METHOD_OVERRIDE_IMO
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	-- End TT#1401
	DELETE METHOD
	WITH (ROWLOCK)
	WHERE METHOD_RID = @METHOD_RID

	IF @RETURN_ROWCOUNT = 1 SELECT @@ROWCOUNT;

END
GO


