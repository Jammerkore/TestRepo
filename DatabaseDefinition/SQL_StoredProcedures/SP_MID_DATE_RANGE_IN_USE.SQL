--dv =============================================
--dv Modified date: 2/18/2014
--dv Flags: REFERENCED_FROM_SQL_ONLY
--dv Description:	Reads objects that use the date range
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_DATE_RANGE_IN_USE] 
	@cdrName VARCHAR(250)
AS
BEGIN
	IF EXISTS (
			SELECT *
			FROM dbo.sysobjects
			WHERE id = object_id(N'#temp')
				AND OBJECTPROPERTY(id, N'IsUserTable') = 1
			)
		DROP TABLE #temp

	DECLARE @cdrRid INT

	-- create a temp table of all eligibility settings
	CREATE TABLE #temp (
		TABLE_NAME VARCHAR(50) NULL,
		METHOD_NAME VARCHAR(50) NULL,
		KEY1 INT NULL,
		KEY2 INT NULL,
		KEY3 INT NULL,
		KEY4 INT NULL,
		KEY5 INT NULL
		)

	SELECT @cdrRid = CDR_RID
	FROM CALENDAR_DATE_RANGE
	WHERE CDR_NAME = @cdrName;

	INSERT INTO #temp
	SELECT 'DAILY_PERCENTAGES',
		NULL,
		HN_RID,
		ST_RID,
		CDR_RID,
		NULL,
		NULL
	FROM DAILY_PERCENTAGES
	WHERE CDR_RID = @cdrRid;

	INSERT INTO #temp
	SELECT 'FWOS_MODIFIER_MODEL_ENTRY',
		mm.FWOSMOD_ID,
		mme.FWOSMOD_RID,
		mme.FWOSMOD_SEQUENCE,
		NULL,
		NULL,
		NULL
	FROM FWOS_MODIFIER_MODEL_ENTRY mme,
		FWOS_MODIFIER_MODEL mm
	WHERE mme.CDR_RID = @cdrRid
		AND mme.FWOSMOD_RID = mm.FWOSMOD_RID;

	INSERT INTO #temp
	SELECT 'GROUP_LEVEL_BASIS',
		m.METHOD_NAME,
		glb.METHOD_RID,
		glb.SGL_RID,
		glb.BASIS_SEQ,
		NULL,
		NULL
	FROM GROUP_LEVEL_BASIS glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	--select * from HEADER_ASSORTMENT_BASIS where CDR_RID = @cdrRid;
	INSERT INTO #temp
	SELECT 'METHOD_COPY_BASIS_DETAIL',
		m.METHOD_NAME,
		glb.METHOD_RID,
		glb.SGL_RID,
		glb.DETAIL_SEQ,
		NULL,
		NULL
	FROM METHOD_COPY_BASIS_DETAIL glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_COPY_FORECAST',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM METHOD_COPY_FORECAST glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_EXPORT',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM METHOD_EXPORT glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_GENERAL_ALLOCATION',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM METHOD_GENERAL_ALLOCATION glb,
		METHOD m
	WHERE SHIP_TO_CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	--select * from METHOD_GEN_ASSORT_BASIS where HORIZON_CDR_RID = @cdrRid;
	INSERT INTO #temp
	SELECT 'METHOD_GLOBAL_UNLOCK',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM METHOD_GLOBAL_UNLOCK glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_MATRIX',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM METHOD_MATRIX glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_MATRIX_BASIS_DETAILS',
		m.METHOD_NAME,
		glb.METHOD_RID,
		glb.SEQ_ID,
		NULL,
		NULL,
		NULL
	FROM METHOD_MATRIX_BASIS_DETAILS glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_MOD_SALES',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM METHOD_MOD_SALES glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_SIZE_NEED_ALLOCATION',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM METHOD_SIZE_NEED_ALLOCATION glb,
		METHOD m
	WHERE BEGIN_CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_SPREAD_BASIS_DETAIL',
		m.METHOD_NAME,
		glb.METHOD_RID,
		glb.DETAIL_SEQ,
		NULL,
		NULL,
		NULL
	FROM METHOD_SPREAD_BASIS_DETAIL glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_VELOCITY',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM METHOD_VELOCITY glb,
		METHOD m
	WHERE (
			OTS_BEGIN_CDR_RID = @cdrRid
			OR OTS_SHIP_TO_CDR_RID = @cdrRid
			)
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'METHOD_VELOCITY_BASIS',
		m.METHOD_NAME,
		glb.METHOD_RID,
		glb.BASIS_SEQUENCE,
		NULL,
		NULL,
		NULL
	FROM METHOD_VELOCITY_BASIS glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'NODE_STOCK_MIN_MAX',
		NULL,
		glb.HN_RID,
		glb.SGL_RID,
		glb.BOUNDARY,
		glb.CDR_RID,
		NULL
	FROM NODE_STOCK_MIN_MAX glb
	WHERE CDR_RID = @cdrRid;

	INSERT INTO #temp
	SELECT 'OTS_PLAN',
		m.METHOD_NAME,
		glb.METHOD_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM OTS_PLAN glb,
		METHOD m
	WHERE CDR_RID = @cdrRid
		AND glb.METHOD_RID = m.METHOD_RID;

	INSERT INTO #temp
	SELECT 'PRIORITY_SHIPPING_ENTRY',
		NULL,
		glb.EM_RID,
		glb.PRI_SHIP_EM_SEQUENCE,
		NULL,
		NULL,
		NULL
	FROM PRIORITY_SHIPPING_ENTRY glb
	WHERE CDR_RID = @cdrRid;

	INSERT INTO #temp
	SELECT 'SALES_ELIGIBILITY_ENTRY',
		NULL,
		glb.EM_RID,
		glb.SALES_EM_SEQUENCE,
		NULL,
		NULL,
		NULL
	FROM SALES_ELIGIBILITY_ENTRY glb
	WHERE CDR_RID = @cdrRid;

	INSERT INTO #temp
	SELECT 'SALES_MODIFIER_MODEL_ENTRY',
		NULL,
		glb.SLSMOD_RID,
		glb.SLSMOD_SEQUENCE,
		NULL,
		NULL,
		NULL
	FROM SALES_MODIFIER_MODEL_ENTRY glb
	WHERE CDR_RID = @cdrRid;

	INSERT INTO #temp
	SELECT 'STOCK_ELIGIBILITY_ENTRY',
		NULL,
		glb.EM_RID,
		glb.STOCK_EM_SEQUENCE,
		NULL,
		NULL,
		NULL
	FROM STOCK_ELIGIBILITY_ENTRY glb
	WHERE CDR_RID = @cdrRid;

	INSERT INTO #temp
	SELECT 'STOCK_MODIFIER_MODEL_ENTRY',
		NULL,
		glb.STKMOD_RID,
		glb.STKMOD_SEQUENCE,
		NULL,
		NULL,
		NULL
	FROM STOCK_MODIFIER_MODEL_ENTRY glb
	WHERE CDR_RID = @cdrRid;

	INSERT INTO #temp
	SELECT 'TASK_ALLOCATE_DETAIL',
		m.TASKLIST_NAME,
		glb.TASK_SEQUENCE,
		glb.TASKLIST_RID,
		glb.ALLOCATE_SEQUENCE,
		glb.DETAIL_SEQUENCE,
		NULL
	FROM TASK_ALLOCATE_DETAIL glb,
		TASKLIST m
	WHERE EXECUTE_CDR_RID = @cdrRid
		AND glb.TASKLIST_RID = m.TASKLIST_RID;

	INSERT INTO #temp
	SELECT 'TASK_FORECAST_BALANCE_DETAIL',
		m.TASKLIST_NAME,
		glb.TASK_SEQUENCE,
		glb.TASKLIST_RID,
		glb.FORECAST_BALANCE_SEQUENCE,
		glb.DETAIL_SEQUENCE,
		NULL
	FROM TASK_FORECAST_BALANCE_DETAIL glb,
		TASKLIST m
	WHERE EXECUTE_CDR_RID = @cdrRid
		AND glb.TASKLIST_RID = m.TASKLIST_RID;

	INSERT INTO #temp
	SELECT 'TASK_FORECAST_DETAIL',
		m.TASKLIST_NAME,
		glb.TASK_SEQUENCE,
		glb.TASKLIST_RID,
		glb.FORECAST_SEQUENCE,
		glb.DETAIL_SEQUENCE,
		NULL
	FROM TASK_FORECAST_DETAIL glb,
		TASKLIST m
	WHERE EXECUTE_CDR_RID = @cdrRid
		AND glb.TASKLIST_RID = m.TASKLIST_RID;

	INSERT INTO #temp
	SELECT 'TASK_ROLLUP',
		m.TASKLIST_NAME,
		glb.TASK_SEQUENCE,
		glb.TASKLIST_RID,
		glb.ROLLUP_SEQUENCE,
		NULL,
		NULL
	FROM TASK_ROLLUP glb,
		TASKLIST m
	WHERE ROLLUP_CDR_RID = @cdrRid
		AND glb.TASKLIST_RID = m.TASKLIST_RID;

	INSERT INTO #temp
	SELECT 'USER_ALLOCATION',
		m.USER_NAME,
		glb.USER_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM USER_ALLOCATION glb,
		APPLICATION_USER m
	WHERE (
			BEGIN_CDR_RID = @cdrRid
			OR END_CDR_RID = @cdrRid
			)
		AND glb.USER_RID = m.USER_RID;

	INSERT INTO #temp
	SELECT 'USER_PLAN',
		m.USER_NAME,
		glb.USER_RID,
		NULL,
		NULL,
		NULL,
		NULL
	FROM USER_PLAN glb,
		APPLICATION_USER m
	WHERE TIME_PERIOD_CDR_RID = @cdrRid
		AND glb.USER_RID = m.USER_RID;

	INSERT INTO #temp
	SELECT 'USER_PLAN_BASIS_DETAILS',
		m.USER_NAME,
		glb.USER_RID,
		glb.BASIS_RID,
		glb.SEQ_ID,
		NULL,
		NULL
	FROM USER_PLAN_BASIS_DETAILS glb,
		APPLICATION_USER m
	WHERE CDR_RID = @cdrRid
		AND glb.USER_RID = m.USER_RID;

	SELECT METHOD_NAME 'Method|Task|User Name',
		TABLE_NAME,
		KEY1,
		KEY2,
		KEY3,
		KEY4,
		KEY5
	FROM #temp

	DROP TABLE #temp
END
GO


