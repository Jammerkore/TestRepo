--dv =============================================
--dv Create date:	9/20/2013
--dv Modified date: 2/18/2014
--dv Flags: REFERENCED_FROM_SQL_ONLY
--dv Description: Utility stored procedure.  Intended for one-time use after 5.21 Post Conversion has been installed.
--dv			  Removes rows with null values from the SIZE_CONSTRAINT_MINMAX table
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_SIZE_CONST_MINMAX_DELETE_NULLS] 
	@RC INT OUTPUT
AS
BEGIN
	IF EXISTS (
			SELECT *
			FROM dbo.sysobjects
			WHERE id = object_id(N'[dbo].[SIZE_CONSTRAINT_MINMAX_COPY]')
				AND OBJECTPROPERTY(id, N'IsUserTable') = 1
			)
	BEGIN
		TRUNCATE TABLE dbo.SIZE_CONSTRAINT_MINMAX_COPY

		DROP TABLE dbo.SIZE_CONSTRAINT_MINMAX_COPY
	END

	BEGIN
		SET @RC = 0

		/* COPY ROWS TO KEEP */
		BEGIN TRANSACTION

		SELECT *
		INTO dbo.SIZE_CONSTRAINT_MINMAX_COPY
		FROM dbo.SIZE_CONSTRAINT_MINMAX sglx
		WHERE SIZE_MIN IS NOT NULL
			OR SIZE_MAX IS NOT NULL
			OR SIZE_MULT IS NOT NULL

		COMMIT

		/* TRUNCATE ORIGINAL TABLE AND RE-COPY INTO IT THE ROWS TO KEEP */
		BEGIN TRANSACTION

		TRUNCATE TABLE SIZE_CONSTRAINT_MINMAX

		INSERT INTO dbo.SIZE_CONSTRAINT_MINMAX
		SELECT *
		FROM dbo.SIZE_CONSTRAINT_MINMAX_COPY

		SET @RC = @@ROWCOUNT

		COMMIT

		/* TRUNCATE AND DROP "COPY" TABLE */
		BEGIN TRANSACTION

		TRUNCATE TABLE SIZE_CONSTRAINT_MINMAX_COPY

		DROP TABLE SIZE_CONSTRAINT_MINMAX_COPY

		COMMIT

		/* Remove unneccessary records */
		BEGIN TRANSACTION

		DELETE
		FROM dbo.SIZE_CONSTRAINT_MINMAX
		WHERE SGL_RID NOT IN (
				SELECT SGL_RID
				FROM STORE_GROUP_LEVEL
				)

		DELETE
		FROM dbo.SIZE_CONSTRAINT_GRPLVL
		WHERE SGL_RID NOT IN (
				SELECT SGL_RID
				FROM STORE_GROUP_LEVEL
				)

		COMMIT
	END

	RETURN @RC
END
GO


