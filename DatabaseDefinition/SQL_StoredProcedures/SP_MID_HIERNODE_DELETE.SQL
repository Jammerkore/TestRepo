--dv =============================================
--dv Modified date:	8/11/2015
--dv Description:	Deletes hierarchy node
--dv History:		TT#1268-MD - RMatelic - 5.4 Merge
--dv                TT#1696-MD - RMatelic Data Layer Request - HIER_NODE_DELETE
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_HIERNODE_DELETE] 
	@HN_RID INT
AS
BEGIN
	--BEGIN TT#3408-VStuart-PROD Virtual lock hung process-ANFUser
	DECLARE @err_message NVARCHAR(255)

	--if '@HN_RID < 100' exist return SEV 11 error to abort stored procedure.
	IF (@HN_RID < 100)
	BEGIN
		SET @err_message = 'Attempting to delete invalid Hierarchy Node: ' + convert(VARCHAR, @HN_RID)
		RAISERROR (	@err_message, 11, 1	)
		RETURN
	END
	--END TT#3408-VStuart-PROD Virtual lock hung process-ANFUser

	DECLARE @RID INT,
		@SEQ INT,
		@Tables INT,
		@TableNumber INT
	DECLARE @methodtable TABLE (RID INT)
	DECLARE @audittable TABLE (RID INT)
	declare @overridetable table (RID int)

	SELECT @Tables = STORE_TABLE_COUNT
	FROM SYSTEM_OPTIONS

	SELECT @TableNumber = @HN_RID % @Tables

	-- security
	DELETE MID_ENQUEUE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE SECURITY_GROUP_HIERARCHY_NODE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE SECURITY_USER_HIERARCHY_NODE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	-- node properties
	DELETE DAILY_PERCENTAGES
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE DAILY_PERCENTAGES_DEFAULTS
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE PURGE_CRITERIA
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE SELL_THRU
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE STORE_CAPACITY
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE SIMILAR_STORES
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE STORE_ELIGIBILITY
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE STORE_GRADES
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE NODE_STOCK_MIN_MAX
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE VELOCITY_GRADE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	UPDATE HIERARCHY_NODE
	WITH (ROWLOCK)

	SET OTS_FORECAST_LEVEL_ANCHOR_NODE = NULL
	WHERE OTS_FORECAST_LEVEL_ANCHOR_NODE = @HN_RID

	/* Begin TT#155 - JScott - Add Size Curve info to Node Properties */
	DELETE NODE_SIZE_CURVE_CRITERIA_DEFAULT
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	EXEC SP_MID_ND_SZ_CRV_CRIT_DELALL @HN_RID, 0

	DELETE NODE_SIZE_CURVE_CRITERIA_DEFAULT
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE NODE_SIZE_CURVE_TOLERANCE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE NODE_SIZE_CURVE_SIMILAR_STORE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	/* End TT#155 - JScott - Add Size Curve info to Node Properties */
	/* Begin TT#483 - JScott - Add Size Lost Sales criteria and processing */
	DELETE NODE_SIZE_OUTOFSTOCK_QUANTITY
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE NODE_SIZE_OUTOFSTOCK_GRPLVL
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE NODE_SIZE_OUTOFSTOCK
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	/* End TT#483 - JScott - Add Size Lost Sales criteria and processing */
	DELETE NODE_IMO
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID -- TT#2486 - JSmith - Unable to delete a folder from My Hierarchy

	-- variable data
	DELETE CHAIN_FORECAST_WEEK
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE CHAIN_FORECAST_WEEK_LOCK
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE CHAIN_HISTORY_WEEK
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE STORE_FORECAST_WEEK_LOCK
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	IF @TableNumber = 0
	BEGIN
		DELETE STORE_FORECAST_WEEK0
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY0
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK0
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 1
	BEGIN
		DELETE STORE_FORECAST_WEEK1
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY1
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK1
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 2
	BEGIN
		DELETE STORE_FORECAST_WEEK2
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY2
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK2
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 3
	BEGIN
		DELETE STORE_FORECAST_WEEK3
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY3
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK3
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 4
	BEGIN
		DELETE STORE_FORECAST_WEEK4
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY4
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK4
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 5
	BEGIN
		DELETE STORE_FORECAST_WEEK5
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY5
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK5
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 6
	BEGIN
		DELETE STORE_FORECAST_WEEK6
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY6
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK6
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 7
	BEGIN
		DELETE STORE_FORECAST_WEEK7
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY7
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK7
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 8
	BEGIN
		DELETE STORE_FORECAST_WEEK8
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY8
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK8
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END
	ELSE IF @TableNumber = 9
	BEGIN
		DELETE STORE_FORECAST_WEEK9
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_DAY9
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID

		DELETE STORE_HISTORY_WEEK9
		WITH (ROWLOCK)
		WHERE HN_RID = @HN_RID
	END

	DELETE STORE_INTRANSIT
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE STORE_EXTERNAL_INTRANSIT
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	/* Begin TT#104 MD - JSmith -Delete of node fails with  invalid name error */
	--delete VSW_ONHNAND_REVERSE with (rowlock) where HN_RID = @HN_RID     -- TT#2225 - JElllis - AnF VSW FWOS Enhancement
	DELETE VSW_REVERSE_ON_HAND
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	/* End TT#104 MD */
	--delete STORE_DAY_HISTORY_BIN with (rowlock) where HN_RID = @HN_RID   -- TT#1427 - JSmith - Delete of node fails
	--delete STORE_WEEK_HISTORY_BIN with (rowlock) where HN_RID = @HN_RID  -- TT#1427 - JSmith - Delete of node fails
	-- other

	/* Begin TT#1313-MD -jsobek -Header Filters */
	--UPDATE AL_WRKSP_FILTER
	--WITH (ROWLOCK)
	--SET HN_RID = NULL
	--WHERE HN_RID = @HN_RID

	--UPDATE GRID_VIEW_FILTER
	--WITH (ROWLOCK)
	--SET HN_RID = NULL
	--WHERE HN_RID = @HN_RID -- TT#63 MD - JSmith - Error deleting user with Purge

	--UPDATE ASRT_WRKSP_FILTER
	--WITH (ROWLOCK)
	--SET HN_RID = NULL
	--WHERE HN_RID = @HN_RID

	UPDATE FILTER_CONDITION WITH (ROWLOCK)
	SET HEADER_HN_RID=NULL
	WHERE HEADER_HN_RID = @HN_RID
	/* End TT#1313-MD -jsobek -Header Filters */

	UPDATE USER_ALLOCATION
	WITH (ROWLOCK)

	SET HN_RID = NULL
	WHERE HN_RID = @HN_RID

	UPDATE USER_ALLOCATION_BASIS
	WITH (ROWLOCK)

	SET BASIS_HN_RID = NULL
	WHERE BASIS_HN_RID = @HN_RID

	DELETE USER_PLAN_BASIS_DETAILS
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	UPDATE USER_PLAN
	WITH (ROWLOCK)

	SET CHAIN_HN_RID = NULL
	WHERE CHAIN_HN_RID = @HN_RID

	UPDATE USER_PLAN
	WITH (ROWLOCK)

	SET STORE_HN_RID = NULL
	WHERE STORE_HN_RID = @HN_RID

	DELETE GROUP_LEVEL_NODE_FUNCTION
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	-- tasks
	--update TASK_ALLOCATE with (rowlock) set HN_RID = null where HN_RID = @HN_RID
	EXEC SP_MID_HIERNODE_TASK_DELETE @HN_RID

	-- methods
	-- delete references
	--delete METHOD_VELOCITY_BASIS with (rowlock) where BASIS_HN_RID = @HN_RID  
	DELETE DEFAULT_OTS_PLAN_METHOD
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE METHOD_COPY_BASIS_DETAIL
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE GROUP_LEVEL_BASIS
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	-- Begin TT#4203 - JSmith - Unable to delete node during Reclass because in use
	-- delete all overrides
 --       insert into @overridetable select OLL_RID from OVERRIDE_LL_MODEL_HEADER with (nolock) where HN_RID = @HN_RID
 --       select top 1 @RID = RID from @overridetable
 --       while @@rowcount <> 0
 --       begin
 --         delete OVERRIDE_LL_MODEL_DETAIL with (rowlock) where OLL_RID = @RID
 --         delete OVERRIDE_LL_MODEL_HEADER with (rowlock) where OLL_RID = @RID
 --         delete @overridetable where RID = @RID
 --         select top 1 @RID = RID from @overridetable
 --       end

	--DELETE OVERRIDE_LL_MODEL_DETAIL
	--WITH (ROWLOCK)
	--WHERE HN_RID = @HN_RID

	--DELETE OVERRIDE_LL_MODEL_HEADER
	--WITH (ROWLOCK)
	--WHERE HN_RID = @HN_RID
	-- End TT#4203 - JSmith - Unable to delete node during Reclass because in use

	-- set data nodes to null 
	UPDATE METHOD_VELOCITY_BASIS
	WITH (ROWLOCK)

	SET BASIS_HN_RID = NULL
	WHERE BASIS_HN_RID = @HN_RID

	UPDATE METHOD_FILL_SIZE_HOLES
	WITH (ROWLOCK)

	SET MERCH_HN_RID = NULL
	WHERE MERCH_HN_RID = @HN_RID

	UPDATE METHOD_FILL_SIZE_HOLES
	WITH (ROWLOCK)

	SET GENCURVE_HN_RID = NULL
	WHERE GENCURVE_HN_RID = @HN_RID

	UPDATE METHOD_FILL_SIZE_HOLES
	WITH (ROWLOCK)

	SET GENCONSTRAINT_HN_RID = NULL
	WHERE GENCONSTRAINT_HN_RID = @HN_RID

	UPDATE METHOD_GENERAL_ALLOCATION
	WITH (ROWLOCK)

	SET MERCH_HN_RID = NULL
	WHERE MERCH_HN_RID = @HN_RID

	UPDATE METHOD_VELOCITY
	WITH (ROWLOCK)

	SET OTS_PLAN_HN_RID = NULL
	WHERE OTS_PLAN_HN_RID = @HN_RID

	UPDATE METHOD_OVERRIDE
	WITH (ROWLOCK)

	SET MERCH_HN_RID = NULL
	WHERE MERCH_HN_RID = @HN_RID

	UPDATE METHOD_OVERRIDE
	WITH (ROWLOCK)

	SET ON_HAND_HN_RID = NULL
	WHERE ON_HAND_HN_RID = @HN_RID

	-- BEGIN TT#708-MD - Stodd - Group Allocation Prototype. 
	UPDATE METHOD_GROUP_ALLOCATION
	WITH (ROWLOCK)
	
	SET MERCH_HN_RID = NULL 
	WHERE MERCH_HN_RID = @HN_RID
    
	UPDATE METHOD_GROUP_ALLOCATION
	WITH (ROWLOCK) 
	
	SET ON_HAND_HN_RID = NULL 
	WHERE ON_HAND_HN_RID = @HN_RID
	
	UPDATE METHOD_GROUP_ALLOCATION 
	WITH (ROWLOCK) 
	
	SET IB_MERCH_HN_RID = NULL 
	WHERE IB_MERCH_HN_RID = @HN_RID
	-- END TT#708-MD - Stodd - Group Allocation Prototype

	UPDATE METHOD_SIZE_NEED
	WITH (ROWLOCK)

	SET MERCH_HN_RID = NULL
	WHERE MERCH_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_NEED
	WITH (ROWLOCK)

	SET GENCURVE_HN_RID = NULL
	WHERE GENCURVE_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_NEED
	WITH (ROWLOCK)

	SET GENCONSTRAINT_HN_RID = NULL
	WHERE GENCONSTRAINT_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_BASIS_ALLOCATION
	WITH (ROWLOCK)

	SET GENCURVE_HN_RID = NULL
	WHERE GENCURVE_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_BASIS_ALLOCATION
	WITH (ROWLOCK)

	SET GENCONSTRAINT_HN_RID = NULL
	WHERE GENCONSTRAINT_HN_RID = @HN_RID

	/* Begin TT#155 - JScott - Add Size Curve info to Node Properties */
	UPDATE METHOD_SIZE_CURVE_MRCH_BAS_DET
	WITH (ROWLOCK)

	SET HN_RID = NULL
	WHERE HN_RID = @HN_RID

	/* End TT#155 - JScott - Add Size Curve info to Node Properties */
	UPDATE GROUP_LEVEL_FUNCTION
	WITH (ROWLOCK)

	SET SEASON_HN_RID = NULL
	WHERE SEASON_HN_RID = @HN_RID

	--UPDATE OVERRIDE_LL_MODEL_HEADER
	--WITH (ROWLOCK)

	--SET HIGH_LEVEL_HN_RID = NULL
	--WHERE HIGH_LEVEL_HN_RID = @HN_RID

	-- delete methods with node as key
	INSERT INTO @methodtable
	SELECT METHOD_RID
	FROM METHOD_COPY_FORECAST WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	INSERT INTO @methodtable
	SELECT METHOD_RID
	FROM METHOD_MATRIX WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	INSERT INTO @methodtable
	SELECT METHOD_RID
	FROM METHOD_SPREAD_FORECAST WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	INSERT INTO @methodtable
	SELECT METHOD_RID
	FROM OTS_PLAN WITH (NOLOCK)
	WHERE PLAN_HN_RID = @HN_RID

	INSERT INTO @methodtable
	SELECT METHOD_RID
	FROM METHOD_MOD_SALES WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	INSERT INTO @methodtable
	SELECT METHOD_RID
	FROM METHOD_EXPORT WITH (NOLOCK)
	WHERE HN_RID = @HN_RID
    
	/*BEGIN TT#4621 - DOConnell - Error when deleteing node 2012 from Master PO alternate hierarchy */
	INSERT INTO @methodtable
	SELECT METHOD_RID
	FROM METHOD_ROLLUP WITH (NOLOCK)
	WHERE HN_RID = @HN_RID
	/*END TT#4621 - DOConnell - Error when deleteing node 2012 from Master PO alternate hierarchy */

	-- delete all methods
	SELECT TOP 1 @RID = RID
	FROM @methodtable

	WHILE @@rowcount <> 0
	BEGIN
		EXEC SP_MID_METHOD_DELETE @RID, 0

		DELETE @methodtable
		WHERE RID = @RID

		SELECT TOP 1 @RID = RID
		FROM @methodtable
	END

	-- Begin TT#4203 - JSmith - Unable to delete node during Reclass because in use
	-- delete all overrides
        insert into @overridetable select OLL_RID from OVERRIDE_LL_MODEL_HEADER with (nolock) where HN_RID = @HN_RID
        select top 1 @RID = RID from @overridetable
        while @@rowcount <> 0
        begin
          delete OVERRIDE_LL_MODEL_DETAIL with (rowlock) where OLL_RID = @RID
		  delete OVERRIDE_LL_MODEL_HEADER with (rowlock) where OLL_RID = @RID
          delete @overridetable where RID = @RID
          select top 1 @RID = RID from @overridetable
        end

	UPDATE OVERRIDE_LL_MODEL_HEADER 
	WITH (ROWLOCK) 
	SET HIGH_LEVEL_HN_RID = null
	WHERE HN_RID = @HN_RID

	DELETE OVERRIDE_LL_MODEL_DETAIL
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	--DELETE OVERRIDE_LL_MODEL_HEADER
	--WITH (ROWLOCK)
	--WHERE HN_RID = @HN_RID
	-- End TT#4203 - JSmith - Unable to delete node during Reclass because in use

	-- delete audit information with node as key
	INSERT INTO @audittable
	SELECT AUDIT_FORECAST_RID
	FROM AUDIT_FORECAST WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	-- delete all audit information
	SELECT TOP 1 @RID = RID
	FROM @audittable

	WHILE @@rowcount <> 0
	BEGIN
		EXEC SP_MID_AUDIT_FORECAST_DELETE @RID, 0

		DELETE @audittable
		WHERE RID = @RID

		SELECT TOP 1 @RID = RID
		FROM @audittable
	END

	-- node definition
	DELETE HIER_CHAR_GROUP_JOIN
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE HIER_CHAR_JOIN
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE HIER_NODE_JOIN
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE HIER_NODE_JOIN
	WITH (ROWLOCK)
	WHERE PARENT_HN_RID = @HN_RID

	DELETE COLOR_NODE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE SIZE_NODE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE BASE_NODE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	DELETE HIERARCHY_NODE
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID
END
GO


