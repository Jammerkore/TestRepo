CREATE PROCEDURE [dbo].[SP_MID_HEADER_DELETE] 
	@HDR_RID INT,
	@RETURN_ROWCOUNT BIT = 1
AS
BEGIN
	-- delete header packs separately because cascade is inefficient
	DECLARE @t TABLE (HP INT)
	DECLARE @a TABLE (HP INT)
	DECLARE @c TABLE (HC INT)
	DECLARE @methodtable TABLE (RID INT)

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	INSERT INTO @t
	SELECT HDR_PACK_RID
	FROM HEADER_PACK
	WHERE HDR_RID = @HDR_RID

	-- make sure all associated packs in multis are cleaned up	  
	INSERT INTO @a
	SELECT HDR_PACK_RID
	FROM HEADER_PACK
	WHERE ASSOCIATED_PACK_RID IN (
			SELECT HP
			FROM @t
			)

	INSERT INTO @c
	SELECT HDR_BC_RID
	FROM HEADER_BULK_COLOR
	WHERE HDR_RID = @HDR_RID

	SET TRANSACTION ISOLATION LEVEL READ COMMITTED

	DECLARE @HP INT
	DECLARE @HC INT

	-- make sure all associated packs in multis are cleaned up	  
	SELECT TOP 1 @HP = HP
	FROM @a

	WHILE @@rowcount <> 0
	BEGIN
		EXEC dbo.SP_MID_HDRPACK_DELETE @HP, 0

		DELETE @a
		WHERE HP = @HP

		SELECT TOP 1 @HP = HP
		FROM @a
	END

	SELECT TOP 1 @HP = HP
	FROM @t

	WHILE @@rowcount <> 0
	BEGIN
		--delete PACK_ALLOCATION_BIN with (rowlock) where HDR_PACK_RID = @HP
		--delete PACK_ALLOCATION with (rowlock) where HDR_PACK_RID = @HP
		--delete PACK_RULE with (rowlock) where HDR_PACK_RID = @HP
		--delete PACK_RULE_LAYER with (rowlock) where HDR_PACK_RID = @HP
		--delete HEADER_PACK_COLOR_SIZE  with (rowlock) where HDR_PC_RID IN 
		--(SELECT HDR_PC_RID from HEADER_PACK_COLOR where HDR_PACK_RID = @HP)
		--delete HEADER_PACK_COLOR with (rowlock) where HDR_PACK_RID = @HP        
		--delete HEADER_PACK with (rowlock) where HDR_PACK_RID = @HP
		--update METHOD_RULE with (rowlock) set HDR_PACK_RID = null where HDR_PACK_RID = @HP
		EXEC dbo.SP_MID_HDRPACK_DELETE @HP, 0

		DELETE @t
		WHERE HP = @HP

		SELECT TOP 1 @HP = HP
		FROM @t
	END

	SELECT TOP 1 @HC = HC
	FROM @c

	WHILE @@rowcount <> 0
	BEGIN
		--delete BULK_COLOR_RULE with (rowlock) where HDR_BC_RID = @HC 
		--delete BULK_COLOR_RULE_LAYER with (rowlock) where HDR_BC_RID = @HC 
		--delete BULK_COLOR_SIZE_ALLOCATION where HDR_BC_RID = @HC 
		--delete BULK_COLOR_ALLOCATION where HDR_BC_RID = @HC 
		--delete COLOR_SIZE_ALLOCATION_BIN with (rowlock) where HDR_BC_RID = @HC  
		--delete COLOR_ALLOCATION_BIN with (rowlock) where HDR_BC_RID = @HC 
		--delete HEADER_BULK_COLOR_SIZE_NEED with (rowlock) where HDR_BC_RID = @HC 
		--delete HEADER_BULK_COLOR_SIZE with (rowlock) where HDR_BC_RID = @HC 
		--delete HEADER_BULK_COLOR with (rowlock) where HDR_BC_RID = @HC  
		EXEC dbo.SP_MID_HEADER_BULK_DELETE @HC, 0

		DELETE @c
		WHERE HC = @HC

		SELECT TOP 1 @HC = HC
		FROM @c
	END

	-- update methods with header as key
	UPDATE METHOD_SIZE_BASIS_ALLOCATION
	WITH (ROWLOCK)

	SET SIZE_BASIS_HDR_RID = NULL
	WHERE SIZE_BASIS_HDR_RID = @HDR_RID

	UPDATE METHOD_RULE
	WITH (ROWLOCK)

	SET HDR_RID = NULL
	WHERE HDR_RID = @HDR_RID

	-- delete header and cascade other tables 
	DELETE RECLASS_REJECTED_HEADER
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE VSW_REVERSE_ON_HAND
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID /* TT#2225 JEllis - AnF VSW FWOS Enhancement */

	--delete ARCHIVE_SUMMARY_ALLOCATION with (rowlock) where HDR_RID = @HDR_RID /* TT#370 Build Packs Enhancement */  
	--delete ARCHIVE_HEADER with (rowlock) where HDR_RID = @HDR_RID             /* TT#370 Build Packs Enhancement */
	DELETE HEADER_PACK_ROUNDING
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID /* TT#1318 Errors on multi header delete */

	DELETE BULK_RULE
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE BULK_RULE_LAYER
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	--delete BULK_ALLOCATION_BIN with (rowlock) where HDR_RID = @HDR_RID
	DELETE BULK_ALLOCATION
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE HEADER_SIZE_NEED
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE TOTAL_RULE
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE TOTAL_RULE_LAYER
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE DETAIL_RULE
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE DETAIL_RULE_LAYER
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	--delete DETAIL_ALLOCATION_BIN with (rowlock) where HDR_RID = @HDR_RID
	DELETE DETAIL_ALLOCATION
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	--delete TOTAL_ALLOCATION_BIN with (rowlock) where HDR_RID = @HDR_RID
	DELETE TOTAL_ALLOCATION
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE HEADER_STORE_GRADE_VALUES
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE HEADER_STORE_GRADE
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE USER_ALLOCATION_HEADERS
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE WORKFLOW_HISTORY
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE FILTER_BASIS_ALLOCATION
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE MASTER_HEADER
	WITH (ROWLOCK)
	WHERE SUBORD_HDR_RID = @HDR_RID

	/* Begin TT#1966-MD - JSmith - DC Fulfillment */
	DELETE MASTER_HEADER
	WITH (ROWLOCK)
	WHERE MASTER_HDR_RID = @HDR_RID

	DELETE HEADER_PACK_ASSOCIATION
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID
	/* End TT#1966-MD - JSmith - DC Fulfillment */

	DELETE HEADER_CHAR_JOIN
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE AUDIT_HEADER
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE ASSORTMENT_STYLE_CLOSED
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE ASSORTMENT_PROPERTIES_STORE_GRADE
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE ASSORTMENT_PROPERTIES_BASIS
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE ASSORTMENT_PROPERTIES
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE ASSORTMENT_STORE_SUMMARY
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE ASSORTMENT_STORE_ELIGIBILITY
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	DELETE ASSORTMENT_MATRIX_DETAIL
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	/* Begin TT#1312-MD - stodd - Group Allocation Delete is orphaning Assortment Headers on the database */
	DELETE FROM ASSORTMENT_USER_VIEW_JOIN 
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID
	/* End TT#1312-MD - stodd - Group Allocation Delete is orphaning Assortment Headers on the database */

	UPDATE METHOD_RULE
	WITH (ROWLOCK)

	SET HDR_RID = NULL
	WHERE HDR_RID = @HDR_RID

	UPDATE METHOD_SIZE_BASIS_ALLOCATION
	WITH (ROWLOCK)

	SET SIZE_BASIS_HDR_RID = NULL
	WHERE SIZE_BASIS_HDR_RID = @HDR_RID

	UPDATE METHOD_GENERAL_ALLOCATION
	WITH (ROWLOCK)

	SET GEN_ALLOC_HDR_RID = NULL
	WHERE GEN_ALLOC_HDR_RID = @HDR_RID

	DELETE HEADER
	WITH (ROWLOCK)
	WHERE HDR_RID = @HDR_RID

	IF @RETURN_ROWCOUNT = 1 SELECT @@ROWCOUNT;
END
GO


