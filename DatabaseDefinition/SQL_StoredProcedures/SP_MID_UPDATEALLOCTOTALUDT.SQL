--dv =============================================
--dv Modified date:	8/14/2014
--dv Description:	Updates total allocation
--dv History:		TT#1268 - MD - RMatelic - 5.4 Merge
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_UPDATEALLOCTOTALUDT] 
	(
	@Updt TOTAL_ALLOCATION_TYPE READONLY,
	@ReturnCode INT = - 100 OUTPUT,
	@debug INT = 0
	)
AS
IF @debug = 0
	SET NOCOUNT ON

INSERT INTO [dbo].[TOTAL_ALLOCATION] (
	HDR_RID,
	ST_RID,
	STORE_GRADE_INDEX,
	UNITS_ALLOCATED,
	UNITS_SHIPPED,
	UNITS_ALLOCATED_BY_AUTO,
	UNITS_ALLOCATED_BY_RULE,
	CHOSEN_RULE_TYPE_ID,
	CHOSEN_RULE_LAYER_ID,
	SHIP_DAY,
	NEED_DAY,
	UNIT_NEED_BEFORE,
	PERCENT_NEED_BEFORE,
	MINIMUM,
	MAXIMUM,
	PRIMARY_MAX,
	STORE_CAPACITY,
	ALLOC_STORE_DET_AUDIT_FLAGS,
	ALLOC_STORE_GEN_AUDIT_FLAGS,
	SHIPPING_STATUS_FLAGS,
	CHOSEN_RULE_UNITS,
	EXCEED_CAPACITY_PERCENT,
	IMO_MAX_VALUE,
	IMO_MIN_SHIP_QTY,
	IMO_PCT_PK_THRSHLD,
	ITEM_UNITS_ALLOCATED
	)
SELECT HDR_RID,
	ST_RID,
	STORE_GRADE_INDEX,
	UNITS_ALLOCATED,
	UNITS_SHIPPED,
	UNITS_ALLOCATED_BY_AUTO,
	UNITS_ALLOCATED_BY_RULE,
	CHOSEN_RULE_TYPE_ID,
	CHOSEN_RULE_LAYER_ID,
	SHIP_DAY,
	NEED_DAY,
	UNIT_NEED_BEFORE,
	PERCENT_NEED_BEFORE,
	MINIMUM,
	MAXIMUM,
	PRIMARY_MAX,
	STORE_CAPACITY,
	ALLOC_STORE_DET_AUDIT_FLAGS,
	ALLOC_STORE_GEN_AUDIT_FLAGS,
	SHIPPING_STATUS_FLAGS,
	CHOSEN_RULE_UNITS,
	EXCEED_CAPACITY_PERCENT,
	IMO_MAX_VALUE,
	IMO_MIN_SHIP_QTY,
	IMO_PCT_PK_THRSHLD,
	ITEM_UNITS_ALLOCATED
FROM @Updt
WHERE (STORE_GRADE_INDEX IS NOT NULL)
   OR (UNITS_ALLOCATED IS NOT NULL)  
   OR (UNITS_SHIPPED IS NOT NULL) 
   OR (UNITS_ALLOCATED_BY_AUTO IS NOT NULL)
   OR (UNITS_ALLOCATED_BY_RULE IS NOT NULL)
   OR (CHOSEN_RULE_TYPE_ID IS NOT NULL)
   OR (CHOSEN_RULE_LAYER_ID IS NOT NULL)
   OR (SHIP_DAY IS NOT NULL)
   OR (NEED_DAY IS NOT NULL)
   OR (UNIT_NEED_BEFORE IS NOT NULL AND UNIT_NEED_BEFORE > 0)
   OR (PERCENT_NEED_BEFORE IS NOT NULL AND PERCENT_NEED_BEFORE > 0)
   OR (MINIMUM IS NOT NULL)
   OR (MAXIMUM IS NOT NULL)
   OR (PRIMARY_MAX IS NOT NULL)
   OR (STORE_CAPACITY IS NOT NULL)
   OR (ALLOC_STORE_DET_AUDIT_FLAGS IS NOT NULL AND ALLOC_STORE_DET_AUDIT_FLAGS > 0)
   OR (ALLOC_STORE_GEN_AUDIT_FLAGS IS NOT NULL AND ALLOC_STORE_GEN_AUDIT_FLAGS > 0)
   OR (SHIPPING_STATUS_FLAGS IS NOT NULL AND SHIPPING_STATUS_FLAGS > 0)
   OR (CHOSEN_RULE_UNITS IS NOT NULL)
   OR (EXCEED_CAPACITY_PERCENT IS NOT NULL AND EXCEED_CAPACITY_PERCENT > -1)
   OR (IMO_MAX_VALUE IS NOT NULL)
   OR (IMO_MIN_SHIP_QTY IS NOT NULL)
   OR (IMO_PCT_PK_THRSHLD IS NOT NULL)
   OR (ITEM_UNITS_ALLOCATED IS NOT NULL)

SET @ReturnCode = @@rowcount

RETURN @ReturnCode
GO


