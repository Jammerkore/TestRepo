CREATE PROCEDURE [dbo].[SP_MID_STORE_DELETE_SIM_STORE_CLEANUP] 
AS
BEGIN
	DECLARE @hnRid INT,
		@stRid INT,
		@simStoreType INT
	DECLARE @return_value INT

	DECLARE C1 CURSOR
	FOR
	SELECT HN_RID,
		ST_RID,
		SIMILAR_STORE_TYPE
	FROM STORE_ELIGIBILITY
	WHERE SIMILAR_STORE_TYPE <> 0

	OPEN C1

	FETCH NEXT
	FROM C1
	INTO @hnRid,
		@stRid,
		@simStoreType

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT *
		FROM SIMILAR_STORES
		WHERE ST_RID = @stRid
			AND HN_RID = @hnRid

		IF @@ROWCOUNT = 0
		BEGIN
			UPDATE STORE_ELIGIBILITY
			SET SIMILAR_STORE_TYPE = 0,
				SIMILAR_STORE_RATIO = 0,
				UNTIL_DATE = NULL
			WHERE ST_RID = @stRid
				AND HN_RID = @hnRid
		END

		FETCH NEXT
		FROM C1
		INTO @hnRid,
			@stRid,
			@simStoreType
	END

	CLOSE C1

	DEALLOCATE C1
END
GO


