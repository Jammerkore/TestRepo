CREATE PROCEDURE [dbo].[SP_MID_UPDATE_EXT_INTRANSIT] 
	@HN_RID INT,
	@TIME_ID INT,
	@ST_RID INT,
	@VALUE INT,
	@INCREMENT CHAR
AS
/* This stored procedure must be replicated for each STORE_EXTERNAL_INTRANSIT table*/
BEGIN
	DECLARE @UNITS FLOAT

	IF EXISTS (
			SELECT HN_RID,
				TIME_ID,
				ST_RID,
				UNITS
			FROM STORE_EXTERNAL_INTRANSIT
			WHERE HN_RID = @HN_RID
				AND TIME_ID = @TIME_ID
				AND ST_RID = @ST_RID
			)
	BEGIN
		SELECT @UNITS = UNITS
		FROM STORE_EXTERNAL_INTRANSIT
		WHERE HN_RID = @HN_RID
			AND TIME_ID = @TIME_ID
			AND ST_RID = @ST_RID

		DECLARE @VAL INT

		IF (@INCREMENT = 'Y')
		BEGIN
			SET @VAL = @VALUE + @UNITS
		END
		ELSE
		BEGIN
			SET @VAL = @VALUE
		END

		IF (@VAL < 0)
		BEGIN
			SET @VAL = 0
		END

		UPDATE STORE_EXTERNAL_INTRANSIT
		SET UNITS = @VAL
		WHERE HN_RID = @HN_RID
			AND TIME_ID = @TIME_ID
			AND ST_RID = @ST_RID
	END
	ELSE
	BEGIN
		IF (@VALUE < 0)
		BEGIN
			INSERT INTO STORE_EXTERNAL_INTRANSIT (
				HN_RID,
				TIME_ID,
				ST_RID,
				UNITS
				)
			VALUES (
				@HN_RID,
				@TIME_ID,
				@ST_RID,
				0
				)
		END
		ELSE
		BEGIN
			INSERT INTO STORE_EXTERNAL_INTRANSIT (
				HN_RID,
				TIME_ID,
				ST_RID,
				UNITS
				)
			VALUES (
				@HN_RID,
				@TIME_ID,
				@ST_RID,
				@VALUE
				)
		END
	END
	SELECT @@ROWCOUNT;
END
GO


