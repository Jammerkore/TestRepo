--dv =============================================
--dv Create date:	12/05/2016
--dv Description:	Determines if any nodes owned by a user are In Use
--dv                This stored procedure should mimic Hierarchy Node In Use queries 
--dv                for items not owned by the user (@PH_OWNER) 
--dv =============================================
CREATE PROCEDURE [dbo].[MID_PRODUCT_HIERARCHY_IN_USE_FROM_OWNER] 
	@PH_OWNER int
AS
BEGIN
	SET NOCOUNT ON;

	declare @nodes table (HN_RID int);
	declare @inUse table (NODE_ID varchar(250), ITEM_TYPE varchar(50), ITEM_NAME varchar(100), ITEM_OWNER varchar(50));

	-- Get all users nodes
	INSERT INTO @nodes
	SELECT HN_RID
	FROM PRODUCT_HIERARCHY ph WITH (NOLOCK)
	JOIN HIERARCHY_NODE hn WITH (NOLOCK) ON hn.HOME_PH_RID = ph.PH_RID
	WHERE PH_OWNER = @PH_OWNER

	-- Check headers
	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (h.ON_HAND_HNRID), 'Header', h.HDR_ID, 'Global'
	FROM @nodes n
	JOIN HEADER h WITH (NOLOCK) ON h.ON_HAND_HNRID = n.HN_RID
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (h.PLAN_HNRID), 'Header', h.HDR_ID, 'Global' 
	FROM @nodes n
	JOIN HEADER h WITH (NOLOCK) ON h.PLAN_HNRID = n.HN_RID
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (h.STYLE_HNRID), 'Header', h.HDR_ID, 'Global'
	FROM @nodes n
	JOIN HEADER h WITH (NOLOCK) ON h.STYLE_HNRID = n.HN_RID
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (h.GRADE_INVENTORY_HNRID), 'Header', h.HDR_ID, 'Global' 
	FROM @nodes n
	JOIN HEADER h WITH (NOLOCK) ON h.GRADE_INVENTORY_HNRID = n.HN_RID

	-- Assortment

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.ANCHOR_HN_RID), 'Assortment', h.HDR_ID, 'Global'
	FROM @nodes n
	JOIN ASSORTMENT_PROPERTIES t WITH (NOLOCK) ON t.ANCHOR_HN_RID = n.HN_RID
	JOIN HEADER h WITH (NOLOCK) ON h.HDR_RID = t.HDR_RID
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HDR_RID), 'Assortment', h.HDR_ID, 'Global' 
	FROM @nodes n
	JOIN ASSORTMENT_PROPERTIES_BASIS t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN HEADER h WITH (NOLOCK) ON h.HDR_RID = t.HDR_RID

	-- OTS Plan Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200017), m.METHOD_NAME, au.USER_NAME
	FROM @nodes n
	JOIN DEFAULT_OTS_PLAN_METHOD t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200017), m.METHOD_NAME, au.USER_NAME
	FROM @nodes n
	JOIN GROUP_LEVEL_BASIS t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.SEASON_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200017), m.METHOD_NAME, au.USER_NAME 
	FROM @nodes n
	JOIN GROUP_LEVEL_FUNCTION t WITH (NOLOCK) ON t.SEASON_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200017), m.METHOD_NAME, au.USER_NAME 
	FROM @nodes n
	JOIN GROUP_LEVEL_NODE_FUNCTION t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.PLAN_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200017), m.METHOD_NAME, au.USER_NAME  
	FROM @nodes n
	JOIN OTS_PLAN t WITH (NOLOCK) ON t.PLAN_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Copy Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200058), m.METHOD_NAME, au.USER_NAME  
	FROM @nodes n
	JOIN METHOD_COPY_FORECAST t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200058), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_COPY_BASIS_DETAIL t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Export Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200067), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_EXPORT t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Fill Size Holes Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.GENCONSTRAINT_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200018), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_FILL_SIZE_HOLES t WITH (NOLOCK) ON t.GENCONSTRAINT_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.GENCURVE_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200018), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_FILL_SIZE_HOLES t WITH (NOLOCK) ON t.GENCURVE_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.IB_MERCH_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200018), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_FILL_SIZE_HOLES t WITH (NOLOCK) ON t.IB_MERCH_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.MERCH_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200018), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_FILL_SIZE_HOLES t WITH (NOLOCK) ON t.MERCH_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- General Allocation Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.MERCH_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200015), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_GENERAL_ALLOCATION t WITH (NOLOCK) ON t.MERCH_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Global Lock Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200085), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_GLOBAL_LOCK t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Global Unlock Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200077), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_GLOBAL_UNLOCK t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Matrix Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200054), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_MATRIX t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Modify Sales Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200068), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_MOD_SALES t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Override Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.IB_MERCH_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200019), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_OVERRIDE t WITH (NOLOCK) ON t.IB_MERCH_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.MERCH_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200019), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_OVERRIDE t WITH (NOLOCK) ON t.MERCH_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.ON_HAND_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200019), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_OVERRIDE t WITH (NOLOCK) ON t.ON_HAND_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Rollup Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200079), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_ROLLUP t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Size Basis Allocation Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.GENCONSTRAINT_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200042), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_SIZE_BASIS_ALLOCATION t WITH (NOLOCK) ON t.GENCONSTRAINT_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.GENCURVE_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200042), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_SIZE_BASIS_ALLOCATION t WITH (NOLOCK) ON t.GENCURVE_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Size Curve Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200082), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_SIZE_CURVE_MRCH_BAS_DET t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Size Need Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.GENCONSTRAINT_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200045), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_SIZE_NEED t WITH (NOLOCK) ON t.GENCONSTRAINT_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.GENCURVE_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200045), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_SIZE_NEED t WITH (NOLOCK) ON t.GENCURVE_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.IB_MERCH_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200045), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_SIZE_NEED t WITH (NOLOCK) ON t.IB_MERCH_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.MERCH_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200045), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_SIZE_NEED t WITH (NOLOCK) ON t.MERCH_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Spread Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200060), m.METHOD_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN METHOD_SPREAD_FORECAST t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Velocity Method not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.MERCH_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200020), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_VELOCITY t WITH (NOLOCK) ON t.MERCH_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.OTS_PLAN_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200020), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_VELOCITY t WITH (NOLOCK) ON t.OTS_PLAN_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.BASIS_HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 200020), m.METHOD_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN METHOD_VELOCITY_BASIS t WITH (NOLOCK) ON t.BASIS_HN_RID = n.HN_RID
	JOIN METHOD m WITH (NOLOCK) ON m.METHOD_RID = t.METHOD_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = m.USER_RID
	WHERE m.USER_RID <> @PH_OWNER

	-- Allocate Task not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 900276) + ' Tasklist', tl.TASKLIST_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN TASK_ALLOCATE t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN TASKLIST tl WITH (NOLOCK) ON tl.TASKLIST_RID = t.TASKLIST_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = tl.USER_RID
	WHERE tl.USER_RID <> @PH_OWNER

	-- Forecast Task not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 800410) + ' Tasklist', tl.TASKLIST_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN TASK_FORECAST t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN TASKLIST tl WITH (NOLOCK) ON tl.TASKLIST_RID = t.TASKLIST_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = tl.USER_RID
	WHERE tl.USER_RID <> @PH_OWNER
	UNION
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 800410) + ' Tasklist', tl.TASKLIST_NAME, au.USER_NAME   
	FROM @nodes n
	JOIN TASK_FORECAST_BALANCE t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN TASKLIST tl WITH (NOLOCK) ON tl.TASKLIST_RID = t.TASKLIST_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = tl.USER_RID
	WHERE tl.USER_RID <> @PH_OWNER

	-- Rollup Task not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 800411) + ' Tasklist', tl.TASKLIST_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN TASK_ROLLUP t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN TASKLIST tl WITH (NOLOCK) ON tl.TASKLIST_RID = t.TASKLIST_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = tl.USER_RID
	WHERE tl.USER_RID <> @PH_OWNER

	-- Size Curve Generate Task not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 800434) + ' Tasklist', tl.TASKLIST_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN TASK_SIZE_CURVE_GENERATE t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN TASKLIST tl WITH (NOLOCK) ON tl.TASKLIST_RID = t.TASKLIST_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = tl.USER_RID
	WHERE tl.USER_RID <> @PH_OWNER

	-- Size Day To Week Summary Task not owned by user

	INSERT INTO @inUse 
	SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (t.HN_RID), (SELECT TEXT_VALUE FROM APPLICATION_TEXT WITH (NOLOCK) WHERE TEXT_CODE = 800435) + ' Tasklist', tl.TASKLIST_NAME, au.USER_NAME    
	FROM @nodes n
	JOIN TASK_SIZE_DAY_TO_WEEK_SUMMARY t WITH (NOLOCK) ON t.HN_RID = n.HN_RID
	JOIN TASKLIST tl WITH (NOLOCK) ON tl.TASKLIST_RID = t.TASKLIST_RID
	JOIN APPLICATION_USER au WITH (NOLOCK) ON au.USER_RID = tl.USER_RID
	WHERE tl.USER_RID <> @PH_OWNER

	SELECT * FROM @inUse

END
GO
