CREATE PROCEDURE [dbo].[SP_GET_SIZE_CURVE_TOLERANCE_REPORT] 
	@SELECTED_NODE_RID INT,
	@LOWER_LEVEL INT
AS
BEGIN
	DECLARE @SELECTED_NODE_LEVEL AS INT,
		@HOME_PH_RID AS INT

	SELECT @SELECTED_NODE_LEVEL = HOME_LEVEL,
		@HOME_PH_RID = HOME_PH_RID
	FROM HIERARCHY_NODE
	WHERE HN_RID = @SELECTED_NODE_RID

	DECLARE @MAX_PHL_SEQUENCE AS INT

	SELECT @MAX_PHL_SEQUENCE = MAX(PHL_SEQUENCE)
	FROM PRODUCT_HIERARCHY_LEVELS

	IF (@LOWER_LEVEL = 0)
	BEGIN
		SELECT @LOWER_LEVEL = @MAX_PHL_SEQUENCE
	END

	DECLARE @LEVEL AS INT

	SELECT @LEVEL = (@LOWER_LEVEL - @SELECTED_NODE_LEVEL) + 1

	SELECT @LEVEL = @LOWER_LEVEL - 1

	CREATE TABLE #TEMPNODE (
		PARENT_HN_RID INT,
		HN_RID INT,
		BN_ID VARCHAR(356) COLLATE Latin1_General_CS_AS,
		BN_NAME VARCHAR(50) COLLATE Latin1_General_CS_AS,
		BN_DESCRIPTION VARCHAR(250) COLLATE Latin1_General_CS_AS,
		HOME_LEVEL INT
		)

	INSERT #TEMPNODE (
		PARENT_HN_RID,
		HN_RID,
		BN_ID,
		BN_NAME,
		BN_DESCRIPTION,
		HOME_LEVEL
		)
	EXEC SP_GET_ALL_DESCENDANTS_BY_LEVEL_REPORT @SELECTED_NODE_RID,
		@LEVEL

	CREATE TABLE #SIZE_CURVE_TOLERANCE_TABLE (
		HN_RID INT,
		BN_ID VARCHAR(356),
		HOME_LEVEL int,
		HIGHEST_LEVEL_PHL_ID VARCHAR(50),
		MINIMUM_AVERAGE_PER_SIZE FLOAT,
		SALES_TOLERANCE FLOAT,
		INDEX_UNITS_TYPE_DESCRIPTION VARCHAR(25),
		MIN_TOLERANCE FLOAT,
		MAX_TOLERANCE FLOAT,
		APPLY_MIN_TO_ZERO_TOLERANCE CHAR(1)
		)

	INSERT INTO #SIZE_CURVE_TOLERANCE_TABLE
	SELECT hn.HN_RID,
	    -- Begin TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
		--[dbo].[UDF_MID_GET_NODE_DISPLAY_LEVEL](hn.HN_RID) AS [BN_ID],
		[dbo].[UDF_MID_GET_NODE_DISPLAY](hn.HN_RID) AS [BN_ID],
		-- End TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
		hn.HOME_LEVEL,
		HIGHEST_LEVEL_PHL_ID,
		MINIMUM_AVERAGE_PER_SIZE,
		SALES_TOLERANCE,
		INDEX_UNITS_TYPE_DESCRIPTION,
		MIN_TOLERANCE,
		MAX_TOLERANCE,
		APPLY_MIN_TO_ZERO_TOLERANCE
	FROM (
		SELECT NSCT.HN_RID,
			PHL.PHL_ID AS HIGHEST_LEVEL_PHL_ID,
			NSCT.MINIMUM_AVERAGE AS MINIMUM_AVERAGE_PER_SIZE,
			SALES_TOLERANCE,
			CASE 
				WHEN INDEX_UNITS_TYPE = 1
					THEN 'Index to Average'
				ELSE 'Units'
				END AS INDEX_UNITS_TYPE_DESCRIPTION,
			MIN_TOLERANCE,
			MAX_TOLERANCE,
			CASE 
				WHEN APPLY_MIN_TO_ZERO_TOLERANCE_IND = 0
					THEN 'N'
				ELSE 'Y'
				END AS APPLY_MIN_TO_ZERO_TOLERANCE
		FROM NODE_SIZE_CURVE_TOLERANCE NSCT
		LEFT OUTER JOIN PRODUCT_HIERARCHY_LEVELS PHL ON PHL.PH_RID = NSCT.PH_RID
			AND PHL.PHL_SEQUENCE = NSCT.PHL_SEQUENCE
		) AS T
	INNER JOIN (
		SELECT PARENT_HN_RID,
			HN_RID,
			BN_ID,
			BN_NAME,
			BN_DESCRIPTION,
			HOME_LEVEL
		FROM #TEMPNODE
		) hn ON hn.HN_RID = T.HN_RID

	SELECT *
	FROM #SIZE_CURVE_TOLERANCE_TABLE
	ORDER BY BN_ID

	--IF (
	--		SELECT object_id('tempdb.dbo.#TEMPNODE')
	--		) > 0
	IF OBJECT_ID('tempdb..#TEMPNODE') is not null
		DROP TABLE #TEMPNODE

	DROP TABLE #SIZE_CURVE_TOLERANCE_TABLE
END
GO


