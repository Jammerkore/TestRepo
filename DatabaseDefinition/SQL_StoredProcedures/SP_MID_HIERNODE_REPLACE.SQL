--dv =============================================
--dv Modified date:	8/14/2014
--dv Description:	Replaces hierachy node
--dv History:		TT#1268 - MD - RMatelic - 5.4 Merge
--dv =============================================
CREATE PROCEDURE [dbo].[SP_MID_HIERNODE_REPLACE] 
	@HN_RID INT,
	@REPLACE_HN_RID INT
AS
BEGIN
	DECLARE @RID INT
	DECLARE @methodtable TABLE (RID INT)

	/* Begin TT#1313-MD -jsobek -Header Filters */
	--UPDATE AL_WRKSP_FILTER
	--WITH (ROWLOCK)
	--SET HN_RID = @REPLACE_HN_RID
	--WHERE HN_RID = @HN_RID

	--UPDATE ASRT_WRKSP_FILTER
	--WITH (ROWLOCK)
	--SET HN_RID = @REPLACE_HN_RID
	--WHERE HN_RID = @HN_RID
	UPDATE FILTER_CONDITION WITH (ROWLOCK)
	SET HEADER_HN_RID=@REPLACE_HN_RID
	WHERE HEADER_HN_RID = @HN_RID
	/* End TT#1313-MD -jsobek -Header Filters */

	UPDATE USER_ALLOCATION
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE USER_ALLOCATION_BASIS
	WITH (ROWLOCK)

	SET BASIS_HN_RID = @REPLACE_HN_RID
	WHERE BASIS_HN_RID = @HN_RID

	UPDATE USER_PLAN
	WITH (ROWLOCK)

	SET CHAIN_HN_RID = @REPLACE_HN_RID
	WHERE CHAIN_HN_RID = @HN_RID

	UPDATE USER_PLAN
	WITH (ROWLOCK)

	SET STORE_HN_RID = @REPLACE_HN_RID
	WHERE STORE_HN_RID = @HN_RID

	UPDATE USER_PLAN_BASIS_DETAILS
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE OTS_PLAN
	WITH (ROWLOCK)

	SET PLAN_HN_RID = @REPLACE_HN_RID
	WHERE PLAN_HN_RID = @HN_RID

	UPDATE GROUP_LEVEL_FUNCTION
	WITH (ROWLOCK)

	SET SEASON_HN_RID = @REPLACE_HN_RID
	WHERE SEASON_HN_RID = @HN_RID

	UPDATE GROUP_LEVEL_BASIS
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE METHOD_OVERRIDE
	WITH (ROWLOCK)

	SET MERCH_HN_RID = @REPLACE_HN_RID
	WHERE MERCH_HN_RID = @HN_RID

	UPDATE METHOD_OVERRIDE
	WITH (ROWLOCK)

	SET ON_HAND_HN_RID = @REPLACE_HN_RID
	WHERE ON_HAND_HN_RID = @HN_RID

	-- BEGIN TT#708-MD - Stodd - Group Allocation Prototype 
	UPDATE METHOD_GROUP_ALLOCATION
    WITH (ROWLOCK)
	
	SET MERCH_HN_RID = @REPLACE_HN_RID
	WHERE MERCH_HN_RID = @HN_RID

    UPDATE METHOD_GROUP_ALLOCATION
	WITH (ROWLOCK)
	 
	SET ON_HAND_HN_RID = @REPLACE_HN_RID
	WHERE ON_HAND_HN_RID = @HN_RID
	
	UPDATE METHOD_GROUP_ALLOCATION
	WITH (ROWLOCK) 
	
	SET IB_MERCH_HN_RID = @REPLACE_HN_RID
	WHERE IB_MERCH_HN_RID = @HN_RID
	-- END TT#708-MD - Stodd - Group Allocation Prototype

	UPDATE METHOD_GENERAL_ALLOCATION
	WITH (ROWLOCK)

	SET MERCH_HN_RID = @REPLACE_HN_RID
	WHERE MERCH_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_NEED
	WITH (ROWLOCK)

	SET MERCH_HN_RID = @REPLACE_HN_RID
	WHERE MERCH_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_NEED
	WITH (ROWLOCK)

	SET GENCURVE_HN_RID = @REPLACE_HN_RID
	WHERE GENCURVE_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_NEED
	WITH (ROWLOCK)

	SET GENCONSTRAINT_HN_RID = @REPLACE_HN_RID
	WHERE GENCONSTRAINT_HN_RID = @HN_RID

	UPDATE METHOD_FILL_SIZE_HOLES
	WITH (ROWLOCK)

	SET MERCH_HN_RID = @REPLACE_HN_RID
	WHERE MERCH_HN_RID = @HN_RID

	UPDATE METHOD_FILL_SIZE_HOLES
	WITH (ROWLOCK)

	SET GENCURVE_HN_RID = @REPLACE_HN_RID
	WHERE GENCURVE_HN_RID = @HN_RID

	UPDATE METHOD_FILL_SIZE_HOLES
	WITH (ROWLOCK)

	SET GENCONSTRAINT_HN_RID = @REPLACE_HN_RID
	WHERE GENCONSTRAINT_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_BASIS_ALLOCATION
	WITH (ROWLOCK)

	SET GENCURVE_HN_RID = @REPLACE_HN_RID
	WHERE GENCURVE_HN_RID = @HN_RID

	UPDATE METHOD_SIZE_BASIS_ALLOCATION
	WITH (ROWLOCK)

	SET GENCONSTRAINT_HN_RID = @REPLACE_HN_RID
	WHERE GENCONSTRAINT_HN_RID = @HN_RID

	UPDATE METHOD_VELOCITY_BASIS
	WITH (ROWLOCK)

	SET BASIS_HN_RID = @REPLACE_HN_RID
	WHERE BASIS_HN_RID = @HN_RID

	UPDATE METHOD_VELOCITY
	WITH (ROWLOCK)

	SET OTS_PLAN_HN_RID = @REPLACE_HN_RID
	WHERE OTS_PLAN_HN_RID = @HN_RID

	UPDATE METHOD_COPY_BASIS_DETAIL
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE METHOD_COPY_FORECAST
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	DELETE OVERRIDE_LL_MODEL_HEADER
	WITH (ROWLOCK)
	WHERE HN_RID = @HN_RID

	UPDATE OVERRIDE_LL_MODEL_HEADER
	WITH (ROWLOCK)

	SET HIGH_LEVEL_HN_RID = NULL
	WHERE HIGH_LEVEL_HN_RID = @HN_RID

	-- delete all low level spread entries for replaced node
	INSERT INTO @methodtable
	SELECT METHOD_RID
	FROM METHOD_SPREAD_FORECAST WITH (NOLOCK)
	WHERE HN_RID = @HN_RID

	SELECT TOP 1 @RID = RID
	FROM @methodtable

	WHILE @@rowcount <> 0
	BEGIN
		DELETE @methodtable
		WHERE RID = @RID

		SELECT TOP 1 @RID = RID
		FROM @methodtable
	END

	UPDATE METHOD_SPREAD_FORECAST
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE METHOD_MATRIX
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE TASK_ALLOCATE
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE TASK_FORECAST
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE TASK_FORECAST_BALANCE
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	UPDATE TASK_ROLLUP
	WITH (ROWLOCK)

	SET HN_RID = @REPLACE_HN_RID
	WHERE HN_RID = @HN_RID

	--update HEADER with (rowlock) set STYLE_HNRID = @REPLACE_HN_RID where STYLE_HNRID = @HN_RID
	UPDATE HEADER
	WITH (ROWLOCK)

	SET PLAN_HNRID = @REPLACE_HN_RID
	WHERE PLAN_HNRID = @HN_RID

	UPDATE HEADER
	WITH (ROWLOCK)

	SET ON_HAND_HNRID = @REPLACE_HN_RID
	WHERE ON_HAND_HNRID = @HN_RID

	SELECT @@ROWCOUNT;
END
GO


