--dv =============================================
--dv Create date:	5/6/2015
--dv Description:	Reads filters that match the char and fields changed
--dv =============================================
CREATE PROCEDURE [dbo].[MID_FILTER_READ_FOR_REFRESH]
	@FIELD_CHANGED_LIST FIELD_CHANGED_TYPE READONLY,
	@CHAR_CHANGED_LIST CHAR_CHANGED_TYPE READONLY
AS
BEGIN
	SET NOCOUNT ON;


	SELECT f.FILTER_RID, sg.SG_RID
	FROM FILTER f 
    INNER JOIN STORE_GROUP sg ON sg.FILTER_RID = f.FILTER_RID
    WHERE sg.IS_ACTIVE=1 AND (f.FILTER_TYPE=3 OR f.FILTER_TYPE=6) AND f.FILTER_RID IN 
    (
    SELECT DISTINCT fc.FILTER_RID --Store characteristics
        FROM FILTER_CONDITION_LIST_VALUES lv WITH (NOLOCK) 
        INNER JOIN FILTER_CONDITION fc WITH (NOLOCK) ON fc.CONDITION_RID = lv.CONDITION_RID 
        INNER JOIN STORE_CHAR sc WITH (NOLOCK) ON sc.SC_RID = lv.LIST_VALUE_INDEX AND lv.LIST_VALUE_TYPE_INDEX = 5 AND sc.SCG_RID IN (SELECT SCG_RID FROM @CHAR_CHANGED_LIST) 
    UNION --Store characteristics
        SELECT DISTINCT fc.FILTER_RID 
        FROM FILTER_CONDITION fc WITH (NOLOCK) 
        WHERE fc.ELEMENT_GROUP_TYPE_INDEX = 9 AND fc.FIELD_INDEX IN (SELECT SCG_RID FROM @CHAR_CHANGED_LIST) 
	UNION --Store Fields in a list
		SELECT DISTINCT fc.FILTER_RID 
        FROM FILTER_CONDITION_LIST_VALUES lv WITH (NOLOCK) 
        INNER JOIN FILTER_CONDITION fc WITH (NOLOCK) ON fc.CONDITION_RID = lv.CONDITION_RID AND lv.LIST_VALUE_TYPE_INDEX = 7 and lv.LIST_VALUE_INDEX IN (SELECT FIELD_INDEX FROM @FIELD_CHANGED_LIST) 
    UNION --Store Fields
        SELECT DISTINCT fc.FILTER_RID 
        FROM FILTER_CONDITION fc WITH (NOLOCK) 
        WHERE fc.ELEMENT_GROUP_TYPE_INDEX = 8 AND fc.FIELD_INDEX IN (SELECT FIELD_INDEX FROM @FIELD_CHANGED_LIST) 
	UNION --Dynamic sets based on store fields
        SELECT DISTINCT fc.FILTER_RID 
        FROM FILTER_CONDITION fc WITH (NOLOCK) 
        WHERE fc.ELEMENT_GROUP_TYPE_INDEX = 44 AND (fc.OPERATOR_INDEX * -1) IN (SELECT FIELD_INDEX FROM @FIELD_CHANGED_LIST) 
	UNION --Dynamic sets based on store name
        SELECT DISTINCT fc.FILTER_RID 
        FROM FILTER_CONDITION fc WITH (NOLOCK) 
        WHERE fc.ELEMENT_GROUP_TYPE_INDEX = 44 AND fc.OPERATOR_INDEX is null AND EXISTS (SELECT 1 FROM @FIELD_CHANGED_LIST WHERE FIELD_INDEX IN (1))
	UNION --Dynamic sets based on store characterisitcs
        SELECT DISTINCT fc.FILTER_RID 
        FROM FILTER_CONDITION fc WITH (NOLOCK) 
        WHERE fc.ELEMENT_GROUP_TYPE_INDEX = 44 AND (fc.OPERATOR_INDEX) IN (SELECT SCG_RID FROM @CHAR_CHANGED_LIST) 
	UNION --Store status when the underlying date fields change
        SELECT DISTINCT fc.FILTER_RID 
        FROM FILTER_CONDITION fc WITH (NOLOCK) 
        WHERE fc.ELEMENT_GROUP_TYPE_INDEX = 6 AND EXISTS (SELECT 1 FROM @FIELD_CHANGED_LIST WHERE FIELD_INDEX IN (6, 7, 8, 9))  --Selling Open and Close Date, and Stock Open and Close Date
		
    ) 
               


	 
	SELECT @@ROWCOUNT;
END
GO