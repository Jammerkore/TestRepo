CREATE PROCEDURE [dbo].[SP_MID_HIERJOIN_UPDATE] 
	@HN_RID INT,
	@OLD_HIERARCHY_RID INT,
	@OLD_PARENT_RID INT,
	@NEW_HIERARCHY_RID INT,
	@NEW_PARENT_RID INT
AS
BEGIN
	SET NOCOUNT ON
	-- Begin TT#3630 - JSmith - Delete My Hierarchy
	declare @VIRTUAL_IND char, @NODE_DELETE_IND char
	select @VIRTUAL_IND = VIRTUAL_IND, @NODE_DELETE_IND = NODE_DELETE_IND
	  from HIER_NODE_JOIN with (nolock)
	where PH_RID = @OLD_HIERARCHY_RID
	  and PARENT_HN_RID = @OLD_PARENT_RID
	  and HN_RID = @HN_RID 
	-- End TT#3630 - JSmith - Delete My Hierarchy

	DELETE
	FROM HIER_NODE_JOIN
	WHERE PH_RID = @OLD_HIERARCHY_RID
		AND PARENT_HN_RID = @OLD_PARENT_RID
		AND HN_RID = @HN_RID

	INSERT INTO HIER_NODE_JOIN (
		PH_RID,
		PARENT_HN_RID,
		HN_RID, 
		VIRTUAL_IND, 
		NODE_DELETE_IND
		)
	VALUES (
		@NEW_HIERARCHY_RID,
		@NEW_PARENT_RID,
		@HN_RID, 
		@VIRTUAL_IND, 
		@NODE_DELETE_IND
		)
	SELECT @@ROWCOUNT;
END
GO


