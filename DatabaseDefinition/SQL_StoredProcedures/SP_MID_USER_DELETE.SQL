CREATE PROCEDURE [dbo].[SP_MID_USER_DELETE] 
	@UserRID INT,
	@debug BIT = 0
AS
BEGIN
	IF (@debug = 0)
		SET NOCOUNT ON

	DECLARE @t TABLE (RID INT)
	DECLARE @RID INT
	DECLARE @RECORDS_DELETED INT

	DELETE
	FROM [dbo].[USER_OPTIONS] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	UPDATE [dbo].[AUDIT_HEADER]
	WITH (ROWLOCK)

	SET USER_RID = 1
	WHERE USER_RID = @UserRID

	UPDATE [dbo].[AUDIT_FORECAST]
	WITH (ROWLOCK)

	SET USER_RID = 1
	WHERE USER_RID = @UserRID

	/* Begin TT#1313-MD -jsobek -Header Filters */
	--DELETE
	--FROM [dbo].[AL_WRKSP_FILTER_STATUS] WITH (ROWLOCK)
	--WHERE USER_RID = @UserRID

	--DELETE
	--FROM [dbo].[AL_WRKSP_FILTER_TYPES] WITH (ROWLOCK)
	--WHERE USER_RID = @UserRID

	--DELETE
	--FROM [dbo].[AL_WRKSP_FILTER] WITH (ROWLOCK)
	--WHERE USER_RID = @UserRID

	--DELETE
	--FROM [dbo].[ASRT_WRKSP_FILTER_STATUS] WITH (ROWLOCK)
	--WHERE USER_RID = @UserRID

	--DELETE
	--FROM [dbo].[ASRT_WRKSP_FILTER] WITH (ROWLOCK)
	--WHERE USER_RID = @UserRID
	/* End TT#1313-MD -jsobek -Header Filters */

	DELETE
	FROM [dbo].[FOLDER] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[AUDIT_FILTER] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID -- TT#63 MD - JSmith - Error deleting user with Purge

	UPDATE [dbo].[SCHEDULE]
	WITH (ROWLOCK)

	SET CREATED_BY_USER_RID = 1
	WHERE CREATED_BY_USER_RID = @UserRID

	UPDATE [dbo].[SCHEDULE]
	WITH (ROWLOCK)

	SET LAST_MODIFIED_BY_USER_RID = 1
	WHERE LAST_MODIFIED_BY_USER_RID = @UserRID

	DELETE
	FROM [dbo].[SCHEDULE_JOB_JOIN] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[INFRAGISTICS_LAYOUTS] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	/* Begin TT#781 - JScott - Purge fails. Build Packs constraint & Plan View User constraint */
	--DELETE
	--FROM [dbo].[PRODUCT_SEARCH_VIEW] WITH (ROWLOCK)
	--WHERE USER_RID = @UserRID

	--DELETE
	--FROM [dbo].[PRODUCT_SEARCH_OBJECT] WITH (ROWLOCK)
	--WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_PLAN] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	/* End TT#781 - JScott - Purge fails. Build Packs constraint & Plan View User constraint */
	-- remove all planview details
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	INSERT INTO @t
	SELECT VIEW_RID
	FROM [dbo].[PLAN_VIEW]
	WHERE USER_RID = @UserRID

	SET TRANSACTION ISOLATION LEVEL READ COMMITTED

	SELECT TOP 1 @RID = RID
	FROM @t

	WHILE @@rowcount <> 0
	BEGIN
		DELETE
		FROM [dbo].[PLAN_VIEW_DETAIL] WITH (ROWLOCK)
		WHERE VIEW_RID = @RID

		DELETE @t
		WHERE RID = @RID

		SELECT TOP 1 @RID = RID
		FROM @t
	END

	DELETE
	FROM [dbo].[PLAN_VIEW] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	-- remove all gridview details
	DELETE
	FROM [dbo].[USER_CURRENT_GRID_VIEW] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	INSERT INTO @t
	SELECT VIEW_RID
	FROM [dbo].[GRID_VIEW]
	WHERE USER_RID = @UserRID

	SET TRANSACTION ISOLATION LEVEL READ COMMITTED

	SELECT TOP 1 @RID = RID
	FROM @t

	WHILE @@rowcount <> 0
	BEGIN
		DELETE
		FROM [dbo].[GRID_VIEW_DETAIL] WITH (ROWLOCK)
		WHERE VIEW_RID = @RID

		/* Begin TT#1313-MD -jsobek -Header Filters */
		--DELETE
		--FROM [dbo].[GRID_VIEW_FILTER_STATUS] WITH (ROWLOCK)
		--WHERE VIEW_RID = @RID

		--DELETE
		--FROM [dbo].[GRID_VIEW_FILTER_TYPES] WITH (ROWLOCK)
		--WHERE VIEW_RID = @RID

		--DELETE
		--FROM [dbo].[GRID_VIEW_FILTER] WITH (ROWLOCK)
		--WHERE VIEW_RID = @RID
		/* End TT#1313-MD -jsobek -Header Filters */

		DELETE @t
		WHERE RID = @RID

		SELECT TOP 1 @RID = RID
		FROM @t
	END

	DELETE
	FROM [dbo].[GRID_VIEW] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[THEME] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_ALLOCATION_BASIS] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_ALLOCATION_HEADERS] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_ALLOCATION] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	-- Begin TT#5292 - JSmith - Purge Error number 3
	DELETE
	FROM [dbo].[ASSORTMENT_USER_VIEW_JOIN] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID
	-- End TT#5292 - JSmith - Purge Error number 3

	-- Begin TT#5812 - JSmith - Purge is attempting to delete a user that has an ASSORTMENT_VIEW row which was not deleted before attempting to delete the user. 
	-- remove all assortment view details
	DELETE
	FROM [dbo].[USER_ASSORTMENT_STORE_GRADE] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_ASSORTMENT_BASIS] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_ASSORTMENT] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	INSERT INTO @t
	SELECT VIEW_RID
	FROM [dbo].[ASSORTMENT_VIEW]
	WHERE USER_RID = @UserRID

	SET TRANSACTION ISOLATION LEVEL READ COMMITTED

	SELECT TOP 1 @RID = RID
	FROM @t

	WHILE @@rowcount <> 0
	BEGIN
		DELETE
		FROM [dbo].[ASSORTMENT_VIEW_DETAIL] WITH (ROWLOCK)
		WHERE VIEW_RID = @RID

		DELETE @t
		WHERE RID = @RID

		SELECT TOP 1 @RID = RID
		FROM @t
	END

	DELETE
	FROM [dbo].[ASSORTMENT_VIEW] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID
	-- End TT#5812 - JSmith

	-- Begin TT#5245 - JSmith - Purge Error number 2
	DELETE
	FROM [dbo].[ASSORTMENT_PROPERTIES_BASIS] WITH (ROWLOCK)
	WHERE HDR_RID in (SELECT HDR_RID FROM [dbo].[ASSORTMENT_PROPERTIES] WITH (NOLOCK) WHERE USER_RID = @UserRID)

	DELETE
	FROM [dbo].[ASSORTMENT_PROPERTIES_STORE_GRADE] WITH (ROWLOCK)
	WHERE HDR_RID in (SELECT HDR_RID FROM [dbo].[ASSORTMENT_PROPERTIES] WITH (NOLOCK) WHERE USER_RID = @UserRID)

	DELETE
	FROM [dbo].[ASSORTMENT_PROPERTIES] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID
	-- End TT#5245 - JSmith - Purge Error number 2

	DELETE
	FROM [dbo].[USER_WORKFLOW_PREF] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_METHOD_PREF] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[MID_ENQUEUE] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_PLAN_BASIS_DETAILS] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_PLAN_BASIS] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_PLAN] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[SECURITY_USER_HIERARCHY_NODE] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	--DELETE
	--FROM [dbo].[SECURITY_USER_STORE_GRP_LEVEL] WITH (ROWLOCK)
	--WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[SECURITY_USER_STORE] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[SECURITY_USER_VIEW] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[SECURITY_USER_FUNCTION] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[SECURITY_USER_VERSION] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	UPDATE [dbo].[PROC_HDR]
	WITH (ROWLOCK)

	SET USER_RID = 1
	WHERE USER_RID = @UserRID

	-- remove all filters for user
	EXEC [dbo].[SP_MID_USER_FILTERS_DELETE] @UserRID, 9999999, 0, 0, @RECORDS_DELETED OUTPUT

	-- set all tasklists created or modified by the user to undefined user
	UPDATE [dbo].[TASKLIST]
	WITH (ROWLOCK)

	SET CREATED_BY_USER_RID = 1
	WHERE CREATED_BY_USER_RID = @UserRID

	UPDATE [dbo].[TASKLIST]
	WITH (ROWLOCK)

	SET LAST_MODIFIED_BY_USER_RID = 1
	WHERE LAST_MODIFIED_BY_USER_RID = @UserRID

	-- remove all tasklists for user
	EXEC [dbo].[SP_MID_USER_TASKLISTS_DELETE] @UserRID, 9999999, 0, 0, @RECORDS_DELETED OUTPUT

	-- set all jobs created or modified by the user to undefined user
	UPDATE [dbo].[JOB]
	WITH (ROWLOCK)

	SET CREATED_BY_USER_RID = 1
	WHERE CREATED_BY_USER_RID = @UserRID

	UPDATE [dbo].[JOB]
	WITH (ROWLOCK)

	SET LAST_MODIFIED_BY_USER_RID = 1
	WHERE LAST_MODIFIED_BY_USER_RID = @UserRID

	-- set all methods created or modified by the user to undefined user
	UPDATE [dbo].[METHOD_CHANGE_HISTORY]
	WITH (ROWLOCK)

	SET USER_RID = 1
	WHERE USER_RID = @UserRID

	-- remove all methods
	EXEC [dbo].[SP_MID_USER_METHODS_DELETE] @UserRID, 9999999, 0, 0, @RECORDS_DELETED OUTPUT

	-- set all workflows created or modified by the user to undefined user
	UPDATE [dbo].[WORKFLOW_CHANGE_HISTORY]
	WITH (ROWLOCK)

	SET USER_RID = 1
	WHERE USER_RID = @UserRID

	-- remove all workflows
	EXEC [dbo].SP_MID_USER_WORKFLOWS_DELETE @UserRID, 9999999, 0, 0, @RECORDS_DELETED OUTPUT

	DELETE 
	FROM [dbo].[CHAIN_SET_PERCENT_USER]  WITH (ROWLOCK) 
	WHERE USER_RID = @UserRID

	-- remove user items
	DELETE
	FROM [dbo].[USER_ITEM] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_ITEM] WITH (ROWLOCK)
	WHERE OWNER_USER_RID = @UserRID

	DELETE
	FROM [dbo].[USER_GROUP_JOIN] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	DELETE
	FROM [dbo].[APPLICATION_USER] WITH (ROWLOCK)
	WHERE USER_RID = @UserRID

	SELECT @@ROWCOUNT;
END
GO


