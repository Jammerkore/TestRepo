CREATE PROCEDURE [dbo].[SP_GET_PURGE_DATES_REPORT] 
	@SELECTED_NODE_RID INT,
	@LOWER_LEVEL INT
AS
DECLARE @SELECTED_NODE_LEVEL AS INT

SELECT @SELECTED_NODE_LEVEL = HOME_LEVEL
FROM HIERARCHY_NODE
WHERE HN_RID = @SELECTED_NODE_RID

DECLARE @MAX_PHL_SEQUENCE AS INT

SELECT @MAX_PHL_SEQUENCE = MAX(PHL_SEQUENCE)
FROM PRODUCT_HIERARCHY_LEVELS

IF (@LOWER_LEVEL = 0)
BEGIN
	SELECT @LOWER_LEVEL = @MAX_PHL_SEQUENCE
END

DECLARE @LEVEL AS INT
DECLARE @DAILY_INH VARCHAR(10),
	@WEEKLY_INH VARCHAR(10),
	@PLANS_INH VARCHAR(10),
	@HEADERS_RECEIPT_INH VARCHAR(10),
	@HEADERS_ASN_INH VARCHAR(10),
	@HEADERS_DUMMY_INH VARCHAR(10),
	@HEADERS_DROPSHIP_INH VARCHAR(10),
	@HEADERS_RESERVE_INH VARCHAR(10),
	@HEADERS_WORKUPTOTALBUY_INH VARCHAR(10),
	@HEADERS_PO_INH VARCHAR(10),
	@HEADERS_VSW_INH VARCHAR(10)

--SELECT @LEVEL = (@LOWER_LEVEL -  @SELECTED_NODE_LEVEL)+1
SELECT @LEVEL = @LOWER_LEVEL - 1

-- Translate header purge rows to columns
SELECT *
INTO #NodeHeaderPurge
FROM dbo.UDF_MID_TRANSPOSE_NODE_PURGE_DATES()

-- Translate header purge rows to columns
SELECT *
INTO #LevelHeaderPurge
FROM dbo.UDF_MID_TRANSPOSE_LEVEL_PURGE_DATES()

CREATE TABLE #TEMP (
	PARENT_HN_RID INT,
	HN_RID INT,
	BN_ID VARCHAR(356) COLLATE Latin1_General_CS_AS,
	BN_NAME VARCHAR(50) COLLATE Latin1_General_CS_AS,
	BN_DESCRIPTION VARCHAR(250) COLLATE Latin1_General_CS_AS,
	HOME_LEVEL INT
	)

INSERT #TEMP (
	PARENT_HN_RID,
	HN_RID,
	BN_ID,
	BN_NAME,
	BN_DESCRIPTION,
	HOME_LEVEL
	)
EXEC SP_GET_ALL_DESCENDANTS_BY_LEVEL_REPORT @SELECTED_NODE_RID,
	@LEVEL

SELECT '0' AS SORTSEQ,
	NULL AS HN_RID,
	CONVERT(VARCHAR(50), phl.PHL_SEQUENCE) AS BN_ID,
	PHL_ID AS BN_NAME,
	PURGE_DAILY_HISTORY 'PURGE_DAILY_HISTORY_WEEKS',
	@DAILY_INH AS DAILY_INH,
	PURGE_WEEKLY_HISTORY 'PURGE_WEEKLY_HISTORY_WEEKS',
	@WEEKLY_INH AS WEEKLY_INH,
	PURGE_PLANS 'PURGE_PLANS_WEEKS',
	@PLANS_INH AS PLANS_INH,
	--PURGE_HEADERS 'PURGE_HEADERS_WEEKS',  @HEADERS_INH as HEADERS_INH
	lhp.PURGE_HEADERS_WEEKS_RECEIPT 'PURGE_HEADERS_WEEKS_RECEIPT',
	@HEADERS_RECEIPT_INH AS HEADERS_RECEIPT_INH,
	lhp.PURGE_HEADERS_WEEKS_ASN 'PURGE_HEADERS_WEEKS_ASN',
	@HEADERS_ASN_INH AS HEADERS_ASN_INH,
	lhp.PURGE_HEADERS_WEEKS_DUMMY 'PURGE_HEADERS_WEEKS_DUMMY',
	@HEADERS_DUMMY_INH AS HEADERS_DUMMY_INH,
	lhp.PURGE_HEADERS_WEEKS_DROPSHIP 'PURGE_HEADERS_WEEKS_DROPSHIP',
	@HEADERS_DROPSHIP_INH AS HEADERS_DROPSHIP_INH,
	lhp.PURGE_HEADERS_WEEKS_RESERVE 'PURGE_HEADERS_WEEKS_RESERVE',
	@HEADERS_RESERVE_INH AS HEADERS_RESERVE_INH,
	lhp.PURGE_HEADERS_WEEKS_WORKUPTOTALBUY 'PURGE_HEADERS_WEEKS_WORKUPTOTALBUY',
	@HEADERS_WORKUPTOTALBUY_INH AS HEADERS_WORKUPTOTALBUY_INH,
	lhp.PURGE_HEADERS_WEEKS_PO 'PURGE_HEADERS_WEEKS_PO',
	@HEADERS_PO_INH AS HEADERS_PO_INH,
	lhp.PURGE_HEADERS_WEEKS_VSW 'PURGE_HEADERS_WEEKS_VSW',
	@HEADERS_VSW_INH AS HEADERS_VSW_INH
FROM PRODUCT_HIERARCHY_LEVELS phl
JOIN #LevelHeaderPurge lhp ON lhp.PH_RID = phl.PH_RID
	AND lhp.PHL_SEQUENCE = phl.PHL_SEQUENCE

UNION

SELECT '1' AS SORTSEQ,
	NULL AS HN_RID,
	'' AS BN_ID,
	'' AS BN_NAME,
	NULL,
	@DAILY_INH AS DAILY_INH,
	NULL,
	@WEEKLY_INH AS WEEKLY_INH,
	NULL,
	@PLANS_INH AS PLANS_INH,
	NULL,
	@HEADERS_RECEIPT_INH AS HEADERS_RECEIPT_INH,
	NULL,
	@HEADERS_ASN_INH AS HEADERS_ASN_INH,
	NULL,
	@HEADERS_DUMMY_INH AS HEADERS_DUMMY_INH,
	NULL,
	@HEADERS_DROPSHIP_INH AS HEADERS_DROPSHIP_INH,
	NULL,
	@HEADERS_RESERVE_INH AS HEADERS_RESERVE_INH,
	NULL,
	@HEADERS_WORKUPTOTALBUY_INH AS HEADERS_WORKUPTOTALBUY_INH,
	NULL,
	@HEADERS_PO_INH AS HEADERS_PO_INH,
	NULL,
	@HEADERS_VSW_INH AS HEADERS_VSW_INH

UNION

SELECT '2' AS SORTSEQ,
	hn.HN_RID AS HN_RID,
	hn.BN_ID,
	-- Begin TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
	dbo.UDF_MID_GET_NODE_DISPLAY (hn.HN_RID) AS [BN_NAME],
	--CASE 
	--	WHEN phl.PHL_DISPLAY_OPTION_ID = 800701
	--		THEN RTRIM(hn.BN_ID)
	--	WHEN phl.PHL_DISPLAY_OPTION_ID = 800702
	--		THEN RTRIM(hn.BN_DESCRIPTION)
	--	WHEN phl.PHL_DISPLAY_OPTION_ID = 800703
	--		THEN RTRIM(hn.BN_ID) + ' [' + RTRIM(hn.BN_NAME) + ']'
	--	WHEN phl.PHL_DISPLAY_OPTION_ID = 800704
	--		THEN RTRIM(hn.BN_ID) + ' [' + RTRIM(hn.BN_DESCRIPTION) + ']'
	--	WHEN phl.PHL_DISPLAY_OPTION_ID = 800705
	--		THEN RTRIM(hn.BN_NAME) + ' [' + RTRIM(hn.BN_DESCRIPTION) + ']'
	--	WHEN phl.PHL_DISPLAY_OPTION_ID = 800706
	--		THEN RTRIM(hn.BN_ID) + ' [' + RTRIM(hn.BN_NAME) + ']' + ' [' + RTRIM(hn.BN_DESCRIPTION) + ']'
	--	ELSE RTRIM(hn.BN_ID) + ' [' + RTRIM(hn.BN_NAME) + ']'
	--	END AS [BN_NAME],
	-- End TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
	pc.PURGE_DAILY_HISTORY,
	@DAILY_INH AS DAILY_INH,
	pc.PURGE_WEEKLY_HISTORY,
	@WEEKLY_INH AS WEEKLY_INH,
	pc.PURGE_PLANS,
	@PLANS_INH AS PLANS_INH,
	--pc.PURGE_HEADERS, @HEADERS_INH as HEADERS_INH
	nhp.PURGE_HEADERS_WEEKS_RECEIPT,
	@HEADERS_RECEIPT_INH AS HEADERS_RECEIPT_INH,
	nhp.PURGE_HEADERS_WEEKS_ASN,
	@HEADERS_ASN_INH AS HEADERS_ASN_INH,
	nhp.PURGE_HEADERS_WEEKS_DUMMY,
	@HEADERS_DUMMY_INH AS HEADERS_DUMMY_INH,
	nhp.PURGE_HEADERS_WEEKS_DROPSHIP,
	@HEADERS_DROPSHIP_INH AS HEADERS_DROPSHIP_INH,
	nhp.PURGE_HEADERS_WEEKS_RESERVE,
	@HEADERS_RESERVE_INH AS HEADERS_RESERVE_INH,
	nhp.PURGE_HEADERS_WEEKS_WORKUPTOTALBUY,
	@HEADERS_WORKUPTOTALBUY_INH AS HEADERS_WORKUPTOTALBUY_INH,
	nhp.PURGE_HEADERS_WEEKS_PO,
	@HEADERS_PO_INH AS HEADERS_PO_INH,
	nhp.PURGE_HEADERS_WEEKS_VSW,
	@HEADERS_VSW_INH AS HEADERS_VSW_INH
FROM PURGE_CRITERIA pc
LEFT OUTER JOIN #NodeHeaderPurge nhp ON nhp.HN_RID = pc.HN_RID
LEFT OUTER JOIN (
	SELECT pd.HN_RID
	FROM PURGE_CRITERIA pd
	-- Begin TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
	--INNER JOIN BASE_NODE bn ON pd.HN_RID = bn.HN_RID
	LEFT OUTER JOIN BASE_NODE bn ON pd.HN_RID = bn.HN_RID
	-- End TT#5382 - JSmith - Product descriptor not displayed when the Store Eligibility is set at the color level
	GROUP BY pd.HN_RID
	) sms1 ON sms1.HN_RID = pc.HN_RID
INNER JOIN HIERARCHY_NODE hen ON hen.HN_RID = sms1.HN_RID
LEFT OUTER JOIN PRODUCT_HIERARCHY_LEVELS phl ON phl.PHL_SEQUENCE = hen.HOME_LEVEL
INNER JOIN (
	SELECT PARENT_HN_RID,
		HN_RID,
		BN_ID,
		BN_NAME,
		BN_DESCRIPTION
	FROM #TEMP
	) hn ON hn.HN_RID = pc.HN_RID
ORDER BY SORTSEQ,
	BN_ID

IF (
		SELECT object_id('tempdb.dbo.#TEMP')
		) > 0
	DROP TABLE #TEMP
GO


