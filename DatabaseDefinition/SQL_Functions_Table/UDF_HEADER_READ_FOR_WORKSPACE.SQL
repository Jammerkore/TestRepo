--dv =============================================
--dv Create date:	8/29/2014
--dv Description:	Retrieves header columns for the allocation workspace for the header RIDs in the list
--dv History:		9/17/2014 TT#1302-MD -jsobek -5.4 ASRT_ID in UDF_HEADER_READ
--dv =============================================
CREATE FUNCTION [dbo].[UDF_HEADER_READ_FOR_WORKSPACE] 
(	
	@HDR_RID_LIST HDR_RID_TYPE READONLY
)
RETURNS TABLE 
AS
RETURN 
(
	SELECT
		H.HDR_RID, 
		H.HDR_ID, 
		COALESCE(H.HDR_DESC, ' ') AS HDR_DESC, 
		H.HDR_DAY, 
		H.ORIG_DAY, 
		COALESCE(H.UNIT_RETAIL,0) AS UNIT_RETAIL, 
		COALESCE(H.UNIT_COST, 0) AS UNIT_COST, 
		COALESCE(H.UNITS_RECEIVED,0) AS UNITS_RECEIVED, 
		COALESCE(H.STYLE_HNRID, -1) AS STYLE_HNRID, 
		COALESCE(H.PLAN_HNRID, 1) AS PLAN_HNRID, 
		COALESCE(H.ON_HAND_HNRID, 1) AS ON_HAND_HNRID, 
		COALESCE(H.BULK_MULTIPLE, 1) AS BULK_MULTIPLE, 
		COALESCE(H.ALLOCATION_MULTIPLE, 1) AS ALLOCATION_MULTIPLE, 
		COALESCE(H.ALLOCATION_MULTIPLE_DEFAULT, 1) AS ALLOCATION_MULTIPLE_DEFAULT, 
		COALESCE(H.VENDOR, ' ') AS VENDOR, 
		COALESCE(H.PURCHASE_ORDER, ' ') AS PURCHASE_ORDER, 
		H.BEGIN_DAY, 
		H.NEED_DAY, 
		H.SHIP_TO_DAY, 
		H.RELEASE_DATETIME, 
		H.RELEASE_APPROVED_DATETIME, 
		COALESCE(H.HDR_GROUP_RID, 1) AS HDR_GROUP_RID, 
		COALESCE(H.SIZE_GROUP_RID, 1) AS SIZE_GROUP_RID, 
		COALESCE(H.WORKFLOW_RID, 1) AS WORKFLOW_RID, 
		COALESCE(H.METHOD_RID, 1) AS METHOD_RID, 
		COALESCE(H.ALLOCATION_STATUS_FLAGS, 0) AS ALLOCATION_STATUS_FLAGS, 
		COALESCE(H.BALANCE_STATUS_FLAGS, 0) AS BALANCE_STATUS_FLAGS, 
		COALESCE(H.SHIPPING_STATUS_FLAGS, 0) AS SHIPPING_STATUS_FLAGS, 
		COALESCE(H.ALLOCATION_TYPE_FLAGS, 0) AS ALLOCATION_TYPE_FLAGS, 
		COALESCE(H.INTRANSIT_STATUS_FLAGS,0) AS INTRANSIT_STATUS_FLAGS, 
		H.PERCENT_NEED_LIMIT, 
		COALESCE(H.PLAN_PERCENT_FACTOR, 100.0) AS PLAN_PERCENT_FACTOR, 
		COALESCE(H.RESERVE_UNITS, 0) AS RESERVE_UNITS, 
		H.GRADE_WEEK_COUNT, 
		COALESCE(H.DIST_CENTER, ' ') AS DIST_CENTER, 
		COALESCE(H.HEADER_NOTES, ' ') AS HEADER_NOTES, 
		COALESCE(H.WORKFLOW_TRIGGER, '0') AS WORKFLOW_TRIGGER, 
		H.EARLIEST_SHIP_DAY, 
		COALESCE(H.API_WORKFLOW_RID, 1) AS API_WORKFLOW_RID, 
		COALESCE(H.API_WORKFLOW_TRIGGER, '0') AS API_WORKFLOW_TRIGGER, 
		COALESCE(H.ALLOCATED_UNITS, 0) AS ALLOCATED_UNITS, 
		COALESCE(H.ORIG_ALLOCATED_UNITS, 0) AS ORIG_ALLOCATED_UNITS, 
		COALESCE(H.RELEASE_COUNT, 0) AS RELEASE_COUNT, 
		COALESCE(H.RSV_ALLOCATED_UNITS, 0) AS RSV_ALLOCATED_UNITS, 
		COALESCE(H.ASRT_RID, -1) AS ASRT_RID, 
		COALESCE(H.PLACEHOLDER_RID, -1) AS PLACEHOLDER_RID, 
		COALESCE(H.ASRT_TYPE, 0) AS ASRT_TYPE, 
		COALESCE(H.MANUALLYCHGDSTRSTYLALOCTNCNT, 0) AS MANUALLYCHGDSTRSTYLALOCTNCNT, 
		COALESCE(H.MANUALLYCHGDSTRSIZEALOCTNCNT, 0) AS MANUALLYCHGDSTRSIZEALOCTNCNT, 
		COALESCE(H.MANUALLYCHGDSTRSTYLEALOCTN,0) AS MANUALLYCHGDSTRSTYLEALOCTN, 
		COALESCE(H.MANUALLYCHGDSTRSIZEALOCTN,0) AS MANUALLYCHGDSTRSIZEALOCTN, 
		COALESCE(H.HORIZON_OVERRIDE, '0') AS HORIZON_OVERRIDE, 
		COALESCE(H.STORES_WITH_ALOCTN_COUNT, 0) AS STORES_WITH_ALOCTN_COUNT, 
		COALESCE(H.GRADE_SG_RID, 1) AS GRADE_SG_RID, 
		COALESCE(H.ASRT_PLACEHOLDER_SEQ, 0) AS ASRT_PLACEHOLDER_SEQ, 
		COALESCE(H.ASRT_HEADER_SEQ, 0) AS ASRT_HEADER_SEQ, 
		H.DISPLAY_STATUS, 
		H.DISPLAY_TYPE, 
		H.DISPLAY_INTRANSIT, 
		H.DISPLAY_SHIP_STATUS, 
		COALESCE(H.GRADE_INVENTORY_IND, '0') AS GRADE_INVENTORY_IND, 
		COALESCE(H.GRADE_INVENTORY_HNRID, -1) AS GRADE_INVENTORY_HNRID, 
		COALESCE(H.IMO_ID, ' ') AS IMO_ID, 
		COALESCE(H.ITEM_UNITS_ALLOCATED, 0) AS ITEM_UNITS_ALLOCATED, 
		COALESCE(H.ITEM_ORIG_UNITS_ALLOCATED, 0) AS ITEM_ORIG_UNITS_ALLOCATED, 
		COALESCE(H2.HDR_ID, ' ') AS ASRT_ID, --using the parent header as the ID
		COALESCE(H2.ASRT_TYPE, 0) AS ASRT_TYPE_PARENT,
		COALESCE(H.UNITS_PER_CARTON, 0) AS UNITS_PER_CARTON,	/* TT#1652-MD - stodd - DC Carton Rounding */
		COALESCE(H.DC_FULFILLMENT_PROCESSED_IND, '0') AS DC_FULFILLMENT_PROCESSED_IND,   /* TT#1966-MD - JSmith- DC Fulfillment  */
		/* Begin TT#1966-MD - JSmith- DC Fulfillment  */
		COALESCE(M.HDR_RID, '-1') AS MASTER_RID, 
		M.HDR_ID AS MASTER_ID,  
		/*End  TT#1966-MD - JSmith- DC Fulfillment  */
		(SELECT COUNT(*)  FROM HEADER_PACK hp WITH (NOLOCK) WHERE hp.HDR_RID = H.HDR_RID) AS PackCount,
		(SELECT COUNT(*)  FROM HEADER_BULK_COLOR hc WITH (NOLOCK) WHERE hc.HDR_RID = H.HDR_RID) AS ColorCount,
		(SELECT COUNT(DISTINCT SIZE_CODE_RID) FROM HEADER_BULK_COLOR_SIZE hs WITH (NOLOCK) WHERE hs.HDR_RID = H.HDR_RID AND UNITS > 0) as SizeCount,
		(SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (H.PLAN_HNRID)) AS NodeDisplayOtsForecast,
		(SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (H.ON_HAND_HNRID)) AS NodeDisplayForOnHand,
		(SELECT [dbo].[UDF_MID_GET_NODE_DISPLAY] (H.GRADE_INVENTORY_HNRID)) AS NodeDisplayForGradeInvBasis,
		(CASE WHEN H.WORKFLOW_RID > 1 THEN
		  (SELECT WORKFLOW_NAME FROM WORKFLOW w WITH (NOLOCK) WHERE w.WORKFLOW_RID=H.WORKFLOW_RID)
		  ELSE
		  ''
		  END
		 ) AS WorkflowName,
		 (CASE  WHEN H.METHOD_RID > 1 THEN
		  (SELECT METHOD_NAME FROM METHOD m WITH (NOLOCK) WHERE m.METHOD_RID=H.METHOD_RID)
		  ELSE
		  ''
		  END
		 ) AS HeaderMethodName,
		(SELECT WORKFLOW_NAME FROM WORKFLOW w WITH (NOLOCK) WHERE w.WORKFLOW_RID=H.API_WORKFLOW_RID) AS APIWorkflowName


	FROM HEADER H WITH (NOLOCK)
	LEFT OUTER JOIN [dbo].[HEADER] H2 WITH (NOLOCK) ON H2.HDR_RID = H.ASRT_RID
	LEFT OUTER JOIN [dbo].[MASTER_HEADER] MH WITH (NOLOCK) ON MH.SUBORD_HDR_RID = H.HDR_RID
	LEFT OUTER JOIN [dbo].[HEADER] M WITH (NOLOCK) ON M.HDR_RID = MH.MASTER_HDR_RID
	WHERE H.HDR_RID IN (SELECT HDR_RID FROM @HDR_RID_LIST)
)
GO


