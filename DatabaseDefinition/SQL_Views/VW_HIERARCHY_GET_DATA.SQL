CREATE VIEW [dbo].[VW_HIERARCHY_GET_DATA]
AS

SELECT
	hn.HN_RID, 
	COALESCE (hn.HN_TYPE, 800200) AS LEVEL_TYPE, 
	COALESCE (hn.HOME_PH_RID, -1) AS HOME_PH_RID, 
	COALESCE (hn.HOME_LEVEL, -1) AS HOME_LEVEL, 
	COALESCE (hn.OTS_PLANLEVEL_TYPE, 800600) AS OTS_PLANLEVEL_TYPE, 
	COALESCE (hn.OTS_FORECAST_LEVEL_SELECT_TYPE, 0) AS OTS_FORECAST_LEVEL_SELECT_TYPE, 
	COALESCE (hn.OTS_FORECAST_LEVEL_TYPE, 0) AS OTS_FORECAST_LEVEL_TYPE, 
    COALESCE (hn.OTS_FORECAST_LEVEL_PH_RID, -1) AS OTS_FORECAST_LEVEL_PH_RID, 
	COALESCE (hn.OTS_FORECAST_LEVEL_PHL_SEQUENCE, -1) AS OTS_FORECAST_LEVEL_PHL_SEQUENCE, 
	COALESCE (hn.OTS_FORECAST_LEVEL_ANCHOR_NODE, -1) AS OTS_FORECAST_LEVEL_ANCHOR_NODE, 
    COALESCE (hn.OTS_FORECAST_LEVEL_MASK_FIELD, 0) AS OTS_FORECAST_LEVEL_MASK_FIELD, 
	hn.OTS_FORECAST_LEVEL_MASK, 
    COALESCE (hn.STOCK_MIN_MAX_SG_RID, -1) AS STOCK_MIN_MAX_SG_RID, 
	COALESCE (hn.USE_BASIC_REPLENISHMENT, '0') AS USE_BASIC_REPLENISHMENT, 
    COALESCE (hn.VIRTUAL_IND, '0') AS VIRTUAL_IND, 
	COALESCE (hn.NODE_DELETE_IND, '0') AS NODE_DELETE_IND,
	COALESCE (hn.PURPOSE, '0') AS PURPOSE, 
	COALESCE (hn.ACTIVE_IND, '1') AS ACTIVE_IND, 
    COALESCE (pc.PURGE_DAILY_HISTORY, -1) AS PURGE_DAILY_HISTORY, 
	COALESCE (pc.PURGE_WEEKLY_HISTORY, -1) AS PURGE_WEEKLY_HISTORY, 
    COALESCE (pc.PURGE_PLANS, -1) AS PURGE_PLANS, 
	COALESCE (hnp.APPLY_HN_RID_FROM, -1) AS APPLY_HN_RID_FROM, 
    COALESCE (HeaderPurge.PURGE_HEADERS_WEEKS_RECEIPT, -1) AS PURGE_HEADERS_WEEKS_RECEIPT, 
    COALESCE (HeaderPurge.PURGE_HEADERS_WEEKS_ASN, -1) AS PURGE_HEADERS_WEEKS_ASN, 
	COALESCE (HeaderPurge.PURGE_HEADERS_WEEKS_DUMMY,-1) AS PURGE_HEADERS_WEEKS_DUMMY, 
	COALESCE (HeaderPurge.PURGE_HEADERS_WEEKS_DROPSHIP, -1) AS PURGE_HEADERS_WEEKS_DROPSHIP, 
    COALESCE (HeaderPurge.PURGE_HEADERS_WEEKS_RESERVE, -1) AS PURGE_HEADERS_WEEKS_RESERVE, 
    COALESCE (HeaderPurge.PURGE_HEADERS_WEEKS_WORKUPTOTALBUY, -1) AS PURGE_HEADERS_WEEKS_WORKUPTOTALBUY, 
    COALESCE (HeaderPurge.PURGE_HEADERS_WEEKS_PO, -1) AS PURGE_HEADERS_WEEKS_PO, 
	COALESCE (HeaderPurge.PURGE_HEADERS_WEEKS_VSW, -1) AS PURGE_HEADERS_WEEKS_VSW
FROM dbo.HIERARCHY_NODE AS hn with (nolock) 
LEFT OUTER JOIN dbo.PURGE_CRITERIA AS pc with (nolock) ON hn.HN_RID = pc.HN_RID 
LEFT OUTER JOIN dbo.HIER_NODE_PROPERTIES AS hnp with (nolock) ON hnp.HN_RID = hn.HN_RID 
LEFT OUTER JOIN
	(SELECT        
	HN_RID, 
	MAX(CASE WHEN HEADER_TYPE = 800730 THEN PURGE_HEADERS END) AS PURGE_HEADERS_WEEKS_RECEIPT, 
	MAX(CASE WHEN HEADER_TYPE = 800731 THEN PURGE_HEADERS END) AS PURGE_HEADERS_WEEKS_ASN, 
	MAX(CASE WHEN HEADER_TYPE = 800732 THEN PURGE_HEADERS END) AS PURGE_HEADERS_WEEKS_DUMMY, 
	MAX(CASE WHEN HEADER_TYPE = 800733 THEN PURGE_HEADERS END) AS PURGE_HEADERS_WEEKS_DROPSHIP, 
	MAX(CASE WHEN HEADER_TYPE = 800735 THEN PURGE_HEADERS END) AS PURGE_HEADERS_WEEKS_RESERVE, 
	MAX(CASE WHEN HEADER_TYPE = 800737 THEN PURGE_HEADERS END) AS PURGE_HEADERS_WEEKS_WORKUPTOTALBUY, 
	MAX(CASE WHEN HEADER_TYPE = 800738 THEN PURGE_HEADERS END) AS PURGE_HEADERS_WEEKS_PO, 
	MAX(CASE WHEN HEADER_TYPE = 800741 THEN PURGE_HEADERS END) AS PURGE_HEADERS_WEEKS_VSW
	FROM dbo.PURGE_CRITERIA_HEADER_PURGE with (nolock) 
	GROUP BY HN_RID) AS HeaderPurge ON HeaderPurge.HN_RID = hn.HN_RID

GO
