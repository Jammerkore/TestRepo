CREATE PROCEDURE [dbo].[SP_MID_CHN_HIS_WK_WRITE]
 
@dt MID_CHN_HIS_WK_TYPE READONLY
AS
SET NOCOUNT ON
MERGE INTO CHAIN_HISTORY_WEEK with (ROWLOCK) AS TARGET
USING @dt AS SOURCE
on (SOURCE.HN_RID = TARGET.HN_RID and SOURCE.TIME_ID = TARGET.TIME_ID)
WHEN MATCHED THEN
UPDATE 
         SET TARGET.SALES = COALESCE(SOURCE.SALES, TARGET.SALES),
             TARGET.SALES_REG = COALESCE(SOURCE.SALES_REG, TARGET.SALES_REG),
             TARGET.SALES_PROMO = COALESCE(SOURCE.SALES_PROMO, TARGET.SALES_PROMO),
             TARGET.SALES_MKDN = COALESCE(SOURCE.SALES_MKDN, TARGET.SALES_MKDN),
             TARGET.STOCK = COALESCE(SOURCE.STOCK, TARGET.STOCK),
             TARGET.STOCK_REG = COALESCE(SOURCE.STOCK_REG, TARGET.STOCK_REG),
             TARGET.STOCK_MKDN = COALESCE(SOURCE.STOCK_MKDN, TARGET.STOCK_MKDN),
             TARGET.WOS = COALESCE(SOURCE.WOS, TARGET.WOS),
             TARGET.WOS_REGPROMO = COALESCE(SOURCE.WOS_REGPROMO, TARGET.WOS_REGPROMO)
WHEN NOT MATCHED BY TARGET THEN
INSERT (HN_RID, TIME_ID, SALES, SALES_REG, SALES_PROMO, SALES_MKDN, STOCK, STOCK_REG, STOCK_MKDN, WOS, WOS_REGPROMO)
VALUES ( SOURCE.HN_RID, SOURCE.TIME_ID, SOURCE.SALES, SOURCE.SALES_REG, SOURCE.SALES_PROMO, SOURCE.SALES_MKDN, SOURCE.STOCK,
      SOURCE.STOCK_REG, SOURCE.STOCK_MKDN, SOURCE.WOS, SOURCE.WOS_REGPROMO);


GO


