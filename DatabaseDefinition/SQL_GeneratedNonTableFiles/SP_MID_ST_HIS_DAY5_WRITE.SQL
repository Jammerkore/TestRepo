CREATE PROCEDURE [dbo].[SP_MID_ST_HIS_DAY5_WRITE]
 
@dt MID_ST_HIS_DAY_TYPE READONLY
AS
SET NOCOUNT ON
MERGE INTO STORE_HISTORY_DAY5 with (ROWLOCK) AS TARGET
USING @dt AS SOURCE
on (SOURCE.HN_MOD = TARGET.HN_MOD and SOURCE.HN_RID = TARGET.HN_RID and SOURCE.TIME_ID = TARGET.TIME_ID and SOURCE.ST_RID = TARGET.ST_RID)
WHEN MATCHED THEN
UPDATE 
         SET TARGET.SALES = COALESCE(SOURCE.SALES, TARGET.SALES),
             TARGET.SALES_REG = COALESCE(SOURCE.SALES_REG, TARGET.SALES_REG),
             TARGET.SALES_PROMO = COALESCE(SOURCE.SALES_PROMO, TARGET.SALES_PROMO),
             TARGET.SALES_MKDN = COALESCE(SOURCE.SALES_MKDN, TARGET.SALES_MKDN),
             TARGET.STOCK = COALESCE(SOURCE.STOCK, TARGET.STOCK),
             TARGET.STOCK_REG = COALESCE(SOURCE.STOCK_REG, TARGET.STOCK_REG),
             TARGET.STOCK_MKDN = COALESCE(SOURCE.STOCK_MKDN, TARGET.STOCK_MKDN),
             TARGET.IN_STOCK_SALES = COALESCE(SOURCE.IN_STOCK_SALES, TARGET.IN_STOCK_SALES),
             TARGET.IN_STOCK_SALES_REG = COALESCE(SOURCE.IN_STOCK_SALES_REG, TARGET.IN_STOCK_SALES_REG),
             TARGET.IN_STOCK_SALES_PROMO = COALESCE(SOURCE.IN_STOCK_SALES_PROMO, TARGET.IN_STOCK_SALES_PROMO),
             TARGET.IN_STOCK_SALES_MKDN = COALESCE(SOURCE.IN_STOCK_SALES_MKDN, TARGET.IN_STOCK_SALES_MKDN),
             TARGET.ACCUM_SELL_THRU_SALES = COALESCE(SOURCE.ACCUM_SELL_THRU_SALES, TARGET.ACCUM_SELL_THRU_SALES),
             TARGET.ACCUM_SELL_THRU_STOCK = COALESCE(SOURCE.ACCUM_SELL_THRU_STOCK, TARGET.ACCUM_SELL_THRU_STOCK),
             TARGET.DAYS_IN_STOCK = COALESCE(SOURCE.DAYS_IN_STOCK, TARGET.DAYS_IN_STOCK),
             TARGET.RECEIVED_STOCK = COALESCE(SOURCE.RECEIVED_STOCK, TARGET.RECEIVED_STOCK)
WHEN NOT MATCHED BY TARGET THEN
INSERT (HN_MOD, HN_RID, TIME_ID, ST_RID, SALES, SALES_REG, SALES_PROMO, SALES_MKDN, STOCK, STOCK_REG, STOCK_MKDN, IN_STOCK_SALES, IN_STOCK_SALES_REG, IN_STOCK_SALES_PROMO, 
     IN_STOCK_SALES_MKDN, ACCUM_SELL_THRU_SALES, ACCUM_SELL_THRU_STOCK, DAYS_IN_STOCK, RECEIVED_STOCK)
VALUES ( SOURCE.HN_MOD, SOURCE.HN_RID, SOURCE.TIME_ID, SOURCE.ST_RID,  SOURCE.SALES, SOURCE.SALES_REG, SOURCE.SALES_PROMO,
      SOURCE.SALES_MKDN, SOURCE.STOCK, SOURCE.STOCK_REG, SOURCE.STOCK_MKDN, SOURCE.IN_STOCK_SALES, SOURCE.IN_STOCK_SALES_REG,
      SOURCE.IN_STOCK_SALES_PROMO, SOURCE.IN_STOCK_SALES_MKDN, SOURCE.ACCUM_SELL_THRU_SALES, SOURCE.ACCUM_SELL_THRU_STOCK,
      SOURCE.DAYS_IN_STOCK, SOURCE.RECEIVED_STOCK);


GO


