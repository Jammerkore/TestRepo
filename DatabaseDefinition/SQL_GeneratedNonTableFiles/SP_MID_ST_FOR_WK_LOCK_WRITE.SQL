CREATE PROCEDURE [dbo].[SP_MID_ST_FOR_WK_LOCK_WRITE]
 
@dtLock MID_ST_FOR_WK_LOCK_TYPE READONLY
AS
SET NOCOUNT ON
MERGE INTO STORE_FORECAST_WEEK_LOCK with (ROWLOCK) AS TARGET
USING @dtLock AS SOURCE
on (SOURCE.HN_RID = TARGET.HN_RID and SOURCE.FV_RID = TARGET.FV_RID and SOURCE.TIME_ID = TARGET.TIME_ID and SOURCE.ST_RID = TARGET.ST_RID)
WHEN MATCHED THEN
UPDATE 
         SET TARGET.SALES_LOCK = COALESCE(SOURCE.SALES_LOCK, TARGET.SALES_LOCK),
             TARGET.SALES_REG_LOCK = COALESCE(SOURCE.SALES_REG_LOCK, TARGET.SALES_REG_LOCK),
             TARGET.SALES_PROMO_LOCK = COALESCE(SOURCE.SALES_PROMO_LOCK, TARGET.SALES_PROMO_LOCK),
             TARGET.SALES_MKDN_LOCK = COALESCE(SOURCE.SALES_MKDN_LOCK, TARGET.SALES_MKDN_LOCK),
             TARGET.STOCK_LOCK = COALESCE(SOURCE.STOCK_LOCK, TARGET.STOCK_LOCK),
             TARGET.STOCK_REG_LOCK = COALESCE(SOURCE.STOCK_REG_LOCK, TARGET.STOCK_REG_LOCK),
             TARGET.STOCK_MKDN_LOCK = COALESCE(SOURCE.STOCK_MKDN_LOCK, TARGET.STOCK_MKDN_LOCK),
             TARGET.IN_STOCK_SALES_LOCK = COALESCE(SOURCE.IN_STOCK_SALES_LOCK, TARGET.IN_STOCK_SALES_LOCK),
             TARGET.IN_STOCK_SALES_REG_LOCK = COALESCE(SOURCE.IN_STOCK_SALES_REG_LOCK, TARGET.IN_STOCK_SALES_REG_LOCK),
             TARGET.IN_STOCK_SALES_PROMO_LOCK = COALESCE(SOURCE.IN_STOCK_SALES_PROMO_LOCK, TARGET.IN_STOCK_SALES_PROMO_LOCK),
             TARGET.IN_STOCK_SALES_MKDN_LOCK = COALESCE(SOURCE.IN_STOCK_SALES_MKDN_LOCK, TARGET.IN_STOCK_SALES_MKDN_LOCK),
             TARGET.ACCUM_SELL_THRU_SALES_LOCK = COALESCE(SOURCE.ACCUM_SELL_THRU_SALES_LOCK, TARGET.ACCUM_SELL_THRU_SALES_LOCK),
             TARGET.ACCUM_SELL_THRU_STOCK_LOCK = COALESCE(SOURCE.ACCUM_SELL_THRU_STOCK_LOCK, TARGET.ACCUM_SELL_THRU_STOCK_LOCK),
             TARGET.DAYS_IN_STOCK_LOCK = COALESCE(SOURCE.DAYS_IN_STOCK_LOCK, TARGET.DAYS_IN_STOCK_LOCK),
             TARGET.RECEIVED_STOCK_LOCK = COALESCE(SOURCE.RECEIVED_STOCK_LOCK, TARGET.RECEIVED_STOCK_LOCK)
WHEN NOT MATCHED BY TARGET THEN
INSERT (HN_RID, FV_RID, TIME_ID, ST_RID, SALES_LOCK, SALES_REG_LOCK, SALES_PROMO_LOCK, SALES_MKDN_LOCK, STOCK_LOCK, STOCK_REG_LOCK, STOCK_MKDN_LOCK, IN_STOCK_SALES_LOCK, 
     IN_STOCK_SALES_REG_LOCK, IN_STOCK_SALES_PROMO_LOCK, IN_STOCK_SALES_MKDN_LOCK, ACCUM_SELL_THRU_SALES_LOCK, ACCUM_SELL_THRU_STOCK_LOCK, DAYS_IN_STOCK_LOCK, 
     RECEIVED_STOCK_LOCK)
VALUES ( SOURCE.HN_RID, SOURCE.FV_RID, SOURCE.TIME_ID, SOURCE.ST_RID, SOURCE.SALES_LOCK, SOURCE.SALES_REG_LOCK,
      SOURCE.SALES_PROMO_LOCK, SOURCE.SALES_MKDN_LOCK, SOURCE.STOCK_LOCK, SOURCE.STOCK_REG_LOCK, SOURCE.STOCK_MKDN_LOCK,
      SOURCE.IN_STOCK_SALES_LOCK, SOURCE.IN_STOCK_SALES_REG_LOCK, SOURCE.IN_STOCK_SALES_PROMO_LOCK, SOURCE.IN_STOCK_SALES_MKDN_LOCK,
      SOURCE.ACCUM_SELL_THRU_SALES_LOCK, SOURCE.ACCUM_SELL_THRU_STOCK_LOCK, SOURCE.DAYS_IN_STOCK_LOCK, SOURCE.RECEIVED_STOCK_LOCK
     );


GO


